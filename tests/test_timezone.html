<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timezone Test - Money Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ• æ—¶åŒºæµ‹è¯•é¡µé¢</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æ—¶åŒºä¿®å¤åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

        <div class="test-section">
            <h2>1. å½“å‰æ—¶åŒºä¿¡æ¯</h2>
            <div id="timezone-info" class="test-result info"></div>
        </div>

        <div class="test-section">
            <h2>2. æ—¶é—´è½¬æ¢æµ‹è¯•</h2>
            <div>
                <label>è¾“å…¥æœ¬åœ°æ—¶é—´:</label>
                <input type="datetime-local" id="localTime" value="">
                <button onclick="testTimeConversion()">æµ‹è¯•è½¬æ¢</button>
            </div>
            <div id="conversion-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>3. æ•°æ®åº“å­—æ®µæµ‹è¯•</h2>
            <div>
                <button onclick="testDatabaseFields()">æµ‹è¯•æ•°æ®åº“å­—æ®µ</button>
            </div>
            <div id="database-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>4. å®é™…äº¤æ˜“æµ‹è¯•</h2>
            <div>
                <button onclick="createTestTransaction()">åˆ›å»ºæµ‹è¯•äº¤æ˜“</button>
                <button onclick="loadRecentTransactions()">åŠ è½½æœ€è¿‘äº¤æ˜“</button>
            </div>
            <div id="transaction-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>5. æ–°çš„æ—¶åŒºå¤„ç†é€»è¾‘æµ‹è¯•</h2>
            <div>
                <button onclick="testNewTimezoneLogic()">æµ‹è¯•æ–°çš„æ—¶åŒºå¤„ç†é€»è¾‘</button>
            </div>
            <div id="timezone-test-result" class="test-result"></div>
        </div>
    </div>

    <script src="assets/js/supabase.js"></script>
    <script src="assets/js/config.js"></script>
    <script>
        // åˆå§‹åŒ–æ—¶åŒºä¿¡æ¯
        function initTimezoneInfo() {
            const now = new Date();
            const timezoneInfo = document.getElementById('timezone-info');
            
            timezoneInfo.innerHTML = `
                <strong>å½“å‰æ—¶é—´:</strong> ${now.toString()}<br>
                <strong>æ—¶åŒºåç§»:</strong> ${now.getTimezoneOffset()} åˆ†é’Ÿ<br>
                <strong>æ—¶åŒºåç§°:</strong> ${Intl.DateTimeFormat().resolvedOptions().timeZone}<br>
                <strong>ISOå­—ç¬¦ä¸²:</strong> ${now.toISOString()}<br>
                <strong>æœ¬åœ°å­—ç¬¦ä¸²:</strong> ${now.toLocaleString()}
            `;
        }

        // æµ‹è¯•æ—¶é—´è½¬æ¢
        function testTimeConversion() {
            const localTimeInput = document.getElementById('localTime');
            const resultDiv = document.getElementById('conversion-result');
            
            if (!localTimeInput.value) {
                resultDiv.innerHTML = '<div class="error">è¯·å…ˆè¾“å…¥æœ¬åœ°æ—¶é—´</div>';
                return;
            }

            const localDateTime = new Date(localTimeInput.value);
            const isoString = localDateTime.toISOString();
            
            resultDiv.innerHTML = `
                <div class="info">
                    <strong>è¾“å…¥æ—¶é—´:</strong> ${localTimeInput.value}<br>
                    <strong>æœ¬åœ°æ—¶é—´å¯¹è±¡:</strong> ${localDateTime.toString()}<br>
                    <strong>ISOå­—ç¬¦ä¸²:</strong> ${isoString}<br>
                    <strong>UTCæ—¶é—´:</strong> ${new Date(isoString).toUTCString()}<br>
                    <strong>è½¬æ¢å›æœ¬åœ°:</strong> ${new Date(isoString).toLocaleString()}
                </div>
            `;
        }

        // æµ‹è¯•æ•°æ®åº“å­—æ®µ
        async function testDatabaseFields() {
            const resultDiv = document.getElementById('database-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥æ•°æ®åº“å­—æ®µ...</div>';

            try {
                // æ£€æŸ¥transactionsè¡¨æ˜¯å¦æœ‰transaction_date_localå­—æ®µ
                const { data, error } = await supabase
                    .from('transactions')
                    .select('transaction_date, transaction_date_local')
                    .limit(1);

                if (error) {
                    resultDiv.innerHTML = `<div class="error">æ•°æ®åº“é”™è¯¯: ${error.message}</div>`;
                    return;
                }

                if (data && data.length > 0) {
                    const transaction = data[0];
                    const hasLocalField = 'transaction_date_local' in transaction;
                    
                    resultDiv.innerHTML = `
                        <div class="${hasLocalField ? 'success' : 'error'}">
                            <strong>transaction_date_localå­—æ®µ:</strong> ${hasLocalField ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>
                            <strong>ç¤ºä¾‹æ•°æ®:</strong><br>
                            - transaction_date: ${transaction.transaction_date || 'N/A'}<br>
                            - transaction_date_local: ${transaction.transaction_date_local || 'N/A'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="info">æ²¡æœ‰æ‰¾åˆ°äº¤æ˜“æ•°æ®</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºæµ‹è¯•äº¤æ˜“
        async function createTestTransaction() {
            const resultDiv = document.getElementById('transaction-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨åˆ›å»ºæµ‹è¯•äº¤æ˜“...</div>';

            try {
                const now = new Date();
                const isoDateTime = now.toISOString();
                
                // åˆ›å»ºä¸å¸¦æ—¶åŒºçš„æœ¬åœ°æ—¶é—´æ ¼å¼
                const localYear = now.getFullYear();
                const localMonth = String(now.getMonth() + 1).padStart(2, '0');
                const localDay = String(now.getDate()).padStart(2, '0');
                const localHours = String(now.getHours()).padStart(2, '0');
                const localMinutes = String(now.getMinutes()).padStart(2, '0');
                const localSeconds = String(now.getSeconds()).padStart(2, '0');
                const localDateTime = `${localYear}-${localMonth}-${localDay} ${localHours}:${localMinutes}:${localSeconds}`;
                
                const testTransaction = {
                    ledger_id: 1,
                    ledger_name: 'Daily',
                    transaction_date: isoDateTime,
                    transaction_date_local: window.timezoneManager.getLocalTimeString(isoDateTime), // ä½¿ç”¨æ—¶åŒºç®¡ç†å™¨ç”Ÿæˆæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
                    type: 'expense',
                    amount: '0.01',
                    currency: 'SGD',
                    category_id: '337704b9-9005-4531-a0b9-7dbfc2fb06e0',
                    notes: 'æ—¶åŒºæµ‹è¯•äº¤æ˜“ - ' + now.toLocaleString(),
                    payer_id: '77aeca19-6acd-489e-9542-e4a9a9c83c6a',
                    payer_name: 'Wenjia',
                    needs_reimbursement: false,
                    sgd_rate: 1.0,
                    sgd_amount: 0.01,
                    cny_rate: 5.59,
                    cny_amount: 0.06,
                    usd_rate: 0.78,
                    usd_amount: 0.01,
                    myr_rate: 3.29,
                    myr_amount: 0.03,
                    reimbursement_status: 'not_needed',
                    creator_id: '77aeca19-6acd-489e-9542-e4a9a9c83c6a',
                    creator_name: 'Wenjia',
                    creator_email: 'wangwenjiaagnes@gmail.com',
                    created_at: new Date().toISOString() // æ·»åŠ åˆ›å»ºæ—¶é—´
                };

                const { data, error } = await supabase
                    .from('transactions')
                    .insert([testTransaction]);

                if (error) {
                    resultDiv.innerHTML = `<div class="error">åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
                    return;
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>æµ‹è¯•äº¤æ˜“åˆ›å»ºæˆåŠŸ!</strong><br>
                        <strong>äº¤æ˜“ID:</strong> ${data[0].id}<br>
                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${now.toLocaleString()}<br>
                        <strong>transaction_date:</strong> ${testTransaction.transaction_date}<br>
                        <strong>transaction_date_local:</strong> ${testTransaction.transaction_date_local}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æœ€è¿‘äº¤æ˜“
        async function loadRecentTransactions() {
            const resultDiv = document.getElementById('transaction-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨åŠ è½½æœ€è¿‘äº¤æ˜“...</div>';

            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('id, transaction_date, transaction_date_local, notes, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    resultDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    return;
                }

                if (data && data.length > 0) {
                    let html = '<div class="success"><strong>æœ€è¿‘5ç¬”äº¤æ˜“:</strong><br>';
                    data.forEach((transaction, index) => {
                        let localDate, utcDate;
                        
                        // ä½¿ç”¨æ—¶åŒºç®¡ç†å™¨è½¬æ¢UTCæ—¶é—´ä¸ºæœ¬åœ°æ—¶é—´æ˜¾ç¤º
                        if (transaction.transaction_date) {
                            utcDate = new Date(transaction.transaction_date).toLocaleString();
                            localDate = window.timezoneManager.convertToLocalTime(transaction.transaction_date);
                        } else {
                            utcDate = 'N/A';
                            localDate = 'N/A';
                        }
                        
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <strong>äº¤æ˜“ ${index + 1}:</strong> ${transaction.notes}<br>
                                <strong>transaction_date (UTC):</strong> ${utcDate}<br>
                                <strong>transaction_date_local:</strong> ${localDate}<br>
                                <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(transaction.created_at).toLocaleString()}
                            </div>
                        `;
                    });
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="info">æ²¡æœ‰æ‰¾åˆ°äº¤æ˜“æ•°æ®</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•æ–°çš„æ—¶åŒºå¤„ç†é€»è¾‘
        async function testNewTimezoneLogic() {
            const resultDiv = document.getElementById('timezone-test-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æ–°çš„æ—¶åŒºå¤„ç†é€»è¾‘...</div>';

            try {
                // æµ‹è¯•æ•°æ®
                const testCases = [
                    {
                        name: 'ISOæ ¼å¼ï¼ˆå¸¦æ—¶åŒºï¼‰',
                        data: '2025-08-20T13:52:00+00:00',
                        expected: '2025-08-20'
                    },
                    {
                        name: 'æœ¬åœ°æ—¶é—´æ ¼å¼ï¼ˆä¸å¸¦æ—¶åŒºï¼‰',
                        data: '2025-08-20 13:52:00',
                        expected: '2025-08-20'
                    },
                    {
                        name: 'åªæœ‰æ—¥æœŸ',
                        data: '2025-08-20',
                        expected: '2025-08-20'
                    }
                ];

                let html = '<div class="success"><strong>æ—¶åŒºå¤„ç†é€»è¾‘æµ‹è¯•ç»“æœ:</strong><br>';
                
                testCases.forEach((testCase, index) => {
                    let dateOnly;
                    if (testCase.data.includes('T')) {
                        dateOnly = testCase.data.split('T')[0];
                    } else if (testCase.data.includes(' ')) {
                        dateOnly = testCase.data.split(' ')[0];
                    } else {
                        dateOnly = testCase.data;
                    }
                    
                    const passed = dateOnly === testCase.expected;
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: ${passed ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
                            <strong>æµ‹è¯• ${index + 1}:</strong> ${testCase.name}<br>
                            <strong>è¾“å…¥:</strong> ${testCase.data}<br>
                            <strong>è¾“å‡º:</strong> ${dateOnly}<br>
                            <strong>æœŸæœ›:</strong> ${testCase.expected}<br>
                            <strong>ç»“æœ:</strong> ${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                        </div>
                    `;
                });
                
                html += '</div>';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTimezoneInfo();
            
            // è®¾ç½®å½“å‰æ—¶é—´ä¸ºé»˜è®¤å€¼
            const now = new Date();
            const localTimeInput = document.getElementById('localTime');
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            localTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        });
    </script>
</body>
</html>
