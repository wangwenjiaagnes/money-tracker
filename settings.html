<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Settings</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="assets/png/app_icon.png" />
    <link rel="shortcut icon" type="image/png" href="assets/png/app_icon.png" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="assets/png/app_icon.png" />
    <link rel="apple-touch-icon-precomposed" href="assets/png/app_icon.png" />
    
    <!-- Android Web App Manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Money Tracker" />
    
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            min-height: 100vh;
            background-attachment: fixed !important;
            background-repeat: no-repeat !important;
            background-size: cover !important;
        }
        
        /* 确保背景不会被任何元素覆盖 */
        html::before, body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -9999;
            pointer-events: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .brand {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            padding: 10px 16px;
            text-decoration: none;
            color: #667eea;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-link img {
            color: #667eea;
        }



        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .nav-link.active {
            background: rgba(102, 126, 234, 0.15);
            color: #5a67d8;
            cursor: default;
            pointer-events: none;
        }

        .nav-link.active:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: none;
        }

        .transaction-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .transaction-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* 移动端响应式设计 */
        @media (max-width: 768px) {
            .nav-menu {
                gap: 12px !important;
                flex-direction: row !important;
                justify-content: center !important;
            }
            
            .nav-link {
                padding: 8px 12px;
            }
            
            .transaction-btn {
                padding: 8px 12px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .transaction-btn::before {
                content: '';
                width: 20px;
                height: 20px;
                background-image: url('assets/svg/add.svg');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                filter: brightness(0) invert(1);
            }
            
            .transaction-btn span {
                display: none;
            }
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .settings-layout {
            display: flex;
            gap: 32px;
            min-height: 600px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .settings-sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 32px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .settings-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: #666;
        }

        .settings-nav-item:hover {
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .settings-nav-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            transform: translateY(-1px);
        }

        .settings-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 600px;
        }

        .content-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 24px;
        }

        .content-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .add-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.1);
        }

        .add-btn:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .add-btn:active {
            transform: translateY(0);
        }

        .view-archived-btn {
            background: #f8f9fa;
            color: #667eea;
            border: 1px solid #e1e5e9;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .view-archived-btn:hover {
            background: #f0f2ff;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .view-archived-btn:active {
            transform: translateY(0);
        }

        .profile-info {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 32px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .user-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 36px;
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            border: 3px solid white;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .user-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .user-welcome {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .user-subtitle {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .profile-item {
            display: grid;
            grid-template-columns: 120px 1fr 40px;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 16px;
        }

        .profile-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .profile-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            min-width: 120px;
            margin-right: 16px;
        }

        .profile-value {
            font-size: 14px;
            font-weight: normal;
            color: #666;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .copy-btn {
            background: transparent;
            border: none;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            width: 32px;
            height: 32px;
        }

        .copy-btn:hover {
            background: #f1f3f4;
            color: #333;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* 移动端输入框优化 - 防止iOS自动缩放 */
        @media (max-width: 768px) {
            input[type="text"], 
            input[type="email"], 
            input[type="password"], 
            input[type="number"], 
            input[type="tel"], 
            input[type="url"], 
            input[type="search"], 
            textarea, 
            select {
                font-size: 16px !important;
                -webkit-text-size-adjust: 100% !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                transform: scale(1) !important;
                -webkit-transform: scale(1) !important;
                min-height: 44px !important;
            }
            
            .form-input, .form-select {
                font-size: 16px !important;
                min-height: 44px !important;
            }
        }

        /* 移动端响应式样式 */
        @media (max-width: 768px) {
            .profile-header {
                padding: 24px 16px;
                margin-bottom: 24px;
            }

            .user-logo {
                width: 64px;
                height: 64px;
                font-size: 28px;
                margin-bottom: 12px;
            }

            .user-welcome {
                font-size: 16px;
            }

            .user-subtitle {
                font-size: 13px;
            }

            .profile-item {
                grid-template-columns: 90px 1fr 32px;
                gap: 8px;
                padding: 8px 0;
            }
            
            .profile-label {
                min-width: 90px;
                font-size: 16px;
            }
            
            .profile-value {
                font-size: 14px;
            }
            
            .copy-btn {
                width: 28px;
                height: 28px;
                padding: 2px;
            }
            
            .logout-btn {
                padding: 6px 12px;
                font-size: 13px;
                min-width: 70px;
            }

            /* 修复移动端settings导航布局 - 改为一行3个网格布局 */
            .settings-nav {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 8px;
            }
            
            .settings-nav-item {
                padding: 12px 8px;
                font-size: 16px;
                text-align: center;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.8);
                border: 1px solid rgba(102, 126, 234, 0.2);
                transition: all 0.2s ease;
                white-space: nowrap;
            }
            
            .settings-nav-item:hover {
                background: rgba(102, 126, 234, 0.1);
                border-color: rgba(102, 126, 234, 0.3);
            }
            
            .settings-nav-item.active {
                background: rgba(102, 126, 234, 0.15);
                border-color: rgba(102, 126, 234, 0.4);
                color: #5a67d8;
                font-weight: 600;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .profile-item {
                grid-template-columns: 70px 1fr 28px;
                gap: 6px;
            }
            
            .profile-label {
                min-width: 70px;
                font-size: 16px;
            }
            
            .profile-value {
                font-size: 14px;
            }
            
            /* 超小屏幕settings导航优化 - 保持网格布局 */
            .settings-nav {
                gap: 6px;
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .settings-nav-item {
                padding: 10px 6px;
                font-size: 14px;
                text-align: center;
                border-radius: 6px;
                background: rgba(255, 255, 255, 0.8);
                border: 1px solid rgba(102, 126, 234, 0.2);
                white-space: nowrap;
            }
        }

        /* Toast 提示样式 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .ledger-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
            align-items: start;
        }

        .ledger-item {
            background: white;
            border-radius: 20px;
            padding: 12px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 100px;
        }

        .ledger-item:hover {
            background: white;
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ledger-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 6px;
        }

        .ledger-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .icon-btn {
            background: transparent;
            border: none;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .icon-btn:hover {
            background: #f1f3f4;
            color: #333;
        }

        .icon-btn.edit-btn:hover {
            color: #333;
        }

        .icon-btn.delete-btn:hover {
            color: #333;
        }

        .ledger-description {
            font-size: 14px;
            font-weight: normal;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
            flex-grow: 1;
        }

        .ledger-info {
        }

        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
            font-size: 14px;
            line-height: 1.3;
        }

        .info-label {
            font-size: 14px;
            font-weight: normal;
            color: #666;
            margin-right: 8px;
            min-width: 50px;
        }

        .info-value {
            font-size: 14px;
            font-weight: normal;
            color: #666;
        }

        .ledger-tags {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .tag {
            background: #f1f3f4;
            color: #5f6368;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid #e8eaed;
        }

        .ledger-meta {
            font-size: 14px;
            font-weight: normal;
            color: #666;
            margin-bottom: 8px;
            padding: 2px 0;
            background: transparent;
            border-radius: 0;
            border-left: none;
        }

        .settings-section {
            display: none;
        }

        /* Icon Recommendation Styles */
        .icon-recommendation {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }

        .icon-preview {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid #e8eaed;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .icon-preview.has-icon {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn-change-icon {
            background: #f1f3f4;
            color: #5f6368;
            border: 1px solid #e8eaed;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-change-icon:hover {
            background: #e8eaed;
            color: #333;
        }

        /* Icon Selection Modal */
        .icon-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .icon-modal.show {
            display: flex;
        }

        .icon-modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .icon-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .icon-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .icon-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .icon-modal-close:hover {
            background: #f1f3f4;
            color: #333;
        }

        .preview-section {
            margin-bottom: 24px;
            text-align: center;
        }

        .preview-section h4 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .preview-logo {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }

        .preview-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border: 2px solid #e8eaed;
            background: #f8f9fa;
            transition: all 0.3s ease;
            color: white;
        }

        .preview-icon.has-selection {
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .emoji-section {
            margin-bottom: 24px;
        }

        .emoji-section h4 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .emoji-input-section {
            margin-bottom: 16px;
        }

        .emoji-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            transition: border-color 0.3s ease;
            margin-bottom: 8px;
        }

        .emoji-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .emoji-input-hint {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .emoji-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            background: #f8f9fa;
        }

        .emoji-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .emoji-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .color-section h4 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option:hover {
            border-color: #333;
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        .icon-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-confirm {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-confirm:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }



        .settings-section.active {
            display: block;
        }

        /* 表单样式 */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .form-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .form-container {
            background: white;
            border-radius: 20px;
            padding: 36px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .form-overlay.show .form-container {
            transform: scale(1);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .form-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: #f8f9fa;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #e9ecef;
            color: #333;
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* Multi-currency display styles */
        .multi-currency-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .currency-item {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .currency-item:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .currency-label {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .currency-amount {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 2px;
        }

        .currency-rate {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        .currency-item.highlighted {
            border-color: #667eea;
            background: #f0f2ff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        @media (max-width: 768px) {
            .multi-currency-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Multi-currency display in budget list */
        .multi-currency-row {
            margin-top: 8px;
        }

        .multi-currency-display {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .currency-chip {
            background: #f0f2ff;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid #e1e5e9;
        }

        .currency-amount-html {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .multi-currency-display {
                flex-direction: column;
                gap: 4px;
            }
            
            .currency-chip {
                font-size: 10px;
                padding: 3px 6px;
            }
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: normal;
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px; /* 防止iOS自动缩放 */
            font-weight: normal;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s ease;
            background: #fafbfc;
            color: #666;
            /* 防止移动端自动缩放 */
            -webkit-text-size-adjust: 100%;
            -webkit-appearance: none;
            appearance: none;
            transform: scale(1);
            -webkit-transform: scale(1);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            font-weight: normal;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafbfc;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            color: #666;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            font-weight: normal;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
            background: #fafbfc;
            color: #666;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }



        .btn-save {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.1);
        }

        .btn-save:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .btn-save:active {
            transform: translateY(0);
        }



        /* Custom Confirmation Modal Styles */
        .custom-modal {
            position: fixed;
            z-index: 20000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .custom-modal.show {
            display: flex;
        }

        .custom-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .custom-modal-header {
            padding: 24px 24px 16px 24px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .custom-modal-body {
            padding: 20px 24px;
            text-align: center;
        }

        .custom-modal-message {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin: 0;
        }

        .custom-modal-actions {
            padding: 16px 24px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .custom-modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            min-width: 80px;
        }

        .custom-modal-btn-secondary {
            background: transparent;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-secondary:hover {
            background: rgba(102, 126, 234, 0.05);
            color: #667eea;
        }

        .custom-modal-btn-danger {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-danger:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .custom-modal-btn-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #f57c00;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .custom-modal-btn-warning:hover {
            background: rgba(255, 193, 7, 0.15);
            color: #e65100;
        }

        .custom-modal-btn-success {
            background: rgba(76, 175, 80, 0.1);
            color: #388e3c;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .custom-modal-btn-success:hover {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }

        .custom-modal-btn-primary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-primary:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .ledger-list {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 16px;
            }

            .nav-menu {
                flex-direction: row;
                gap: 12px;
                justify-content: center;
            }

            .main-container {
                padding: 16px;
            }
            
            .page-title {
                font-size: 18px;
            }

            .settings-layout {
                flex-direction: column;
                gap: 20px;
            }

            .settings-sidebar {
                width: 100%;
                position: static;
                padding: 24px 20px;
            }

            .settings-content {
                padding: 24px 20px;
            }

            .ledger-list {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .ledger-item {
                padding: 12px;
                min-height: auto;
            }



            .logout-container {
                padding: 32px 24px;
                margin: 20px;
            }

            .logout-actions {
                flex-direction: column;
                gap: 12px;
            }

            .logout-btn-cancel,
            .logout-btn-confirm {
                width: 100%;
                min-width: auto;
            }

            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
                max-height: 150px;
                gap: 6px;
            }

            .emoji-option {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .color-palette {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .color-option {
                width: 36px;
                height: 36px;
            }

            /* 移动端Transaction Actions按钮样式优化 */
            .transaction-actions-modal-buttons .custom-modal-btn {
                box-shadow: none !important;
                text-shadow: none !important;
                -webkit-box-shadow: none !important;
                -webkit-text-shadow: none !important;
                filter: none !important;
                -webkit-filter: none !important;
                border: 1px solid rgba(102, 126, 234, 0.2) !important;
                background: rgba(102, 126, 234, 0.1) !important;
                color: #667eea !important;
                font-weight: 500 !important;
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
            }

            .transaction-actions-modal-buttons .custom-modal-btn:hover {
                background: rgba(102, 126, 234, 0.15) !important;
                color: #667eea !important;
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
            }

            .transaction-actions-modal-buttons .custom-modal-btn:active {
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
                transform: none !important;
            }

            /* 移动端图标渲染优化 - 增强版 */
            .transaction-actions-modal-buttons .custom-modal-btn img {
                /* 图像渲染优化 */
                image-rendering: -webkit-optimize-contrast !important;
                image-rendering: crisp-edges !important;
                image-rendering: pixelated !important;
                -webkit-image-rendering: -webkit-optimize-contrast !important;
                -webkit-image-rendering: crisp-edges !important;
                -webkit-image-rendering: pixelated !important;
                
                /* 移除所有filter */
                filter: none !important;
                -webkit-filter: none !important;
                
                /* 硬件加速和3D变换 */
                transform: translateZ(0) scale(1.001) !important;
                -webkit-transform: translateZ(0) scale(1.001) !important;
                
                /* 背面可见性 */
                backface-visibility: hidden !important;
                -webkit-backface-visibility: hidden !important;
                
                /* 抗锯齿优化 */
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
                
                /* 像素对齐 */
                will-change: transform !important;
                -webkit-will-change: transform !important;
                
                /* 强制GPU渲染 */
                transform-style: preserve-3d !important;
                -webkit-transform-style: preserve-3d !important;
                
                /* 边缘优化 */
                outline: none !important;
                -webkit-outline: none !important;
                
                            /* 确保像素完美对齐 */
            width: 18px !important;
            height: 18px !important;
            flex-shrink: 0 !important;
            
            /* 高分辨率优化 */
            image-resolution: 144dpi !important;
            -webkit-image-resolution: 144dpi !important;
            
            /* 强制高质量渲染 */
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            image-rendering: pixelated !important;
            
            /* 移动端特殊优化 */
            -webkit-transform: translateZ(0) scale(1.002) !important;
            transform: translateZ(0) scale(1.002) !important;
            
            /* 确保锐利边缘 */
            -webkit-backface-visibility: hidden !important;
            backface-visibility: hidden !important;
            -webkit-perspective: 1000px !important;
            perspective: 1000px !important;
            
            /* 移动端高分辨率图标 */
            width: 20px !important;
            height: 20px !important;
            min-width: 20px !important;
            min-height: 20px !important;
            
            /* 强制高质量渲染 */
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            image-rendering: pixelated !important;
            -webkit-image-rendering: -webkit-optimize-contrast !important;
            -webkit-image-rendering: crisp-edges !important;
            -webkit-image-rendering: pixelated !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-container">
            <div class="brand">
                Money Tracker
            </div>
            <div class="nav-menu">
                <a href="home.html" class="nav-link" title="Home">
                    <img src="assets/svg/home.svg?v=2" alt="Home" width="20" height="20">
                </a>
                <a href="analysis.html" class="nav-link" title="Analysis">
                    <img src="assets/svg/analysis.svg?v=2" alt="Analysis" width="20" height="20">
                </a>
                <a href="wallet.html" class="nav-link" title="Wallet">
                    <img src="assets/svg/wallet.svg?v=2" alt="Wallet" width="20" height="20">
                </a>
                <span class="nav-link active" title="Settings">
                    <img src="assets/svg/settings.svg?v=2" alt="Settings" width="20" height="20">
                </span>
                <a href="transaction.html" class="nav-link transaction-btn"><span>+Transaction</span></a>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="settings-layout">
            <div class="settings-sidebar">
                <div class="settings-nav">
                    <div class="settings-nav-item active" data-section="profile">Profile</div>
                    <div class="settings-nav-item" data-section="ledger">Ledger</div>
                    <div class="settings-nav-item" data-section="category">Category</div>
                    <div class="settings-nav-item" data-section="budget">Budget</div>
                    <div class="settings-nav-item" data-section="wallet">Wallet</div>
                    <div class="settings-nav-item" data-section="recurring">Recurring</div>
                </div>
            </div>
            
            <div class="settings-content">
                <!-- Profile Section -->
                <div id="profile-section" class="settings-section active">
                    <div id="profile-info" class="profile-info">
                        <!-- Profile header with logo will be loaded here -->
                        <div id="profile-header" class="profile-header">
                            <!-- User logo and welcome message will be loaded here -->
                        </div>
                        <!-- Profile information will be loaded here -->
                    </div>
                </div>

                <!-- Ledger Management Section -->
                <div id="ledger-section" class="settings-section">
                    <div class="content-header">
                        <button class="add-btn" onclick="showAddLedgerForm()">+Ledger</button>
                    </div>
                    <div id="ledger-list" class="ledger-list">
                        <!-- Ledger items will be loaded here -->
                    </div>
                </div>

                <!-- Category Management Section -->
                <div id="category-section" class="settings-section">
                    <div class="content-header">
                        <button class="add-btn" onclick="showAddCategoryForm()">+Category</button>
                    </div>
                    <div id="category-list" class="ledger-list">
                        <!-- Category items will be loaded here -->
                    </div>
                </div>

                <!-- Budget Management Section -->
                <div id="budget-section" class="settings-section">
                    <div class="content-header">
                        <button class="add-btn" onclick="showAddBudgetForm()">+Budget</button>
                    </div>
                    <div id="budget-list" class="ledger-list">
                        <!-- Budget items will be loaded here -->
                    </div>
                </div>

                <!-- Wallet Management Section -->
                <div id="wallet-section" class="settings-section">
                    <div class="content-header">
                        <button class="view-archived-btn" onclick="toggleWalletView()">View Archived</button>
                        <button class="add-btn" onclick="showAddWalletForm()">+Wallet</button>
                    </div>
                    <div id="wallet-list" class="ledger-list">
                        <!-- Wallet items will be loaded here -->
                    </div>
                </div>

                <!-- Recurring Bills Management Section -->
                <div id="recurring-section" class="settings-section">
                    <div class="content-header">
                        <button class="add-btn" onclick="showAddRecurringForm()">+Recurring</button>
                    </div>
                    <div id="recurring-list" class="ledger-list">
                        <!-- Recurring bill items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ledger Form Overlay -->
    <div id="ledger-form-overlay" class="form-overlay">
        <div class="form-container">
            <div class="form-header">
                <h3 class="form-title" id="ledger-form-title">Add New Ledger</h3>
                <button class="close-btn" onclick="hideLedgerForm()">&times;</button>
            </div>
            <form id="ledger-form">
                <div class="form-group">
                    <label class="form-label" for="ledger-name">Name *</label>
                    <input type="text" id="ledger-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="ledger-description">Description</label>
                    <textarea id="ledger-description" class="form-textarea" placeholder="Optional description"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Form Overlay -->
    <div id="category-form-overlay" class="form-overlay">
        <div class="form-container">
            <div class="form-header">
                <h3 class="form-title" id="category-form-title">Add New Category</h3>
                <button class="close-btn" onclick="hideCategoryForm()">&times;</button>
            </div>
            <form id="category-form">
                <div class="form-group">
                    <label class="form-label" for="category-name">Name *</label>
                    <input type="text" id="category-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="category-ledger">Ledger *</label>
                    <select id="category-ledger" class="form-select" required>
                        <option value="">Select ledger</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="category-type">Type *</label>
                    <select id="category-type" class="form-select" required>
                        <option value="">Select type</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                
                <!-- Icon Recommendation Section -->
                <div class="form-group" id="icon-recommendation-section" style="display: none;">
                    <label class="form-label">Recommended Icon</label>
                    <div class="icon-recommendation">
                        <div class="icon-preview" id="icon-preview">
                            <!-- Icon will be displayed here -->
                        </div>
                        <button type="button" class="btn-change-icon" id="change-icon-btn">Change Icon</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Form Overlay -->
    <div id="budget-form-overlay" class="form-overlay">
        <div class="form-container">
            <div class="form-header">
                <h3 class="form-title" id="budget-form-title">Add New Budget</h3>
                <button class="close-btn" onclick="hideBudgetForm()">&times;</button>
            </div>
            <form id="budget-form">
                <div class="form-group">
                    <label class="form-label" for="budget-ledger">Ledger *</label>
                    <select id="budget-ledger" class="form-select" required>
                        <option value="">Select ledger</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="budget-month">Month *</label>
                    <input type="month" id="budget-month" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="budget-amount">Budget Amount *</label>
                    <input type="number" id="budget-amount" class="form-input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="budget-currency">Currency *</label>
                    <select id="budget-currency" class="form-select" required>
                        <option value="">Select currency</option>
                        <option value="SGD">SGD</option>
                        <option value="CNY">CNY</option>
                        <option value="USD">USD</option>
                        <option value="MYR">MYR</option>
                    </select>
                </div>
                
                <!-- Multi-currency display section -->
                <div class="form-group" id="multi-currency-section">
                    <label class="form-label">Multi-Currency Conversion</label>
                    <div class="multi-currency-grid">
                        <div class="currency-item" id="sgd-display">
                            <div class="currency-label">SGD</div>
                            <div class="currency-amount" id="sgd-amount">S$0.00</div>
                            <div class="currency-rate" id="sgd-rate">Rate: 1.0000</div>
                        </div>
                        <div class="currency-item" id="cny-display">
                            <div class="currency-label">CNY</div>
                            <div class="currency-amount" id="cny-amount">¥0.00</div>
                            <div class="currency-rate" id="cny-rate">Rate: 0.0000</div>
                        </div>
                        <div class="currency-item" id="usd-display">
                            <div class="currency-label">USD</div>
                            <div class="currency-amount" id="usd-amount">$0.00</div>
                            <div class="currency-rate" id="usd-rate">Rate: 0.0000</div>
                        </div>
                        <div class="currency-item" id="myr-display">
                            <div class="currency-label">MYR</div>
                            <div class="currency-amount" id="myr-amount">RM0.00</div>
                            <div class="currency-rate" id="myr-rate">Rate: 0.0000</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="budget-description">Description</label>
                    <textarea id="budget-description" class="form-textarea" placeholder="Optional description"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Wallet Form Overlay -->
    <div id="wallet-form-overlay" class="form-overlay">
        <div class="form-container">
            <div class="form-header">
                <h3 class="form-title" id="wallet-form-title">Add New Wallet</h3>
                <button class="close-btn" onclick="hideWalletForm()">&times;</button>
            </div>
            <form id="wallet-form">
                <div class="form-group">
                    <label class="form-label" for="wallet-name">Wallet Name *</label>
                    <input type="text" id="wallet-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="wallet-type">Wallet Type *</label>
                    <select id="wallet-type" class="form-select" required>
                        <option value="">Select Type</option>
                        <option value="personal">Personal Account</option>
                        <option value="shared">Shared Account</option>
                    </select>
                </div>
                <div class="form-group" id="wallet-owner-group" style="display: none;">
                    <label class="form-label" for="wallet-owner">Account Holder *</label>
                    <select id="wallet-owner" class="form-select">
                        <option value="">Select Owner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="wallet-currency">Currency *</label>
                    <select id="wallet-currency" class="form-select" required>
                        <option value="">Select Currency</option>
                        <option value="SGD">SGD</option>
                        <option value="CNY">CNY</option>
                        <option value="USD">USD</option>
                        <option value="MYR">MYR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="wallet-amount">Amount *</label>
                    <input type="number" id="wallet-amount" class="form-input" step="0.01" required>
                </div>
                
                <!-- Multi-currency display section -->
                <div class="form-group" id="wallet-multi-currency-section">
                    <label class="form-label">Multi-Currency Conversion</label>
                    <div class="multi-currency-grid">
                        <div class="currency-item" id="wallet-sgd-display">
                            <div class="currency-label">SGD</div>
                            <div class="currency-amount" id="wallet-sgd-amount">S$0.00</div>
                            <div class="currency-rate" id="wallet-sgd-rate">Rate: 1.0000</div>
                        </div>
                        <div class="currency-item" id="wallet-cny-display">
                            <div class="currency-label">CNY</div>
                            <div class="currency-amount" id="wallet-cny-amount">¥0.00</div>
                            <div class="currency-rate" id="wallet-cny-rate">Rate: 0.0000</div>
                        </div>
                        <div class="currency-item" id="wallet-usd-display">
                            <div class="currency-label">USD</div>
                            <div class="currency-amount" id="wallet-usd-amount">$0.00</div>
                            <div class="currency-rate" id="wallet-usd-rate">Rate: 0.0000</div>
                        </div>
                        <div class="currency-item" id="wallet-myr-display">
                            <div class="currency-label">MYR</div>
                            <div class="currency-amount" id="wallet-myr-amount">RM0.00</div>
                            <div class="currency-rate" id="wallet-myr-rate">Rate: 0.0000</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="wallet-description">Description</label>
                    <textarea id="wallet-description" class="form-textarea" placeholder="Optional description"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recurring Bill Form Overlay -->
    <div id="recurring-form-overlay" class="form-overlay">
        <div class="form-container">
            <div class="form-header">
                <h3 class="form-title" id="recurring-form-title">Add Recurring Bill</h3>
                <button class="close-btn" onclick="hideRecurringForm()">&times;</button>
            </div>
            <form id="recurring-form">
                <div class="form-group">
                    <label class="form-label" for="recurring-ledger">Ledger *</label>
                    <select id="recurring-ledger" class="form-select" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="recurring-wallet">Wallet *</label>
                    <select id="recurring-wallet" class="form-select" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="recurring-type">Type *</label>
                    <select id="recurring-type" class="form-select" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="recurring-category">Category *</label>
                    <select id="recurring-category" class="form-select" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="recurring-amount">Amount *</label>
                    <input type="number" id="recurring-amount" class="form-input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="recurring-currency">Currency *</label>
                    <select id="recurring-currency" class="form-select" required></select>
                </div>
                
                <!-- Multi-currency display section -->
                <div class="form-group" id="recurring-multi-currency-section">
                    <label class="form-label">Multi-Currency Conversion</label>
                    <div class="multi-currency-grid">
                        <div class="currency-item" id="recurring-sgd-display">
                            <div class="currency-label">SGD</div>
                            <div class="currency-amount" id="recurring-sgd-amount">S$0.00</div>
                            <div class="currency-rate" id="recurring-sgd-rate">Rate: 1.0000</div>
                        </div>
                        <div class="currency-item" id="recurring-cny-display">
                            <div class="currency-label">CNY</div>
                            <div class="currency-amount" id="recurring-cny-amount">¥0.00</div>
                            <div class="currency-rate" id="recurring-cny-rate">Rate: 0.0000</div>
                        </div>
                        <div class="currency-item" id="recurring-usd-display">
                            <div class="currency-label">USD</div>
                            <div class="currency-amount" id="recurring-usd-amount">$0.00</div>
                            <div class="currency-rate" id="recurring-usd-rate">Rate: 0.0000</div>
                        </div>
                        <div class="currency-item" id="recurring-myr-display">
                            <div class="currency-label">MYR</div>
                            <div class="currency-amount" id="recurring-myr-amount">RM0.00</div>
                            <div class="currency-rate" id="recurring-myr-rate">Rate: 0.0000</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="recurring-notes">Notes</label>
                    <textarea id="recurring-notes" class="form-textarea" placeholder="Optional notes"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="recurring-anchor">Anchor Date *</label>
                    <input type="datetime-local" id="recurring-anchor" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="recurring-frequency">Frequency *</label>
                    <select id="recurring-frequency" class="form-select" required>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Icon Selection Modal -->
    <div id="icon-modal" class="icon-modal">
        <div class="icon-modal-content">
            <div class="icon-modal-header">
                <h3 class="icon-modal-title">Choose Icon</h3>
                <button class="icon-modal-close" onclick="hideIconModal()">&times;</button>
            </div>
            
            <!-- Preview Section -->
            <div class="preview-section">
                <div class="preview-logo" id="preview-logo">
                    <div class="preview-icon" id="preview-icon">
                        📂
                    </div>
                </div>
            </div>
            
            <div class="color-section">
                <h4>Select Background Color</h4>
                <div class="color-palette" id="color-palette">
                    <!-- Color options will be loaded here -->
                </div>
            </div>
            
            <div class="emoji-section">
                <h4>Select Emoji</h4>
                <div class="emoji-input-section">
                    <input type="text" id="emoji-input" placeholder="Enter emoji or select from below" class="emoji-input">
                    <div class="emoji-input-hint">💡 Tip: You can directly enter emojis, such as 🍽️ 🚗 🛒</div>
                </div>
                <div class="emoji-grid" id="emoji-grid">
                    <!-- Emoji options will be loaded here -->
                </div>
            </div>
            
            <div class="icon-modal-actions">
                <button type="button" class="btn-confirm" onclick="confirmIconSelection()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="confirm-title">Confirm Action</h3>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message" id="confirm-message">Are you sure you want to proceed?</p>
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="confirm-cancel">Cancel</button>
                <button class="custom-modal-btn custom-modal-btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="alert-title">Notice</h3>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message" id="alert-message">Operation completed.</p>
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-btn-primary" id="alert-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title">Confirm Logout</h3>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message">Are you sure you want to sign out? This will clear your current session.</p>
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-btn-danger" onclick="confirmLogout()">Sign Out</button>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script type="module">
        import { formatCompactWithTitle } from './assets/js/numberFormat.js';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabase = createClient('https://glduiypkpsuxzdjscuhq.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsZHVpeXBrcHN1eHpkanNjdWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzYwOTEsImV4cCI6MjA3MTAxMjA5MX0.dZO3fa7PCcJG0yxSbtJXPVbp31c-C4VAFKmk9SOtji8');

        // 全局变量
        let currentEditingLedger = null;
        let currentEditingCategory = null;
        let selectedEmoji = null;
        let selectedColor = null;
        let isEditingBudget = false; // 标记是否正在编辑Budget
        
        // 智能推荐配置
        const categoryRecommendations = {
            // 餐饮类
            'food': { emoji: '🍽️' },
            'lunch': { emoji: '🍽️' },
            'dinner': { emoji: '🍽️' },
            'coffee': { emoji: '☕' },
            'restaurant': { emoji: '🍽️' },
            'breakfast': { emoji: '🍳' },
            'snack': { emoji: '🍪' },
            'meal': { emoji: '🍽️' },
            'eating': { emoji: '🍽️' },
            
            // 交通类
            'transport': { emoji: '🚗' },
            'car': { emoji: '🚗' },
            'bus': { emoji: '🚌' },
            'train': { emoji: '🚇' },
            'taxi': { emoji: '🚕' },
            'gas': { emoji: '⛽' },
            'parking': { emoji: '🅿️' },
            'uber': { emoji: '🚗' },
            'lyft': { emoji: '🚗' },
            
            // 购物类
            'shopping': { emoji: '🛒' },
            'clothes': { emoji: '👕' },
            'grocery': { emoji: '🛒' },
            'online': { emoji: '📱' },
            'electronics': { emoji: '📱' },
            'fashion': { emoji: '👗' },
            'amazon': { emoji: '📦' },
            'mall': { emoji: '🏬' },
            
            // 娱乐类
            'entertainment': { emoji: '🎬' },
            'movie': { emoji: '🎬' },
            'game': { emoji: '🎮' },
            'music': { emoji: '🎵' },
            'concert': { emoji: '🎤' },
            'party': { emoji: '🎉' },
            'netflix': { emoji: '📺' },
            'spotify': { emoji: '🎵' },
            
            // 健康类
            'health': { emoji: '💊' },
            'medical': { emoji: '💊' },
            'pharmacy': { emoji: '💊' },
            'doctor': { emoji: '👨‍⚕️' },
            'hospital': { emoji: '🏥' },
            'fitness': { emoji: '💪' },
            'gym': { emoji: '💪' },
            'dental': { emoji: '🦷' },
            
            // 教育类
            'education': { emoji: '📚' },
            'book': { emoji: '📚' },
            'school': { emoji: '🏫' },
            'course': { emoji: '📚' },
            'training': { emoji: '📚' },
            'workshop': { emoji: '✏️' },
            'university': { emoji: '🎓' },
            'study': { emoji: '📚' },
            
            // 旅行类
            'travel': { emoji: '✈️' },
            'vacation': { emoji: '🏖️' },
            'hotel': { emoji: '🏨' },
            'flight': { emoji: '✈️' },
            'tourism': { emoji: '🗽' },
            'sightseeing': { emoji: '🗽' },
            'airbnb': { emoji: '🏠' },
            'booking': { emoji: '🏨' },
            
            // 家居类
            'home': { emoji: '🏠' },
            'furniture': { emoji: '🪑' },
            'utilities': { emoji: '⚡' },
            'repair': { emoji: '🔧' },
            'cleaning': { emoji: '🧹' },
            'maintenance': { emoji: '🔧' },
            'rent': { emoji: '🏠' },
            'mortgage': { emoji: '🏠' }
        };
        


        // 检查用户认证状态
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
        }

        // 显示指定部分
        function showSection(section) {
            // 隐藏所有部分
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.settings-nav-item').forEach(item => item.classList.remove('active'));
            
            // 显示指定部分
            document.getElementById(section + '-section').classList.add('active');
            
            // 设置导航项为活跃状态
            const navItem = document.querySelector(`.settings-nav-item[data-section="${section}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // 加载对应数据
            if (section === 'profile') {
                loadProfileInfo();
            } else if (section === 'ledger') {
                loadLedgersList();
            } else if (section === 'category') {
                loadCategoriesList();
            } else if (section === 'budget') {
                loadBudgetsList();
            } else if (section === 'wallet') {
                loadWalletsList();
            } else if (section === 'recurring') {
                loadRecurringList();
            }
        }

        // 显示空白状态提示
        function showEmptyState(containerId, type, hasLedger = true) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let content = '';
            
            if (type === 'ledger') {
                content = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">📊</div>
                        <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">No Ledgers Yet</h3>
                        <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                            Ledgers help you organize your financial records. Create your first ledger to start tracking your money!
                        </p>
                        <button onclick="showAddLedgerForm()" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Create Your First Ledger
                        </button>
                    </div>
                `;
            } else if (type === 'category') {
                if (hasLedger) {
                    content = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">🏷️</div>
                            <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">No Categories Yet</h3>
                            <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                                Categories help you organize your transactions. Create categories to better track your spending patterns!
                            </p>
                            <button onclick="showAddCategoryForm()" 
                                    style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Create Your First Category
                            </button>
                        </div>
                    `;
                } else {
                    content = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">🏷️</div>
                            <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">Create a Ledger First</h3>
                            <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                                You need to create a ledger before you can add categories. Categories help organize transactions within your ledgers.
                            </p>
                            <button onclick="showAddLedgerForm()" 
                                    style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Create Your First Ledger
                            </button>
                        </div>
                    `;
                }
            } else if (type === 'budget') {
                if (hasLedger) {
                    content = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">💰</div>
                            <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">No Budgets Yet</h3>
                            <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                                Set up budgets to track your spending goals and stay on top of your finances. Create your first budget to get started!
                            </p>
                            <button onclick="showAddBudgetForm()" 
                                    style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Create Your First Budget
                            </button>
                        </div>
                    `;
                } else {
                    content = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">💰</div>
                            <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">Create a Ledger First</h3>
                            <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                                You need to create a ledger before you can set up budgets. Budgets help you track spending goals for each ledger.
                            </p>
                            <button onclick="showAddLedgerForm()" 
                                    style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Create Your First Ledger
                            </button>
                        </div>
                    `;
                }
            } else if (type === 'wallet') {
                content = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">💳</div>
                        <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">No Wallets Yet</h3>
                        <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                            Wallets help you organize your money by different accounts or purposes. Create your first wallet to start managing your finances!
                        </p>
                        <button onclick="showAddWalletForm()" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Create Your First Wallet
                        </button>
                    </div>
                `;
            } else if (type === 'recurring') {
                content = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #e9d5ff 0%, #c4b5fd 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">⏱️</div>
                        <h3 style="color: #374151; margin-bottom: 12px; font-size: 18px; font-weight: 600;">No Recurring Bills Yet</h3>
                        <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6; font-size: 14px;">
                            Create a recurring bill to automatically record weekly, monthly, or yearly expenses/income.
                        </p>
                        <button onclick="showAddRecurringForm()" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Create Your First Recurring Bill
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = content;
        }

        // 将函数添加到全局作用域
        window.showSection = showSection;
        window.showEmptyState = showEmptyState;

        // 显示登出确认弹窗
        window.logout = function() {
            const modal = document.getElementById('logout-modal');
            modal.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideLogoutModal();
                }
            });
        }

        // 隐藏登出弹窗
        window.hideLogoutModal = function() {
            document.getElementById('logout-modal').classList.remove('show');
        }

        // 确认登出
        window.confirmLogout = async function() {
            try {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error during logout:', error);
                alert('登出时发生错误，请重试');
            }
        }

        // 显示Toast提示
        function showToast(message) {
            // 移除现有的toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // 创建新的toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // 显示toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // 3秒后自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        // 复制到剪贴板
        window.copyToClipboard = function(text) {
            try {
                // 使用传统的复制方法，兼容性更好
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    // 复制成功的视觉反馈
                    const button = event.target.closest('.copy-btn');
                    if (button) {
                        const originalColor = button.style.color;
                        button.style.color = '#28a745';
                        setTimeout(() => {
                            button.style.color = originalColor;
                        }, 500);
                    }
                    // 显示成功提示
                    showToast('Copied to clipboard!');
                } else {
                    console.error('Copy command failed');
                    showToast('Copy failed. Please try again.');
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                // 如果传统方法也失败，尝试现代API作为最后的降级方案
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).catch(console.error);
                }
            }
        }

        // 获取当前用户信息
        async function getCurrentUserInfo() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }

                // 从allowed_users表中获取用户详细信息
                const { data: userData, error } = await supabase
                    .from('allowed_users')
                    .select('id, display_name, email, created_at')
                    .eq('email', user.email)
                    .single();

                if (error) throw error;

                return {
                    id: userData.id,
                    display_name: userData.display_name || user.email.split('@')[0],
                    email: userData.email,
                    created_at: userData.created_at
                };
            } catch (error) {
                console.error('Error getting current user info:', error);
                throw error;
            }
        }

        // 加载用户信息
        async function loadProfileInfo() {
            try {
                // 获取当前用户信息
                const userData = await getCurrentUserInfo();

                const profileContainer = document.getElementById('profile-info');
                const profileHeader = document.getElementById('profile-header');
                const registerDate = userData.created_at ? new Date(userData.created_at).toLocaleDateString() : 'Unknown';
                const userName = userData.display_name || 'User';
                const userInitial = userName.charAt(0).toUpperCase();

                // 更新Profile Header
                profileHeader.innerHTML = `
                    <div class="user-logo">${userInitial}</div>
                    <div class="user-welcome">Welcome back, ${userName}!</div>
                `;

                // 更新Profile信息
                profileContainer.innerHTML = `
                    <div id="profile-header" class="profile-header">
                        <div class="user-logo">${userInitial}</div>
                        <div class="user-welcome">Welcome back, ${userName}!</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">User Name:</div>
                        <div class="profile-value">${userData.display_name || 'Not set'}</div>
                        <button class="copy-btn" onclick="copyToClipboard('${userData.display_name || 'Not set'}')" title="Copy User Name">
                            <img src="assets/svg/copy.svg?v=2" alt="Copy" width="16" height="16">
                        </button>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">User Email:</div>
                        <div class="profile-value">${userData.email}</div>
                        <button class="copy-btn" onclick="copyToClipboard('${userData.email}')" title="Copy Email">
                            <img src="assets/svg/copy.svg?v=2" alt="Copy" width="16" height="16">
                        </button>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">User ID:</div>
                        <div class="profile-value">${userData.id}</div>
                        <button class="copy-btn" onclick="copyToClipboard('${userData.id}')" title="Copy User ID">
                            <img src="assets/svg/copy.svg?v=2" alt="Copy" width="16" height="16">
                        </button>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Register Date:</div>
                        <div class="profile-value">${registerDate}</div>
                        <button class="copy-btn" onclick="copyToClipboard('${registerDate}')" title="Copy Register Date">
                            <img src="assets/svg/copy.svg?v=2" alt="Copy" width="16" height="16">
                        </button>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Account:</div>
                        <div class="profile-value">
                            <button class="logout-btn" onclick="logout()">Log out</button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading profile info:', error);
                const profileContainer = document.getElementById('profile-info');
                profileContainer.innerHTML = `
                    <div class="profile-item">
                        <div class="profile-label">Error:</div>
                        <div class="profile-value">Failed to load profile information. Please try again.</div>
                    </div>
                `;
            }
        }

        // 加载Ledger列表（支持访问控制）
        async function loadLedgersList() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];

                if (useAccessControl) {
                    try {
                        // 读取当前用户ID
                        const currentUser = await getCurrentUserInfo();
                        // 仅加载我有成员关系的账本
                        const { data: ledgers, error } = await supabase
                            .from('ledgers')
                            .select('*, ledger_members!inner(user_id)')
                            .eq('is_active', true)
                            .eq('ledger_members.user_id', currentUser.id)
                            .order('name');
                        if (error) throw error;
                        data = ledgers || [];
                        // 无权限时显示空状态（不再回退显示全部）
                        if (data.length === 0) {
                            console.log('用户无账本权限，显示空状态');
                        }
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        // 如果用户不存在或没有权限，显示空状态
                        data = [];
                    }
                } else {
                    // 旧逻辑：加载全部活跃账本
                    const { data: allLedgers, error } = await supabase
                        .from('ledgers')
                        .select('*')
                        .eq('is_active', true)
                        .order('name');
                    if (error) throw error;
                    data = allLedgers || [];
                }
                
                const listContainer = document.getElementById('ledger-list');
                listContainer.innerHTML = '';
                
                if (data.length === 0) {
                    showEmptyState('ledger-list', 'ledger');
                } else {
                    data.forEach(ledger => {
                        const item = document.createElement('div');
                        item.className = 'ledger-item';
                        
                        const lastEdited = ledger.last_edited_at ? new Date(ledger.last_edited_at).toLocaleDateString() : 'Unknown';
                        const editor = ledger.last_editor_name || 'Unknown';
                        
                        item.innerHTML = `
                            <div class="ledger-header">
                                <div class="ledger-name">${ledger.name}</div>
                                <div class="ledger-actions">
                                    <button class="icon-btn edit-btn" onclick="editLedger(${ledger.id}, '${ledger.name}', '${ledger.description || ''}')">
                                        <img src="assets/svg/edit.svg?v=2" alt="Edit" width="16" height="16">
                                    </button>
                                    <button class="icon-btn" title="Manage Members" onclick="manageLedgerMembers(${ledger.id}, '${ledger.name}')">
                                        <img src="assets/svg/user.svg" alt="Members" width="16" height="16">
                                    </button>
                                    <button class="icon-btn delete-btn" onclick="deleteLedger(${ledger.id})">
                                        <img src="assets/svg/delete.svg?v=2" alt="Delete" width="16" height="16">
                                    </button>
                                </div>
                            </div>
                            <div class="ledger-info">
                                <div class="info-row">
                                    <span class="info-label">Description:</span>
                                    <span class="info-value">${ledger.description || 'No description provided'}</span>
                                </div>
                            </div>
                            <div class="ledger-meta">Last Editor: ${editor} on ${lastEdited}</div>
                        `;
                        listContainer.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading ledgers:', error);
            }
        }

        // ===== 成员管理（账本） =====
        window.manageLedgerMembers = async function(ledgerId, ledgerName){
            try{
                const members = await listLedgerMembers(ledgerId);
                console.log('Ledger members for', ledgerName, members);
                // 简版：提示成员信息，后续可接UI弹窗
                alert(`${ledgerName} members (count=${members.length})`);
            }catch(e){
                console.error('manageLedgerMembers error:', e);
                alert('Failed to load members');
            }
        }

        async function listLedgerMembers(ledgerId){
            const { data, error } = await supabase
                .from('ledger_members')
                .select('id, role, user_id, allowed_users: user_id (display_name, email)')
                .eq('ledger_id', ledgerId)
                .order('role');
            if (error) throw error;
            return data || [];
        }

        async function addLedgerMember(ledgerId, userId, role, actorId){
            const { error } = await supabase
                .from('ledger_members')
                .insert({ ledger_id: ledgerId, user_id: userId, role: role || 'member', created_by: actorId || null });
            if (error) throw error;
        }

        async function updateLedgerMemberRole(memberId, newRole){
            const { error } = await supabase
                .from('ledger_members')
                .update({ role: newRole })
                .eq('id', memberId);
            if (error) throw error;
        }

        async function removeLedgerMember(ledgerId, memberId){
            // 仅当要删除的是 owner 且其为最后一个 owner 时阻止
            const { data: memberRow, error: memberErr } = await supabase
                .from('ledger_members')
                .select('role')
                .eq('id', memberId)
                .single();
            if (memberErr) throw memberErr;
            if (memberRow && memberRow.role === 'owner'){
                const { data: owners, error: ownErr } = await supabase
                    .from('ledger_members')
                    .select('id')
                    .eq('ledger_id', ledgerId)
                    .eq('role', 'owner');
                if (ownErr) throw ownErr;
                if ((owners || []).length <= 1){
                    throw new Error('Cannot remove the last owner');
                }
            }
            const { error } = await supabase
                .from('ledger_members')
                .delete()
                .eq('id', memberId);
            if (error) throw error;
        }

        // ===== 成员管理（钱包） =====
        window.manageWalletMembers = async function(walletId, walletName){
            try{
                const members = await listWalletMembers(walletId);
                console.log('Wallet members for', walletName, members);
                alert(`${walletName} members (count=${members.length})`);
            }catch(e){
                console.error('manageWalletMembers error:', e);
                alert('Failed to load wallet members');
            }
        }

        async function listWalletMembers(walletId){
            const { data, error } = await supabase
                .from('wallet_members')
                .select('id, role, user_id, allowed_users: user_id (display_name, email)')
                .eq('wallet_id', walletId)
                .order('role');
            if (error) throw error;
            return data || [];
        }

        async function addWalletMember(walletId, userId, role, actorId){
            const { error } = await supabase
                .from('wallet_members')
                .insert({ wallet_id: walletId, user_id: userId, role: role || 'member', created_by: actorId || null });
            if (error) throw error;
        }

        async function updateWalletMemberRole(memberId, newRole){
            const { error } = await supabase
                .from('wallet_members')
                .update({ role: newRole })
                .eq('id', memberId);
            if (error) throw error;
        }

        async function removeWalletMember(walletId, memberId){
            // 仅当要删除的是 owner 且其为最后一个 owner 时阻止
            const { data: memberRow, error: memberErr } = await supabase
                .from('wallet_members')
                .select('role')
                .eq('id', memberId)
                .single();
            if (memberErr) throw memberErr;
            if (memberRow && memberRow.role === 'owner'){
                const { data: owners, error: ownErr } = await supabase
                    .from('wallet_members')
                    .select('id')
                    .eq('wallet_id', walletId)
                    .eq('role', 'owner');
                if (ownErr) throw ownErr;
                if ((owners || []).length <= 1){
                    throw new Error('Cannot remove the last owner');
                }
            }
            const { error } = await supabase
                .from('wallet_members')
                .delete()
                .eq('id', memberId);
            if (error) throw error;
        }

        // ===== 通用：成员管理弹窗渲染 =====
        // 现代化成员管理模态框样式
        function ensureMembersModal(){
            if (document.getElementById('members-modal')) return;
            const modal = document.createElement('div');
            modal.id = 'members-modal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 15000;
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                padding: 20px;
                box-sizing: border-box;
            `;
            modal.innerHTML = `
                <div id="members-modal-card" style="
                    background: #fff;
                    border-radius: 20px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 80vh;
                    overflow: hidden;
                    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
                    display: flex;
                    flex-direction: column;
                    animation: modalSlideIn 0.3s ease-out;
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 24px 24px 16px;
                        border-bottom: 1px solid #f0f0f0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                    ">
                        <div id="members-modal-title" style="
                            font-weight: 700;
                            font-size: 20px;
                            color: white;
                        ">Members</div>
                        <button id="members-modal-close" style="
                            border: none;
                            background: rgba(255, 255, 255, 0.2);
                            border-radius: 12px;
                            padding: 8px 12px;
                            cursor: pointer;
                            color: white;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s ease;
                            backdrop-filter: blur(10px);
                        ">✕</button>
                    </div>
                    <div id="members-modal-body" style="
                        flex: 1;
                        overflow-y: auto;
                        padding: 0;
                    "></div>
                </div>
                <style>
                    @keyframes modalSlideIn {
                        from {
                            opacity: 0;
                            transform: scale(0.9) translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1) translateY(0);
                        }
                    }
                    
                    #members-modal-close:hover {
                        background: rgba(255, 255, 255, 0.3) !important;
                        transform: scale(1.05);
                    }
                    
                    /* 移动端优化 */
                    @media (max-width: 768px) {
                        #members-modal {
                            padding: 10px !important;
                        }
                        
                        #members-modal-card {
                            max-height: 90vh !important;
                            border-radius: 16px !important;
                        }
                        
                        #members-modal-title {
                            font-size: 18px !important;
                        }
                        
                        .member-item {
                            flex-direction: column !important;
                            align-items: stretch !important;
                            gap: 12px !important;
                            padding: 16px !important;
                        }
                        
                        .member-item > div:first-child {
                            flex-direction: row !important;
                            justify-content: flex-start !important;
                        }
                        
                        .member-item > div:last-child {
                            flex-direction: column !important;
                            gap: 8px !important;
                        }
                        
                        .role-select, .remove-btn {
                            width: 100% !important;
                            min-width: unset !important;
                        }
                        
                        #invite-email, #invite-role, #invite-add {
                            font-size: 16px !important;
                            min-height: 44px !important;
                        }
                        
                        #invite-email {
                            min-width: unset !important;
                        }
                    }
                </style>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e)=>{ if (e.target === modal) hideMembersModal(); });
            document.getElementById('members-modal-close').onclick = hideMembersModal;
        }

        function showMembersModal(){
            document.getElementById('members-modal').style.display = 'flex';
        }
        function hideMembersModal(){
            const el = document.getElementById('members-modal');
            if (el) el.style.display = 'none';
        }

        async function resolveUserIdByEmail(email){
            const { data, error } = await supabase
                .from('allowed_users')
                .select('id, email, display_name')
                .eq('email', email)
                .single();
            if (error) throw new Error('当前账号还没有开通权限，请联系管理员加入。');
            return data.id;
        }

        async function renderMembersModal(entity){
            // entity: { kind: 'ledger'|'wallet', id, name }
            ensureMembersModal();
            const title = document.getElementById('members-modal-title');
            const body = document.getElementById('members-modal-body');
            title.textContent = `${entity.name} — Members`;
            body.innerHTML = '<div style="color:#666;margin-bottom:8px">Loading...</div>';

            try{
                // 获取当前用户信息
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    await showCustomAlert('Authentication Error', 'User not authenticated');
                    return;
                }

                // 获取当前用户ID
                const { data: userData } = await supabase
                    .from('allowed_users')
                    .select('id')
                    .eq('email', user.email)
                    .single();
                
                if (!userData) {
                    await showCustomAlert('Permission Error', 'User not found in allowed users list');
                    return;
                }

                const currentUserId = userData.id;

                const members = entity.kind === 'ledger'
                    ? await listLedgerMembers(entity.id)
                    : await listWalletMembers(entity.id);

                // 获取当前用户在此entity中的角色
                const currentUserMember = members.find(m => m.user_id === currentUserId);
                const currentUserRole = currentUserMember ? currentUserMember.role : null;
                const isOwner = currentUserRole === 'owner';
                const canAddMember = isOwner || currentUserRole === 'member'; // owner和member都可以添加成员

                const rowsHtml = (members || []).map(m => {
                    const userLabel = (m.allowed_users && (m.allowed_users.display_name || m.allowed_users.email)) || m.user_id;
                    const role = m.role || 'member';
                    const isCurrentUser = m.user_id === currentUserId;
                    const isMemberRole = role === 'member';
                    
                    const roleColors = {
                        'owner': '#667eea',
                        'member': '#6b7280'
                    };
                    const roleIcons = {
                        'owner': '👑',
                        'member': '👤'
                    };

                    // 权限控制
                    const canModifyRole = false; // 角色不可修改，在一开始就确定了
                    const canRemoveMember = isOwner && !isCurrentUser && isMemberRole; // 只有owner可以移除member，但不能移除自己，也不能移除其他owner

                    return `
                        <div class="member-item" data-member-id="${m.id}" style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 16px 20px;
                            border-bottom: 1px solid #f5f5f5;
                            transition: all 0.2s ease;
                        ">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-weight: 600;
                                    font-size: 16px;
                                ">${userLabel.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style="font-weight: 400; color: #333; font-size: 16px; margin-bottom: 2px;">${userLabel}${isCurrentUser ? ' (You)' : ''}</div>
                                    <div style="font-size: 12px; color: #666;">${m.allowed_users?.email || ''} • ${role.charAt(0).toUpperCase() + role.slice(1)}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${canRemoveMember ? `
                                <button class="remove-btn" style="
                                    border: none;
                                    background: #fef2f2;
                                    color: #dc2626;
                                    padding: 8px 12px;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 400;
                                    transition: all 0.2s ease;
                                    border: 2px solid #fecaca;
                                ">Remove</button>
                                ` : ''}
                            </div>
                        </div>`;
                }).join('');

                body.innerHTML = `
                    <div style="padding: 0;">
                        ${rowsHtml || `
                            <div style="
                                text-align: center;
                                padding: 40px 20px;
                                color: #9ca3af;
                                font-size: 16px;
                            ">
                                <div style="font-size: 48px; margin-bottom: 16px;">👥</div>
                                <div>No members yet</div>
                                <div style="font-size: 14px; margin-top: 4px;">Add members below to get started</div>
                    </div>
                        `}
                    </div>
                    ${canAddMember ? `
                    <div style="
                        padding: 20px;
                        background: #f8fafc;
                        border-top: 1px solid #e5e7eb;
                        margin-top: auto;
                    ">
                        <div style="
                            display: flex;
                            gap: 12px;
                            align-items: center;
                            flex-wrap: wrap;
                        ">
                            <input id="invite-email" type="email" placeholder="user@example.com" style="
                                flex: 1;
                                min-width: 200px;
                                padding: 12px 16px;
                                border: 2px solid #e5e7eb;
                                border-radius: 12px;
                                font-size: 16px;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                background: white;
                                transition: all 0.2s ease;
                                box-sizing: border-box;
                            " />
                            <button id="invite-add" style="
                                padding: 12px 20px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: 400;
                                transition: all 0.2s ease;
                                white-space: nowrap;
                            ">Add Member</button>
                        </div>
                    </div>
                    ` : `
                    <div style="
                        padding: 20px;
                        background: #f8fafc;
                        border-top: 1px solid #e5e7eb;
                        margin-top: auto;
                        text-align: center;
                        color: #6b7280;
                    ">
                        Only owners and members can add new members
                    </div>
                    `}
                `;

                // 角色修改功能已移除 - 角色在一开始就确定了，不可修改

                // 事件：移除成员
                body.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', async (e)=>{
                        const memberItem = e.target.closest('.member-item');
                        const memberId = memberItem.getAttribute('data-member-id');
                        
                        // 权限验证：只有owner可以移除成员
                        if (!isOwner) {
                            await showCustomAlert('Permission Denied', 'Only owners can remove members');
                            return;
                        }
                        
                        const confirmed = await showCustomConfirm(
                            'Remove Member', 
                            'Are you sure you want to remove this member?', 
                            'Remove', 
                            'Cancel', 
                            'danger'
                        );
                        if (!confirmed) return;
                        try{
                            if (entity.kind === 'ledger') await removeLedgerMember(entity.id, memberId);
                            else await removeWalletMember(entity.id, memberId);
                            memberItem.remove();
                        }catch(err){
                            // 特殊处理"不能移除最后一个owner"的情况
                            if (err.message && err.message.includes('last owner')) {
                                await showCustomAlert('Cannot Remove Owner', 'Cannot remove the last owner. Please assign another member as owner first.');
                            } else {
                                await showCustomAlert('Error', err.message || 'Failed to remove member');
                            }
                            console.error(err);
                        }
                    });
                });

                // 事件：添加成员
                const addBtn = body.querySelector('#invite-add');
                if (addBtn) {
                    addBtn.addEventListener('click', async ()=>{
                        // 权限验证：owner和member都可以添加成员
                        if (!isOwner && currentUserRole !== 'member') {
                            await showCustomAlert('Permission Denied', 'Only owners and members can add new members');
                            return;
                        }
                        
                        const email = (body.querySelector('#invite-email').value || '').trim();
                        if (!email){ await showCustomAlert('Validation Error', 'Please enter email'); return; }
                        
                        try{
                            const userId = await resolveUserIdByEmail(email);
                            const { data: authData } = await supabase.auth.getUser();
                            // 使用 allowed_users.id 作为 actorId（created_by 外键指向 allowed_users）
                            let actorId = null;
                            if (authData && authData.user) {
                                const { data: actorRow, error: actorErr } = await supabase
                                    .from('allowed_users')
                                    .select('id, email')
                                    .eq('email', authData.user.email)
                                    .single();
                                if (actorErr) throw actorErr;
                                actorId = actorRow?.id || null;
                            }
                            if (entity.kind === 'ledger') await addLedgerMember(entity.id, userId, 'member', actorId);
                            else await addWalletMember(entity.id, userId, 'member', actorId);
                            await renderMembersModal(entity); // 刷新
                        }catch(err){
                            await showCustomAlert('Error', err.message || 'Failed to add member');
                            console.error(err);
                        }
                    });
                }

                showMembersModal();
            }catch(e){
                console.error('renderMembersModal error:', e);
                await showCustomAlert('Error', 'Failed to load members');
            }
        }

        // 从入口按钮打开弹窗
        window.manageLedgerMembers = async function(ledgerId, ledgerName){
            await renderMembersModal({ kind: 'ledger', id: ledgerId, name: ledgerName });
        }
        window.manageWalletMembers = async function(walletId, walletName){
            await renderMembersModal({ kind: 'wallet', id: walletId, name: walletName });
        }

        // 加载Category列表（支持访问控制）
        async function loadCategoriesList() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];

                if (useAccessControl) {
                    try {
                        const currentUser = await getCurrentUserInfo();
                        // 获取用户有权限的ledger ID列表
                        const { data: ledgerMembers, error: lmErr } = await supabase
                            .from('ledger_members')
                            .select('ledger_id')
                            .eq('user_id', currentUser.id);
                        if (lmErr) throw lmErr;
                        const userLedgerIds = (ledgerMembers || []).map(m => m.ledger_id);

                        if (userLedgerIds.length > 0) {
                            // 只加载有权限的ledger的categories
                            const { data: categories, error } = await supabase
                                .from('categories')
                                .select('id, name, parent_type, ledger_id, emoji, background_color, ledgers(name)')
                                .in('ledger_id', userLedgerIds)
                                .order('parent_type, name');
                            if (error) throw error;
                            data = categories || [];
                        }
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        data = [];
                    }
                } else {
                    // 旧逻辑：加载全部categories
                    const { data: allCategories, error } = await supabase
                        .from('categories')
                        .select('id, name, parent_type, ledger_id, emoji, background_color, ledgers(name)')
                        .order('parent_type, name');
                    if (error) throw error;
                    data = allCategories || [];
                }
                
                const listContainer = document.getElementById('category-list');
                listContainer.innerHTML = '';
                
                // 检查是否有ledger数据（支持访问控制）
                let hasLedger = false;
                
                if (useAccessControl) {
                    try {
                        const currentUser = await getCurrentUserInfo();
                        const { data: ledgerData, error: ledgerError } = await supabase
                            .from('ledgers')
                            .select('id, ledger_members!inner(user_id)')
                            .eq('is_active', true)
                            .eq('ledger_members.user_id', currentUser.id)
                            .limit(1);
                        hasLedger = !ledgerError && ledgerData && ledgerData.length > 0;
                    } catch (userError) {
                        console.error('Error checking ledger access:', userError);
                        hasLedger = false;
                    }
                } else {
                    const { data: ledgerData, error: ledgerError } = await supabase
                        .from('ledgers')
                        .select('id')
                        .eq('is_active', true)
                        .limit(1);
                    hasLedger = !ledgerError && ledgerData && ledgerData.length > 0;
                }
                
                if (data.length === 0) {
                    showEmptyState('category-list', 'category', hasLedger);
                } else {
                    data.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'ledger-item';
                    
                    const ledgerName = category.ledgers ? category.ledgers.name : 'Unknown';
                    
                    // 创建按钮元素
                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-btn edit-btn';
                    editBtn.innerHTML = `<img src="assets/svg/edit.svg?v=2" alt="Edit" width="16" height="16">`;
                    editBtn.onclick = () => editCategory(category.id, category.name, category.parent_type, category.ledger_id);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn delete-btn';
                    deleteBtn.innerHTML = `<img src="assets/svg/delete.svg?v=2" alt="Delete" width="16" height="16">`;
                    deleteBtn.onclick = () => deleteCategory(category.id);
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'ledger-actions';
                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);
                    
                    // 创建icon显示
                    let iconDisplay = '';
                    if (category.emoji && category.background_color) {
                        iconDisplay = `
                            <div class="category-icon" style="
                                width: 64px; 
                                height: 64px; 
                                border-radius: 16px; 
                                background-color: ${category.background_color}; 
                                color: white; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-size: 32px; 
                                margin-right: 20px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " data-category-id="${category.id}" data-category-name="${category.name}" data-category-type="${category.parent_type}" data-ledger-id="${category.ledger_id}" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">${category.emoji}</div>
                        `;
                    }
                    
                    item.innerHTML = `
                        <div class="ledger-header">
                            <div class="ledger-content" style="display: flex; align-items: center; flex: 1;">
                                ${iconDisplay}
                                <div class="category-details" style="flex: 1;">
                                    <div class="category-name" style="font-weight: bold; font-size: 16px; color: #333; margin-bottom: 8px;">${category.name}</div>
                                    <div class="ledger-info">
                                        <div class="info-row">
                                            <span class="info-label">Ledger:</span>
                                            <span class="info-value">${ledgerName}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Type:</span>
                                            <span class="info-value">${category.parent_type.charAt(0).toUpperCase() + category.parent_type.slice(1)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 将按钮添加到header中
                    const header = item.querySelector('.ledger-header');
                    header.appendChild(actionsDiv);
                    
                    // 添加图标点击事件监听器
                    const iconElement = item.querySelector('.category-icon');
                    if (iconElement) {
                        iconElement.addEventListener('click', function() {
                            const id = this.getAttribute('data-category-id');
                            const name = this.getAttribute('data-category-name');
                            const type = this.getAttribute('data-category-type');
                            const ledgerId = this.getAttribute('data-ledger-id');
                            editCategoryIcon(id, name, type, ledgerId);
                        });
                    }
                    
                    listContainer.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // 显示添加Ledger表单
        window.showAddLedgerForm = function() {
            currentEditingLedger = null;
            document.getElementById('ledger-form-title').textContent = 'Add New Ledger';
            document.getElementById('ledger-name').value = '';
            document.getElementById('ledger-description').value = '';
            const overlay = document.getElementById('ledger-form-overlay');
            overlay.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    hideLedgerForm();
                }
            });
        }

        // 隐藏Ledger表单
        window.hideLedgerForm = function() {
            document.getElementById('ledger-form-overlay').classList.remove('show');
        }

        // 显示添加Category表单
        window.showAddCategoryForm = function() {
            currentEditingCategory = null;
            selectedEmoji = null;
            selectedColor = null;
            document.getElementById('category-form-title').textContent = 'Add New Category';
            document.getElementById('category-name').value = '';
            document.getElementById('category-type').value = '';
            document.getElementById('category-ledger').value = '';
            hideRecommendedIcon();
            loadCategoryLedgerOptions();
            const overlay = document.getElementById('category-form-overlay');
            overlay.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    hideCategoryForm();
                }
            });
        }

        // 隐藏Category表单
        window.hideCategoryForm = function() {
            document.getElementById('category-form-overlay').classList.remove('show');
        }

        // 编辑Ledger
        window.editLedger = function(id, name, description) {
            currentEditingLedger = id;
            document.getElementById('ledger-form-title').textContent = 'Edit Ledger';
            document.getElementById('ledger-name').value = name;
            document.getElementById('ledger-description').value = description || '';
            const overlay = document.getElementById('ledger-form-overlay');
            overlay.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    hideLedgerForm();
                }
            });
        }

        // 编辑Category图标
        window.editCategoryIcon = function(id, name, parentType, ledgerId) {
            currentEditingCategory = id;
            
            // 加载现有icon数据
            loadCategoryIconData(id).then(() => {
                // 直接打开图标选择弹窗
                showIconModal();
            });
        }

        // 编辑Category
        window.editCategory = function(id, name, parentType, ledgerId) {
            currentEditingCategory = id;
            document.getElementById('category-form-title').textContent = 'Edit Category';
            document.getElementById('category-name').value = name;
            document.getElementById('category-type').value = parentType;
            
            // 加载现有icon数据
            loadCategoryIconData(id);
            
            loadCategoryLedgerOptions().then(() => {
                document.getElementById('category-ledger').value = ledgerId;
            });
            const overlay = document.getElementById('category-form-overlay');
            overlay.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    hideCategoryForm();
                }
            });
        }

        // 加载Category的icon数据
        async function loadCategoryIconData(categoryId) {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('emoji, background_color')
                    .eq('id', categoryId)
                    .single();
                
                if (error) throw error;
                
                if (data && data.emoji && data.background_color) {
                    selectedEmoji = data.emoji;
                    selectedColor = data.background_color;
                    updateIconDisplay(data.emoji, data.background_color);
                    document.getElementById('icon-recommendation-section').style.display = 'block';
                } else {
                    // 如果没有现有icon，尝试智能推荐
                    const name = document.getElementById('category-name').value;
                    if (name.length > 2) {
                        const recommendation = getCategoryRecommendations(name);
                        showRecommendedIcon(recommendation);
                    }
                }
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading category icon data:', error);
                return Promise.reject(error);
            }
        }
        
        // 加载Category表单的Ledger选项（支持访问控制）
        async function loadCategoryLedgerOptions() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];

                if (useAccessControl) {
                    try {
                        // 读取当前用户ID
                        const currentUser = await getCurrentUserInfo();
                        // 仅加载我有成员关系的账本
                        const { data: ledgers, error } = await supabase
                            .from('ledgers')
                            .select('id, name, ledger_members!inner(user_id)')
                            .eq('is_active', true)
                            .eq('ledger_members.user_id', currentUser.id)
                            .order('name');
                        if (error) throw error;
                        data = ledgers || [];
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        // 如果用户不存在或没有权限，显示空状态
                        data = [];
                    }
                } else {
                    // 旧逻辑：加载全部活跃账本
                    const { data: allLedgers, error } = await supabase
                        .from('ledgers')
                        .select('id, name')
                        .eq('is_active', true)
                        .order('name');
                    if (error) throw error;
                    data = allLedgers || [];
                }
                
                const select = document.getElementById('category-ledger');
                select.innerHTML = '<option value="">Select ledger</option>';
                
                data.forEach(ledger => {
                    const option = document.createElement('option');
                    option.value = ledger.id;
                    option.textContent = ledger.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading ledgers for category form:', error);
            }
        }

        // Custom confirmation and alert functions
        function showCustomConfirm(title, message, confirmText = 'Delete', cancelText = 'Cancel', type = 'danger') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel');
                const confirmBtn = document.getElementById('confirm-delete');
                
                // 检查所有必需的元素是否存在
                if (!modal || !titleEl || !messageEl || !cancelBtn || !confirmBtn) {
                    console.error('Required modal elements not found:', {
                        modal: !!modal,
                        titleEl: !!titleEl,
                        messageEl: !!messageEl,
                        cancelBtn: !!cancelBtn,
                        confirmBtn: !!confirmBtn
                    });
                    resolve(false);
                    return;
                }
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                cancelBtn.textContent = cancelText;
                confirmBtn.textContent = confirmText;
                
                // Update button styles based on type
                confirmBtn.className = `custom-modal-btn custom-modal-btn-${type}`;
                
                modal.classList.add('show');
                
                const handleConfirm = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve(false);
                };
                
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleOutsideClick);
            });
        }

        function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-alert-modal');
                const titleEl = document.getElementById('alert-title');
                const messageEl = document.getElementById('alert-message');
                const okBtn = document.getElementById('alert-ok');
                
                // 检查所有必需的元素是否存在
                if (!modal || !titleEl || !messageEl || !okBtn) {
                    console.error('Required alert modal elements not found:', {
                        modal: !!modal,
                        titleEl: !!titleEl,
                        messageEl: !!messageEl,
                        okBtn: !!okBtn
                    });
                    resolve();
                    return;
                }
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                modal.classList.add('show');
                
                const handleOk = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve();
                };
                
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        handleOk();
                    }
                };
                
                const cleanup = () => {
                    okBtn.removeEventListener('click', handleOk);
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                okBtn.addEventListener('click', handleOk);
                modal.addEventListener('click', handleOutsideClick);
            });
        }

        // 删除Ledger
        window.deleteLedger = async function(id) {
            // 权限验证：只有owner可以删除ledger
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    await showCustomAlert('Authentication Error', 'User not authenticated');
                    return;
                }

                const { data: userData } = await supabase
                    .from('allowed_users')
                    .select('id')
                    .eq('email', user.email)
                    .single();
                
                if (!userData) {
                    await showCustomAlert('Permission Error', 'User not found in allowed users list');
                    return;
                }

                // 检查用户是否为ledger的owner
                const { data: memberData } = await supabase
                    .from('ledger_members')
                    .select('role')
                    .eq('ledger_id', id)
                    .eq('user_id', userData.id)
                    .single();

                if (!memberData || memberData.role !== 'owner') {
                    await showCustomAlert('Permission Denied', 'Only owners can delete ledgers');
                    return;
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
                await showCustomAlert('Error', 'Failed to verify permissions');
                return;
            }

            const confirmed = await showCustomConfirm(
                'Delete Ledger',
                'Are you sure you want to delete this ledger? This action cannot be undone.',
                'Delete',
                'Cancel',
                'danger'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('ledgers')
                    .update({ is_active: false })
                    .eq('id', id);
                
                if (error) throw error;
                
                loadLedgersList();
            } catch (error) {
                console.error('Error deleting ledger:', error);
                await showCustomAlert('Error', 'Failed to delete ledger. Please try again.');
            }
        }

        // 删除Category
        window.deleteCategory = async function(id) {
            const confirmed = await showCustomConfirm(
                'Delete Category',
                'Are you sure you want to delete this category? This action cannot be undone.',
                'Delete',
                'Cancel',
                'danger'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadCategoriesList();
            } catch (error) {
                console.error('Error deleting category:', error);
                await showCustomAlert('Error', 'Failed to delete category. Please try again.');
            }
        }

        // 监听认证状态变化
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            }
        });

        // 保存Ledger
        async function saveLedger() {
            const name = document.getElementById('ledger-name').value.trim();
            const description = document.getElementById('ledger-description').value.trim();
            
            if (!name) {
                await showCustomAlert('Validation Error', 'Please enter a ledger name.');
                return;
            }
            
            try {
                const userData = await getCurrentUserInfo();
                
                if (currentEditingLedger) {
                    // 更新现有Ledger
                    const { error } = await supabase
                        .from('ledgers')
                        .update({ 
                            name: name, 
                            description: description || null,
                            last_editor_name: userData.display_name,
                            last_edited_at: new Date().toISOString()
                        })
                        .eq('id', currentEditingLedger);
                    
                    if (error) throw error;
                } else {
                    // 创建新Ledger - 直接尝试插入
                    const { data: newLedger, error } = await supabase
                        .from('ledgers')
                        .insert([{ 
                            name: name, 
                            description: description || null,
                            last_editor_name: userData.display_name,
                            last_edited_at: new Date().toISOString()
                        }])
                        .select('id')
                        .single();
                    
                    if (error) {
                        // 提供详细的错误信息和解决方案
                        if (error.code === '42501') {
                            // 提供更详细的解决方案
                            const errorMessage = `
Permission denied: ${error.message}

This is due to Row Level Security (RLS) policies on the ledgers table.

SOLUTIONS:
1. Execute the SQL in docs/RLS_POLICY_DETAILED.md
2. Or temporarily disable RLS: ALTER TABLE "public"."ledgers" DISABLE ROW LEVEL SECURITY;
3. Or ask administrator to create the ledger for you

For detailed instructions, see: docs/RLS_POLICY_DETAILED.md
                            `;
                            throw new Error(errorMessage);
                        } else {
                            throw new Error(`Failed to create ledger: ${error.message}`);
                        }
                    }
                    
                    // 由数据库触发器自动将创建者加入 ledger_members 作为 owner，避免前端重复插入导致唯一键冲突
                }
                
                hideLedgerForm();
                loadLedgersList();
            } catch (error) {
                console.error('Error saving ledger:', error);
                
                let errorMessage = 'Failed to save ledger. Please try again.';
                
                // 检查是否是重复名称错误
                if (error.code === '23505' && error.message.includes('ledgers_name_key')) {
                    errorMessage = `A ledger with the name "${name}" already exists. Please choose a different name.`;
                } else if (error.code === '23505') {
                    errorMessage = 'This ledger name already exists. Please choose a different name.';
                } else if (error.message) {
                    // 显示具体的错误信息
                    errorMessage = `Error: ${error.message}`;
                }
                
                await showCustomAlert('Error', errorMessage);
            }
        }

        // 智能推荐函数
        function getCategoryRecommendations(categoryName) {
            const name = categoryName.toLowerCase();
            
            // 获取全局色板
            const globalColorPalette = window.APP_CONFIG ? window.APP_CONFIG.colorPalette : [
                '#ef4444', '#10b981', '#3b82f6', '#f59e0b',
                '#8b5cf6', '#06b6d4', '#d946ef', '#facc15',
                '#a16207', '#ec4899', '#0ea5e9', '#6b8e23'
            ];
            
            // 精确匹配
            if (categoryRecommendations[name]) {
                const recommendation = categoryRecommendations[name];
                return {
                    emoji: recommendation.emoji,
                    color: globalColorPalette[Math.floor(Math.random() * globalColorPalette.length)]
                };
            }
            
            // 关键词匹配
            for (const [key, value] of Object.entries(categoryRecommendations)) {
                if (name.includes(key) || key.includes(name)) {
                    return {
                        emoji: value.emoji,
                        color: globalColorPalette[Math.floor(Math.random() * globalColorPalette.length)]
                    };
                }
            }
            
            // 默认推荐
            return {
                emoji: '📂',
                color: globalColorPalette[Math.floor(Math.random() * globalColorPalette.length)]
            };
        }
        
        // 显示推荐icon
        function showRecommendedIcon(recommendation) {
            const container = document.getElementById('icon-recommendation-section');
            const iconPreview = document.getElementById('icon-preview');
            
            // 设置默认选择
            selectedEmoji = recommendation.emoji;
            selectedColor = recommendation.color;
            
            // 显示推荐icon
            iconPreview.textContent = recommendation.emoji;
            iconPreview.style.backgroundColor = recommendation.color;
            iconPreview.style.color = 'white';
            iconPreview.classList.add('has-icon');
            
            container.style.display = 'block';
        }
        
        // 隐藏推荐icon
        function hideRecommendedIcon() {
            document.getElementById('icon-recommendation-section').style.display = 'none';
        }
        
        // 显示icon选择弹窗
        window.showIconModal = function() {
            const modal = document.getElementById('icon-modal');
            const emojiGrid = document.getElementById('emoji-grid');
            const colorPaletteContainer = document.getElementById('color-palette');
            
            // 常用emoji列表
            const commonEmojis = [
                '🍽️', '🧋', '🚕', '✈️',
                '🛍️', '👕', '💄', '🎮',
                '🎭', '💊', '🏥', '🎓',
                '📝', '🏖️', '🏨', '🏠'
            ];
            
            // 生成emoji网格
            emojiGrid.innerHTML = commonEmojis.map(emoji => `
                <div class="emoji-option" data-emoji="${emoji}">${emoji}</div>
            `).join('');
            
            // 生成色卡
            const globalColorPalette = window.APP_CONFIG ? window.APP_CONFIG.colorPalette : [
                '#ef4444', '#10b981', '#3b82f6', '#f59e0b',
                '#8b5cf6', '#06b6d4', '#d946ef', '#facc15',
                '#a16207', '#ec4899', '#0ea5e9', '#6b8e23'
            ];
            
            colorPaletteContainer.innerHTML = globalColorPalette.map(color => `
                <div class="color-option" data-color="${color}" style="background-color: ${color}"></div>
            `).join('');
            
            // 设置当前选择并更新预览
            if (selectedEmoji) {
                // 设置到输入框
                const emojiInput = document.getElementById('emoji-input');
                emojiInput.value = selectedEmoji;
                
                // 设置网格选择
                const currentEmojiOption = emojiGrid.querySelector(`[data-emoji="${selectedEmoji}"]`);
                if (currentEmojiOption) {
                    currentEmojiOption.classList.add('selected');
                }
            }
            
            if (selectedColor) {
                const currentColorOption = colorPaletteContainer.querySelector(`[data-color="${selectedColor}"]`);
                if (currentColorOption) {
                    currentColorOption.classList.add('selected');
                }
            }
            
            // 更新预览
            updatePreview();
            
            // 添加事件监听器
            emojiGrid.addEventListener('click', handleEmojiSelection);
            colorPaletteContainer.addEventListener('click', handleColorSelection);
            
            // 添加emoji输入监听器
            const emojiInput = document.getElementById('emoji-input');
            emojiInput.addEventListener('input', handleEmojiInput);
            emojiInput.addEventListener('keydown', handleEmojiInputKeydown);
            
            modal.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideIconModal();
                }
            });
        }
        
        // 隐藏icon选择弹窗
        window.hideIconModal = function() {
            const modal = document.getElementById('icon-modal');
            const emojiGrid = document.getElementById('emoji-grid');
            const colorPaletteContainer = document.getElementById('color-palette');
            const emojiInput = document.getElementById('emoji-input');
            
            // 移除事件监听器
            emojiGrid.removeEventListener('click', handleEmojiSelection);
            colorPaletteContainer.removeEventListener('click', handleColorSelection);
            emojiInput.removeEventListener('input', handleEmojiInput);
            emojiInput.removeEventListener('keydown', handleEmojiInputKeydown);
            
            // 清理输入框
            emojiInput.value = '';
            
            modal.classList.remove('show');
        }
        
        // 更新预览
        function updatePreview() {
            const previewIcon = document.getElementById('preview-icon');
            if (selectedEmoji && selectedColor) {
                previewIcon.textContent = selectedEmoji;
                previewIcon.style.backgroundColor = selectedColor;
                previewIcon.style.color = 'white';
                previewIcon.classList.add('has-selection');
            } else if (selectedEmoji) {
                previewIcon.textContent = selectedEmoji;
                previewIcon.style.backgroundColor = '#f8f9fa';
                previewIcon.style.color = '#333';
                previewIcon.classList.remove('has-selection');
            } else if (selectedColor) {
                previewIcon.textContent = '📂';
                previewIcon.style.backgroundColor = selectedColor;
                previewIcon.style.color = 'white';
                previewIcon.classList.add('has-selection');
            } else {
                previewIcon.textContent = '📂';
                previewIcon.style.backgroundColor = '#f8f9fa';
                previewIcon.style.color = '#333';
                previewIcon.classList.remove('has-selection');
            }
        }

        // 处理emoji选择
        function handleEmojiSelection(event) {
            const emojiOption = event.target.closest('.emoji-option');
            if (!emojiOption) return;
            
            // 移除之前的选择
            document.querySelectorAll('.emoji-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 设置新选择
            emojiOption.classList.add('selected');
            selectedEmoji = emojiOption.dataset.emoji;
            
            // 更新预览
            updatePreview();
        }
        
        // 处理emoji输入
        function handleEmojiInput(event) {
            const input = event.target;
            const value = input.value;
            
            // 如果输入不为空，就接受为emoji
            if (value && value.trim()) {
                selectedEmoji = value.trim();
                
                // 移除网格中的选择
                document.querySelectorAll('.emoji-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // 更新预览
                updatePreview();
            }
        }

        // 处理emoji输入键盘事件
        function handleEmojiInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();
                
                if (value) {
                    selectedEmoji = value;
                    updatePreview();
                }
            }
        }



        // 处理颜色选择
        function handleColorSelection(event) {
            const colorOption = event.target.closest('.color-option');
            if (!colorOption) return;
            
            // 移除之前的选择
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 设置新选择
            colorOption.classList.add('selected');
            selectedColor = colorOption.dataset.color;
            
            // 更新预览
            updatePreview();
        }
        
        // 确认icon选择
        window.confirmIconSelection = function() {
            if (selectedEmoji && selectedColor) {
                updateIconDisplay(selectedEmoji, selectedColor);
                hideIconModal();
            }
        }
        
        // 更新icon显示
        function updateIconDisplay(emoji, color) {
            const iconPreview = document.getElementById('icon-preview');
            iconPreview.textContent = emoji;
            iconPreview.style.backgroundColor = color;
            iconPreview.style.color = 'white';
            iconPreview.classList.add('has-icon');
        }
        
        // 保存Category
        async function saveCategory() {
            const name = document.getElementById('category-name').value.trim();
            const parentType = document.getElementById('category-type').value;
            const ledgerId = document.getElementById('category-ledger').value;
            
            if (!name || !parentType || !ledgerId) {
                await showCustomAlert('Validation Error', 'Please fill in all required fields.');
                return;
            }
            
            try {
                const userData = await getCurrentUserInfo();
                
                // 准备category数据
                const categoryData = {
                    name: name, 
                    parent_type: parentType,
                    ledger_id: ledgerId,
                    last_editor_name: userData.display_name,
                    last_edited_at: new Date().toISOString()
                };
                
                // 如果有选择的emoji和颜色，添加到数据中
                if (selectedEmoji && selectedColor) {
                    categoryData.emoji = selectedEmoji;
                    categoryData.background_color = selectedColor;
                }
                
                if (currentEditingCategory) {
                    // 更新现有Category
                    const { error } = await supabase
                        .from('categories')
                        .update(categoryData)
                        .eq('id', currentEditingCategory);
                    
                    if (error) throw error;
                } else {
                    // 创建新Category
                    const { error } = await supabase
                        .from('categories')
                        .insert([categoryData]);
                    
                    if (error) throw error;
                }
                
                hideCategoryForm();
                loadCategoriesList();
            } catch (error) {
                console.error('Error saving category:', error);
                
                let errorMessage = 'Failed to save category. Please try again.';
                
                // 检查是否是重复名称错误
                if (error.code === '23505' && error.message.includes('categories_name_key')) {
                    errorMessage = `A category with the name "${name}" already exists in this ledger. Please choose a different name.`;
                } else if (error.code === '23505') {
                    errorMessage = 'This category name already exists. Please choose a different name.';
                } else if (error.message) {
                    // 显示具体的错误信息
                    errorMessage = `Error: ${error.message}`;
                }
                
                await showCustomAlert('Error', errorMessage);
            }
        }

        // 全局变量
        let currentEditingBudget = null;

        // 显示添加Budget表单
        window.showAddBudgetForm = function() {
            currentEditingBudget = null;
            isEditingBudget = false; // 重置编辑标志
            document.getElementById('budget-form-title').textContent = 'Add New Budget';
            document.getElementById('budget-ledger').value = '';
            document.getElementById('budget-month').value = '';
            document.getElementById('budget-amount').value = '';
            document.getElementById('budget-currency').value = '';
            document.getElementById('budget-description').value = '';
            
            // 清除汇率缓存，确保新建时能获取最新汇率
            console.log('Adding new budget, clearing exchange rate cache...');
            window.budgetExchangeRatesLoaded = false;
            
            // 重置多币种显示为0占位符
            document.getElementById('sgd-amount').innerHTML = 'S$0.00';
            document.getElementById('sgd-rate').textContent = 'Rate: 1.0000';
            document.getElementById('cny-amount').innerHTML = '¥0.00';
            document.getElementById('cny-rate').textContent = 'Rate: 0.0000';
            document.getElementById('usd-amount').innerHTML = '$0.00';
            document.getElementById('usd-rate').textContent = 'Rate: 0.0000';
            document.getElementById('myr-amount').innerHTML = 'RM0.00';
            document.getElementById('myr-rate').textContent = 'Rate: 0.0000';
            
            loadBudgetLedgerOptions();
            const overlay = document.getElementById('budget-form-overlay');
            overlay.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    hideBudgetForm();
                }
            });
        }

        // 隐藏Budget表单
        window.hideBudgetForm = function() {
            document.getElementById('budget-form-overlay').classList.remove('show');
            
            // 重置编辑标志
            isEditingBudget = false;
            
            // 清除汇率缓存
            console.log('Hiding budget form, clearing exchange rate cache...');
            window.budgetExchangeRatesLoaded = false;
            window.budgetExchangeRates = null;
            window.budgetExchangeRatesCacheKey = null;
            
            // 重置多币种显示为0占位符
            document.getElementById('sgd-amount').innerHTML = 'S$0.00';
            document.getElementById('sgd-rate').textContent = 'Rate: 1.0000';
            document.getElementById('cny-amount').innerHTML = '¥0.00';
            document.getElementById('cny-rate').textContent = 'Rate: 0.0000';
            document.getElementById('usd-amount').innerHTML = '$0.00';
            document.getElementById('usd-rate').textContent = 'Rate: 0.0000';
            document.getElementById('myr-amount').innerHTML = 'RM0.00';
            document.getElementById('myr-rate').textContent = 'Rate: 0.0000';
            document.querySelectorAll('.currency-item').forEach(item => {
                item.classList.remove('highlighted');
            });
        }

        // 编辑Budget
        window.editBudget = function(budgetData) {
            console.log('editBudget function called with data:', budgetData);
            currentEditingBudget = budgetData.id;
            isEditingBudget = true; // 设置编辑标志
            document.getElementById('budget-form-title').textContent = 'Edit Budget';
            document.getElementById('budget-amount').value = budgetData.amount;
            document.getElementById('budget-currency').value = budgetData.currency;
            document.getElementById('budget-description').value = budgetData.description || '';
            
            // 清除汇率缓存，确保编辑时能获取最新汇率
            console.log('Editing budget, clearing exchange rate cache...');
            window.budgetExchangeRatesLoaded = false;
            
            loadBudgetLedgerOptions().then(() => {
                console.log('Ledger options loaded, setting values...');
                console.log('Setting ledger value to:', budgetData.ledger_id);
                console.log('Setting month value to:', budgetData.month);
                
                document.getElementById('budget-ledger').value = budgetData.ledger_id;
                document.getElementById('budget-month').value = budgetData.month;
                
                // 验证设置是否成功
                setTimeout(() => {
                    const ledgerValue = document.getElementById('budget-ledger').value;
                    const monthValue = document.getElementById('budget-month').value;
                    console.log('Verification - Ledger value:', ledgerValue, 'Month value:', monthValue);
                    
                    // 显示数据库中已存储的多币种数据
                    displayStoredMultiCurrencyData(budgetData);
                }, 100);
            }).catch(error => {
                console.error('Error loading ledger options:', error);
            });
            const overlay = document.getElementById('budget-form-overlay');
            overlay.classList.add('show');
            
            // 添加点击外围关闭弹窗功能
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    hideBudgetForm();
                }
            });
        }

        // 删除Budget
        window.deleteBudget = async function(budgetId) {
            console.log('deleteBudget called with ID:', budgetId);
            const confirmed = await showCustomConfirm(
                'Delete Budget',
                'Are you sure you want to delete this budget? This action cannot be undone.',
                'Delete',
                'Cancel',
                'danger'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('budgets')
                    .delete()
                    .eq('id', budgetId);
                
                if (error) throw error;
                
                loadBudgetsList();
            } catch (error) {
                console.error('Error deleting budget:', error);
                await showCustomAlert('Error', 'Failed to delete budget. Please try again.');
            }
        }

        // 加载Budget表单的Ledger选项
        async function loadBudgetLedgerOptions() {
            try {
                console.log('Loading budget ledger options...');
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];

                if (useAccessControl) {
                    try {
                        // 读取当前用户ID
                        const currentUser = await getCurrentUserInfo();
                        // 仅加载我有成员关系的账本
                        const { data: ledgers, error } = await supabase
                            .from('ledgers')
                            .select('id, name, ledger_members!inner(user_id)')
                            .eq('is_active', true)
                            .eq('ledger_members.user_id', currentUser.id)
                            .order('name');
                        if (error) throw error;
                        data = ledgers || [];
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        // 如果用户不存在或没有权限，显示空状态
                        data = [];
                    }
                } else {
                    // 旧逻辑：加载全部活跃账本
                    const { data: allLedgers, error } = await supabase
                        .from('ledgers')
                        .select('id, name')
                        .eq('is_active', true)
                        .order('name');
                    if (error) throw error;
                    data = allLedgers || [];
                }
                
                console.log('Loaded ledgers:', data);
                
                const select = document.getElementById('budget-ledger');
                select.innerHTML = '<option value="">Select ledger</option>';
                
                data.forEach(ledger => {
                    const option = document.createElement('option');
                    option.value = ledger.id;
                    option.textContent = ledger.name;
                    select.appendChild(option);
                });
                
                console.log('Ledger options populated successfully');
                return data; // 确保返回数据
            } catch (error) {
                console.error('Error loading ledgers for budget form:', error);
                throw error; // 重新抛出错误以便上层捕获
            }
        }

        // 加载Budget列表
        async function loadBudgetsList() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];
                let hasLedger = false;

                if (useAccessControl) {
                    try {
                        const currentUser = await getCurrentUserInfo();
                        // 获取用户有权限的ledger ID列表
                        const { data: ledgerMembers, error: lmErr } = await supabase
                            .from('ledger_members')
                            .select('ledger_id')
                            .eq('user_id', currentUser.id);
                        if (lmErr) throw lmErr;
                        const userLedgerIds = (ledgerMembers || []).map(m => m.ledger_id);

                        if (userLedgerIds.length > 0) {
                            // 只加载有权限的ledger的budget
                            const { data: budgets, error } = await supabase
                                .from('budgets')
                                .select('id, ledger_id, month, amount, currency, description, sgd_amount, sgd_rate, cny_amount, cny_rate, usd_amount, usd_rate, myr_amount, myr_rate, ledgers(name)')
                                .in('ledger_id', userLedgerIds)
                                .order('month', { ascending: false });
                            if (error) throw error;
                            data = budgets || [];
                        }
                        hasLedger = userLedgerIds.length > 0;
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        data = [];
                        hasLedger = false;
                    }
                } else {
                    // 旧逻辑：加载全部budget
                    const { data: allBudgets, error } = await supabase
                        .from('budgets')
                        .select('id, ledger_id, month, amount, currency, description, sgd_amount, sgd_rate, cny_amount, cny_rate, usd_amount, usd_rate, myr_amount, myr_rate, ledgers(name)')
                        .order('month', { ascending: false });
                    if (error) throw error;
                    data = allBudgets || [];

                    // 检查是否有ledger数据
                    const { data: ledgerData, error: ledgerError } = await supabase
                        .from('ledgers')
                        .select('id')
                        .eq('is_active', true)
                        .limit(1);
                    hasLedger = !ledgerError && ledgerData && ledgerData.length > 0;
                }
                
                const listContainer = document.getElementById('budget-list');
                listContainer.innerHTML = '';
                
                if (data.length === 0) {
                    showEmptyState('budget-list', 'budget', hasLedger);
                } else {
                    data.forEach(budget => {
                    const item = document.createElement('div');
                    item.className = 'ledger-item';
                    
                    const ledgerName = budget.ledgers ? budget.ledgers.name : 'Unknown';
                    const monthDisplay = new Date(budget.month + '-01').toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long' 
                    });
                    const amountDisplay = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: budget.currency
                    }).format(budget.amount);
                    
                    const multiCurrencyHtml = budget.sgd_amount ? `
                            <div class="info-row multi-currency-row">
                                <span class="info-label">Multi-Currency:</span>
                                <div class="multi-currency-display">
                                    <span class="currency-chip">SGD: <span class="currency-amount-html">${window.formatCurrency ? window.formatCurrency(budget.sgd_amount, 'SGD') : `S$${budget.sgd_amount.toFixed(2)}`}</span></span>
                                    <span class="currency-chip">CNY: <span class="currency-amount-html">${window.formatCurrency ? window.formatCurrency(budget.cny_amount, 'CNY') : `¥${budget.cny_amount.toFixed(2)}`}</span></span>
                                    <span class="currency-chip">USD: <span class="currency-amount-html">${window.formatCurrency ? window.formatCurrency(budget.usd_amount, 'USD') : `$${budget.usd_amount.toFixed(2)}`}</span></span>
                                    <span class="currency-chip">MYR: <span class="currency-amount-html">${window.formatCurrency ? window.formatCurrency(budget.myr_amount, 'MYR') : `RM${budget.myr_amount.toFixed(2)}`}</span></span>
                                </div>
                            </div>
                            ` : '';

                    item.innerHTML = `
                        <div class="ledger-header">
                            <div class="ledger-name">${ledgerName} - ${monthDisplay}</div>
                            <div class="ledger-actions">
                                <button class="icon-btn edit-btn" data-budget-id="${budget.id}" data-ledger-id="${budget.ledger_id}" data-month="${budget.month}" data-amount="${budget.amount}" data-currency="${budget.currency}" data-description="${budget.description || ''}" data-sgd-amount="${budget.sgd_amount || ''}" data-sgd-rate="${budget.sgd_rate || ''}" data-cny-amount="${budget.cny_amount || ''}" data-cny-rate="${budget.cny_rate || ''}" data-usd-amount="${budget.usd_amount || ''}" data-usd-rate="${budget.usd_rate || ''}" data-myr-amount="${budget.myr_amount || ''}" data-myr-rate="${budget.myr_rate || ''}">
                                    <img src="assets/svg/edit.svg?v=2" alt="Edit" width="16" height="16">
                                </button>
                                <button class="icon-btn delete-btn" data-budget-id="${budget.id}">
                                    <img src="assets/svg/delete.svg?v=2" alt="Delete" width="16" height="16">
                                </button>
                            </div>
                        </div>
                        <div class="ledger-info">
                            <div class="info-row">
                                <span class="info-label">Amount:</span>
                                <span class="info-value">${amountDisplay}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Currency:</span>
                                <span class="info-value">${budget.currency}</span>
                            </div>
                            ${budget.description ? `
                            <div class="info-row">
                                <span class="info-label">Description:</span>
                                <span class="info-value">${budget.description}</span>
                            </div>
                            ` : ''}
                            ${multiCurrencyHtml}
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
                
                    // 添加事件监听器
                    addBudgetEventListeners();
                }
            } catch (error) {
                console.error('Error loading budgets:', error);
            }
        }

        // 添加Budget事件监听器
        function addBudgetEventListeners() {
            // 编辑按钮事件监听器
            document.querySelectorAll('#budget-list .edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const budgetData = {
                        id: this.getAttribute('data-budget-id'),
                        ledgerId: this.getAttribute('data-ledger-id'),
                        month: this.getAttribute('data-month'),
                        amount: this.getAttribute('data-amount'),
                        currency: this.getAttribute('data-currency'),
                        description: this.getAttribute('data-description'),
                        sgd_amount: parseFloat(this.getAttribute('data-sgd-amount')) || 0,
                        sgd_rate: parseFloat(this.getAttribute('data-sgd-rate')) || 0,
                        cny_amount: parseFloat(this.getAttribute('data-cny-amount')) || 0,
                        cny_rate: parseFloat(this.getAttribute('data-cny-rate')) || 0,
                        usd_amount: parseFloat(this.getAttribute('data-usd-amount')) || 0,
                        usd_rate: parseFloat(this.getAttribute('data-usd-rate')) || 0,
                        myr_amount: parseFloat(this.getAttribute('data-myr-amount')) || 0,
                        myr_rate: parseFloat(this.getAttribute('data-myr-rate')) || 0
                    };
                    editBudget(budgetData);
                });
            });

            // 删除按钮事件监听器
            document.querySelectorAll('#budget-list .delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const budgetId = this.getAttribute('data-budget-id');
                    console.log('Delete button clicked for budget ID:', budgetId);
                    deleteBudget(budgetId);
                });
            });
        }

        // 获取汇率函数 - 基于预算月份
        async function getBudgetExchangeRate(fromCurrency, toCurrency, budgetMonth) {
            if (fromCurrency === toCurrency) return 1;

            try {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                const budgetYear = parseInt(budgetMonth.split('-')[0]);
                const budgetMonthNum = parseInt(budgetMonth.split('-')[1]);

                // 确定汇率获取日期
                let targetDate;
                if (budgetYear === currentYear && budgetMonthNum === currentMonth) {
                    // 情况A: 设置当月，使用今天的最新汇率
                    targetDate = new Date();
                } else if (budgetYear < currentYear || (budgetYear === currentYear && budgetMonthNum < currentMonth)) {
                    // 情况B: 设置过去月，使用该月最后一天的汇率
                    targetDate = new Date(budgetYear, budgetMonthNum, 0); // 获取该月最后一天
                } else {
                    // 情况C: 设置未来月，使用本月最新汇率
                    targetDate = new Date();
                }

                const targetDateStr = targetDate.getFullYear() + '-' + 
                    String(targetDate.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(targetDate.getDate()).padStart(2, '0');

                console.log(`Getting exchange rate for ${fromCurrency} to ${toCurrency} on ${targetDateStr} for budget month ${budgetMonth}`);

                // 1. 检查数据库中是否有目标日期的汇率
                const { data: dateRates, error: dateError } = await supabase
                    .from('exchange_rates')
                    .select('rate')
                    .eq('base_currency', fromCurrency)
                    .eq('target_currency', toCurrency)
                    .eq('local_date', targetDateStr)
                    .eq('local_date', targetDateStr)
                    .limit(1);

                if (dateRates && dateRates.length > 0) {
                    console.log('Found exact date rates in database');
                    return dateRates[0].rate;
                }

                // 2. 如果目标日期是今天，先检查数据库中是否已有今天的数据
                const today = new Date();
                const targetDateOnly = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                if (targetDateOnly.getTime() === todayOnly.getTime()) {
                    console.log('Target date is today, checking database first...');
                    
                    // 先检查数据库中是否已有今天的数据
                    const todayDateStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
                    
                    const { data: todayRates, error: todayError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .eq('local_date', todayDateStr)
                        .eq('local_date', todayDateStr)
                        .limit(1);

                    if (todayRates && todayRates.length > 0) {
                        console.log('Found today\'s rate in database, using it');
                        return todayRates[0].rate;
                    }

                    // 如果数据库中没有今天的数据，才调用API
                    console.log('No today\'s rate in database, calling API...');
                    const { data, error } = await supabase.functions.invoke('exchange-rate', {
                        body: { baseCurrency: fromCurrency }
                    });

                    if (error) {
                        console.error('Edge function error:', error);
                        throw error;
                    }

                    if (!data || !data.conversionRates) {
                        throw new Error('Invalid API response');
                    }

                    console.log('API response received, saving to database...');
                    // 保存汇率到数据库
                    const ratesToInsert = Object.keys(data.conversionRates).map(currency => ({
                        base_currency: fromCurrency,
                        target_currency: currency,
                        rate: data.conversionRates[currency]
                    }));

                    const { error: saveError } = await supabase
                        .from('exchange_rates')
                        .insert(ratesToInsert);

                    if (saveError) {
                        console.warn('Failed to save rates to database:', saveError);
                        // 如果是重复数据错误，忽略它
                        if (saveError.code === '23505') {
                            console.log('Rate already exists, continuing...');
                        }
                    }

                    return data.conversionRates[toCurrency] || 1;
                }

                // 3. 如果目标日期是过去某天且无数据，查找最近的历史汇率
                if (targetDateOnly < todayOnly) {
                    console.log('Target date is in the past, getting nearest historical rate...');
                    
                    // 先查找该月之前的最后一天
                    const { data: beforeRates, error: beforeError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .lt('local_date', targetDateStr)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (beforeRates && beforeRates.length > 0) {
                        return beforeRates[0].rate;
                    }

                    // 如果之前没有，查找该月之后的第一天
                    const { data: afterRates, error: afterError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .gt('created_at', targetDateStr + 'T23:59:59')
                        .order('created_at', { ascending: true })
                        .limit(1);

                    if (afterRates && afterRates.length > 0) {
                        return afterRates[0].rate;
                    }
                }

                // 4. 如果目标日期是未来某天，按今日处理
                if (targetDateOnly > todayOnly) {
                    console.log('Target date is in the future, treating as today...');
                    
                    // 先检查数据库中是否有今天的汇率
                    const todayDateStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
                    
                    const { data: todayRates, error: todayError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .eq('local_date', todayDateStr)
                        .limit(1);

                    if (todayRates && todayRates.length > 0) {
                        console.log('Found today\'s rate in database, using it for future date');
                        return todayRates[0].rate;
                    } else {
                        // 今天没有数据，调用API
                        console.log('No today\'s rate in database, calling API...');
                        const { data, error } = await supabase.functions.invoke('exchange-rate', {
                            body: { baseCurrency: fromCurrency }
                        });

                        if (error) {
                            console.error('Edge function error:', error);
                            throw error;
                        }

                        if (!data || !data.conversionRates) {
                            throw new Error('Invalid API response');
                        }

                        console.log('API response received, saving to database...');
                        const ratesToInsert = Object.keys(data.conversionRates).map(currency => ({
                            base_currency: fromCurrency,
                            target_currency: currency,
                            rate: data.conversionRates[currency]
                        }));

                        const { error: saveError } = await supabase
                            .from('exchange_rates')
                            .insert(ratesToInsert);

                        if (saveError) {
                            console.warn('Failed to save rates to database:', saveError);
                            // 如果是重复数据错误，忽略它
                            if (saveError.code === '23505') {
                                console.log('Rate already exists, continuing...');
                            }
                        }

                        return data.conversionRates[toCurrency] || 1;
                    }
                }

                // 5. 如果所有方法都失败，回退到硬编码汇率
                console.log('All methods failed, using hardcoded rates...');
                const rates = {
                    'SGD': { 'CNY': 5.30000, 'USD': 0.74000, 'MYR': 3.45000 },
                    'CNY': { 'SGD': 0.18868, 'USD': 0.13962, 'MYR': 0.65094 },
                    'USD': { 'SGD': 1.35135, 'CNY': 7.16216, 'MYR': 4.66216 },
                    'MYR': { 'SGD': 0.28986, 'CNY': 1.53623, 'USD': 0.21449 }
                };
                return rates[fromCurrency]?.[toCurrency] || 1;

            } catch (err) {
                console.error('Error in budget exchange rate function:', err);
                console.log('Falling back to hardcoded rates...');

                // 回退到硬编码汇率
                const rates = {
                    'SGD': { 'CNY': 5.30000, 'USD': 0.74000, 'MYR': 3.45000 },
                    'CNY': { 'SGD': 0.18868, 'USD': 0.13962, 'MYR': 0.65094 },
                    'USD': { 'SGD': 1.35135, 'CNY': 7.16216, 'MYR': 4.66216 },
                    'MYR': { 'SGD': 0.28986, 'CNY': 1.53623, 'USD': 0.21449 }
                };
                return rates[fromCurrency]?.[toCurrency] || 1;
            }
        }

        // 格式化货币
        function formatCurrency(amount, currency) {
            const currencySymbols = {
                'SGD': 'S$',
                'USD': '$',
                'CNY': '¥',
                'MYR': 'RM'
            };
            
            const symbol = currencySymbols[currency] || currency;
            const sign = (Number(amount) < 0) ? '-' : '';
            const formattedAmount = formatCompactWithTitle(Math.abs(Number(amount) || 0));
            return `${sign}${symbol}${formattedAmount}`;
        }

        // 将formatCurrency函数设为全局可用
        window.formatCurrency = formatCurrency;

        // 显示数据库中已存储的多币种数据（编辑时使用）
        function displayStoredMultiCurrencyData(budgetData) {
            const amount = parseFloat(budgetData.amount) || 0;
            const currency = budgetData.currency;

            if (!amount || !currency) {
                // 显示0占位符
                document.getElementById('sgd-amount').innerHTML = 'S$0.00';
                document.getElementById('sgd-rate').textContent = 'Rate: 1.0000';
                document.getElementById('cny-amount').innerHTML = '¥0.00';
                document.getElementById('cny-rate').textContent = 'Rate: 0.0000';
                document.getElementById('usd-amount').innerHTML = '$0.00';
                document.getElementById('usd-rate').textContent = 'Rate: 0.0000';
                document.getElementById('myr-amount').innerHTML = 'RM0.00';
                document.getElementById('myr-rate').textContent = 'Rate: 0.0000';
                return;
            }

            try {
                // 使用数据库中已存储的汇率数据
                const sgdAmount = budgetData.sgd_amount || 0;
                const cnyAmount = budgetData.cny_amount || 0;
                const usdAmount = budgetData.usd_amount || 0;
                const myrAmount = budgetData.myr_amount || 0;
                
                const sgdRate = budgetData.sgd_rate || 0;
                const cnyRate = budgetData.cny_rate || 0;
                const usdRate = budgetData.usd_rate || 0;
                const myrRate = budgetData.myr_rate || 0;

                // 更新显示
                document.getElementById('sgd-amount').innerHTML = formatCurrency(sgdAmount, 'SGD');
                document.getElementById('sgd-rate').textContent = `Rate: ${sgdRate.toFixed(4)}`;
                document.getElementById('cny-amount').innerHTML = formatCurrency(cnyAmount, 'CNY');
                document.getElementById('cny-rate').textContent = `Rate: ${cnyRate.toFixed(4)}`;
                document.getElementById('usd-amount').innerHTML = formatCurrency(usdAmount, 'USD');
                document.getElementById('usd-rate').textContent = `Rate: ${usdRate.toFixed(4)}`;
                document.getElementById('myr-amount').innerHTML = formatCurrency(myrAmount, 'MYR');
                document.getElementById('myr-rate').textContent = `Rate: ${myrRate.toFixed(4)}`;

                // 高亮当前选择的货币
                document.querySelectorAll('.currency-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
                document.getElementById(`${currency.toLowerCase()}-display`).classList.add('highlighted');

                // 显示多币种区域（已经是默认显示）

            } catch (error) {
                console.error('Error displaying stored multi-currency data:', error);
                // 显示0占位符
                document.getElementById('sgd-amount').innerHTML = 'S$0.00';
                document.getElementById('sgd-rate').textContent = 'Rate: 1.0000';
                document.getElementById('cny-amount').innerHTML = '¥0.00';
                document.getElementById('cny-rate').textContent = 'Rate: 0.0000';
                document.getElementById('usd-amount').innerHTML = '$0.00';
                document.getElementById('usd-rate').textContent = 'Rate: 0.0000';
                document.getElementById('myr-amount').innerHTML = 'RM0.00';
                document.getElementById('myr-rate').textContent = 'Rate: 0.0000';
            }
        }

        // 一次性获取所有汇率
        async function getAllExchangeRates(fromCurrency, month) {
            const allCurrencies = ['SGD', 'CNY', 'USD', 'MYR'];
            const targetCurrencies = allCurrencies.filter(c => c !== fromCurrency);
            const rates = {};
            
            // 设置基础货币的汇率为1
            rates[fromCurrency] = 1.0;
            
            // 获取目标日期和当前月份
            const targetDate = new Date(month + '-01');
            const today = new Date();
            const targetDateOnly = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            // 判断是否是当月
            const isCurrentMonth = targetDate.getFullYear() === today.getFullYear() && 
                                 targetDate.getMonth() === today.getMonth();
            
            console.log(`Getting all exchange rates for ${fromCurrency} on ${targetDate.toISOString().split('T')[0]} for budget month ${month} (isCurrentMonth: ${isCurrentMonth})`);
            
            // 1. 如果是当月，使用今天的汇率
            if (isCurrentMonth) {
                console.log('Current month budget, using today\'s rates...');
                
                const todayDateStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');
                
                // 检查数据库中是否已有今天的所有汇率数据
                // 使用本地时间进行查询，确保时区一致性
                const todayLocal = new Date();
                const todayLocalStr = todayLocal.getFullYear() + '-' +
                    String(todayLocal.getMonth() + 1).padStart(2, '0') + '-' +
                    String(todayLocal.getDate()).padStart(2, '0');
                
                console.log(`Debug - fromCurrency: ${fromCurrency}, targetCurrencies: ${targetCurrencies}, todayLocalStr: ${todayLocalStr}`);
                
                const { data: todayRates, error: todayError } = await supabase
                    .from('exchange_rates')
                    .select('target_currency, rate')
                    .eq('base_currency', fromCurrency)
                    .in('target_currency', targetCurrencies)
                    .eq('local_date', todayLocalStr)
                    .eq('local_date', todayLocalStr)
                    .order('created_at', { ascending: false });
                
                console.log(`Debug - todayRates found: ${todayRates ? todayRates.length : 0}, targetCurrencies length: ${targetCurrencies.length}`);
                if (todayRates && todayRates.length > 0) {
                    console.log(`Debug - todayRates details:`, todayRates.map(r => `${r.target_currency}:${r.rate}`));
                }
                
                if (todayRates && todayRates.length >= targetCurrencies.length) {
                    console.log('Found today\'s rates in database, using them');
                    // 为每个目标货币找到最新的汇率
                    targetCurrencies.forEach(targetCurrency => {
                        const currencyRate = todayRates.find(rate => rate.target_currency === targetCurrency);
                        if (currencyRate) {
                            rates[targetCurrency] = currencyRate.rate;
                        }
                    });
                    // 确保所有货币都有汇率
                    allCurrencies.forEach(currency => {
                        if (!rates[currency]) {
                            rates[currency] = 1.0;
                        }
                    });
                    return rates;
                }
                
                // 如果数据库中没有完整的数据，调用API
                console.log(`Debug - API call reason: todayRates.length=${todayRates ? todayRates.length : 0}, targetCurrencies.length=${targetCurrencies.length}`);
                console.log('No complete today\'s rates in database, calling API for current month...');
                const { data, error } = await supabase.functions.invoke('exchange-rate', {
                    body: { baseCurrency: fromCurrency }
                });
                
                if (error) {
                    console.error('Error calling exchange rate API:', error);
                    // 使用硬编码的汇率作为后备
                    const fallbackRates = {
                        'SGD': 1.0,
                        'CNY': 5.5841,
                        'USD': 0.7786,
                        'MYR': 3.2802
                    };
                    targetCurrencies.forEach(c => {
                        if (!rates[c]) {
                            rates[c] = fallbackRates[c] || 1.0;
                        }
                    });
                    return rates;
                }
                
                console.log('API response received, saving to database...');
                console.log('API response data:', data);
                
                // 检查API响应格式
                if (!data || !data.conversionRates) {
                    console.error('Invalid API response format:', data);
                    throw new Error('Invalid API response format');
                }
                
                // 保存所有货币组合的汇率到数据库
                const ratesToInsert = [];
                
                // 为每个货币作为baseCurrency，保存到其他货币的汇率
                for (const baseCurrency of allCurrencies) {
                    for (const targetCurrency of allCurrencies) {
                        if (baseCurrency !== targetCurrency) {
                            let rate;
                            
                            if (baseCurrency === fromCurrency) {
                                // 当前选择的货币，使用API返回的汇率
                                rate = data.conversionRates[targetCurrency];
                            } else if (targetCurrency === fromCurrency) {
                                // 目标货币是当前选择的货币，计算反向汇率
                                rate = 1 / data.conversionRates[baseCurrency];
                            } else {
                                // 其他货币组合，通过当前货币计算交叉汇率
                                const rateToBase = data.conversionRates[baseCurrency];
                                const rateToTarget = data.conversionRates[targetCurrency];
                                rate = rateToTarget / rateToBase;
                            }
                            
                            // 限制数值精度，避免溢出
                            const limitedRate = Math.min(Math.max(parseFloat(rate), 0.000001), 999999.99999999);
                            
                            ratesToInsert.push({
                                base_currency: baseCurrency,
                                target_currency: targetCurrency,
                                rate: limitedRate,
                                local_date: todayLocalStr
                            });
                        }
                    }
                }
                
                console.log('Rates to insert:', ratesToInsert);
                
                try {
                    const { data: insertResult, error: insertError } = await supabase.from('exchange_rates').insert(ratesToInsert);
                    if (insertError) {
                        throw insertError;
                    }
                    console.log('All rates saved to database successfully');
                    console.log('Insert result:', insertResult);
                } catch (insertError) {
                    if (insertError.code === '23505') {
                        console.log('Some rates already exist, continuing...');
                    } else {
                        console.error('Error saving rates to database:', insertError);
                        console.error('Error details:', {
                            code: insertError.code,
                            message: insertError.message,
                            details: insertError.details,
                            hint: insertError.hint
                        });
                    }
                }
                
                // 设置汇率
                for (const [targetCurrency, rate] of Object.entries(data.conversionRates)) {
                    if (targetCurrency !== fromCurrency) {
                        const limitedRate = Math.min(Math.max(parseFloat(rate), 0.000001), 999999.99999999);
                        rates[targetCurrency] = limitedRate;
                    }
                }
                
                // 确保所有货币都有汇率
                allCurrencies.forEach(currency => {
                    if (!rates[currency]) {
                        rates[currency] = 1.0;
                    }
                });
                
                return rates;
            }
            
            // 2. 如果是过去的月份，取该月最后一天的汇率
            if (!isCurrentMonth && targetDateOnly < todayOnly) {
                console.log('Past month budget, getting last day of month rate...');
                
                const lastDayOfMonth = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);
                const lastDayStr = lastDayOfMonth.getFullYear() + '-' +
                    String(lastDayOfMonth.getMonth() + 1).padStart(2, '0') + '-' +
                    String(lastDayOfMonth.getDate()).padStart(2, '0');
                
                // 查找该月最后一天的汇率
                const { data: lastDayRates, error: lastDayError } = await supabase
                    .from('exchange_rates')
                    .select('target_currency, rate')
                    .eq('base_currency', fromCurrency)
                    .in('target_currency', targetCurrencies)
                    .gte('local_date', month + '-01')
                    .lte('local_date', lastDayStr)
                    .order('local_date', { ascending: false })
                    .limit(targetCurrencies.length);
                
                if (lastDayRates && lastDayRates.length === targetCurrencies.length) {
                    console.log('Found last day of month rates, using them');
                    lastDayRates.forEach(rate => {
                        rates[rate.target_currency] = rate.rate;
                    });
                    // 确保所有货币都有汇率
                    allCurrencies.forEach(currency => {
                        if (!rates[currency]) {
                            rates[currency] = 1.0;
                        }
                    });
                    return rates;
                }
                
                // 如果没有该月最后一天的数据，查找该月之前的最新汇率
                const { data: beforeRates, error: beforeError } = await supabase
                    .from('exchange_rates')
                    .select('target_currency, rate')
                    .eq('base_currency', fromCurrency)
                    .in('target_currency', targetCurrencies)
                    .lt('local_date', month + '-01')
                    .order('local_date', { ascending: false })
                    .limit(targetCurrencies.length);
                
                if (beforeRates && beforeRates.length > 0) {
                    console.log('Found rates before target month, using latest ones');
                    // 为每个目标货币设置对应的汇率
                    beforeRates.forEach(rate => {
                        rates[rate.target_currency] = rate.rate;
                    });
                }
                
                // 如果该月之前没有数据，查找该月之后的第一天有数据的汇率
                if (!beforeRates || beforeRates.length === 0) {
                    console.log('No rates found before target month, trying after...');
                    const { data: afterRates, error: afterError } = await supabase
                        .from('exchange_rates')
                        .select('target_currency, rate')
                        .eq('base_currency', fromCurrency)
                        .in('target_currency', targetCurrencies)
                        .gt('local_date', lastDayStr)
                        .order('local_date', { ascending: true })
                        .limit(targetCurrencies.length);
                    
                    if (afterRates && afterRates.length > 0) {
                        console.log('Found rates after target month, using earliest ones');
                        // 为每个目标货币设置对应的汇率
                        afterRates.forEach(rate => {
                            rates[rate.target_currency] = rate.rate;
                        });
                    }
                }
                
                // 如果还是没有，使用硬编码汇率
                const fallbackRates = {
                    'SGD': 1.0,
                    'CNY': 5.5841,
                    'USD': 0.7786,
                    'MYR': 3.2802
                };
                
                targetCurrencies.forEach(targetCurrency => {
                    if (!rates[targetCurrency]) {
                        rates[targetCurrency] = fallbackRates[targetCurrency] || 1.0;
                    }
                });
                
                // 确保所有货币都有汇率
                allCurrencies.forEach(currency => {
                    if (!rates[currency]) {
                        rates[currency] = 1.0;
                    }
                });
                
                return rates;
            }
            
            // 3. 如果是未来的月份，按本月处理
            if (!isCurrentMonth && targetDateOnly > todayOnly) {
                console.log('Future month budget, treating as current month...');
                
                const todayDateStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');
                
                // 先检查数据库中是否有今天的汇率数据
                const todayLocal = new Date();
                const todayLocalStr = todayLocal.getFullYear() + '-' +
                    String(todayLocal.getMonth() + 1).padStart(2, '0') + '-' +
                    String(todayLocal.getDate()).padStart(2, '0');
                
                const { data: todayRates, error: todayError } = await supabase
                    .from('exchange_rates')
                    .select('target_currency, rate')
                    .eq('base_currency', fromCurrency)
                    .in('target_currency', targetCurrencies)
                    .eq('local_date', todayLocalStr);
                
                if (todayRates && todayRates.length === targetCurrencies.length) {
                    console.log('Found today\'s rates in database, using them for future month');
                    todayRates.forEach(rate => {
                        rates[rate.target_currency] = rate.rate;
                    });
                    // 确保所有货币都有汇率
                    allCurrencies.forEach(currency => {
                        if (!rates[currency]) {
                            rates[currency] = 1.0;
                        }
                    });
                    return rates;
                } else {
                    // 今天没有数据，调用API
                    console.log('No today\'s rates found, calling API...');
                    const { data, error } = await supabase.functions.invoke('exchange-rate', {
                        body: { baseCurrency: fromCurrency }
                    });
                    
                    if (error) {
                        console.error('Error calling exchange rate API:', error);
                        const fallbackRates = {
                            'SGD': 1.0,
                            'CNY': 5.5841,
                            'USD': 0.7786,
                            'MYR': 3.2802
                        };
                        targetCurrencies.forEach(c => {
                            if (!rates[c]) {
                                rates[c] = fallbackRates[c] || 1.0;
                            }
                        });
                        return rates;
                    }
                    
                    // 检查API响应格式
                    if (!data || !data.conversionRates) {
                        console.error('Invalid API response format:', data);
                        const fallbackRates = {
                            'SGD': 1.0,
                            'CNY': 5.5841,
                            'USD': 0.7786,
                            'MYR': 3.2802
                        };
                        targetCurrencies.forEach(c => {
                            if (!rates[c]) {
                                rates[c] = fallbackRates[c] || 1.0;
                            }
                        });
                        return rates;
                    }
                    
                    // 保存汇率到数据库
                    const ratesToInsert = [];
                    for (const [targetCurrency, rate] of Object.entries(data.conversionRates)) {
                        if (targetCurrency !== fromCurrency) {
                            // 限制数值精度，避免溢出
                            const limitedRate = Math.min(Math.max(parseFloat(rate), 0.000001), 999999.99999999);
                            
                            ratesToInsert.push({
                                base_currency: fromCurrency,
                                target_currency: targetCurrency,
                                rate: limitedRate,
                                local_date: todayLocalStr
                            });
                        }
                    }
                    
                    console.log('Future month - Rates to insert:', ratesToInsert);
                    
                    try {
                        const { data: insertResult, error: insertError } = await supabase.from('exchange_rates').insert(ratesToInsert);
                        if (insertError) {
                            throw insertError;
                        }
                        console.log('Future month - Rates saved successfully');
                    } catch (insertError) {
                        if (insertError.code === '23505') {
                            console.log('Some rates already exist, continuing...');
                        } else {
                            console.error('Error saving rates to database:', insertError);
                            console.error('Error details:', {
                                code: insertError.code,
                                message: insertError.message,
                                details: insertError.details,
                                hint: insertError.hint
                            });
                        }
                    }
                    
                    for (const [targetCurrency, rate] of Object.entries(data.conversionRates)) {
                        if (targetCurrency !== fromCurrency) {
                            const limitedRate = Math.min(Math.max(parseFloat(rate), 0.000001), 999999.99999999);
                            rates[targetCurrency] = limitedRate;
                        }
                    }
                    
                    // 确保所有货币都有汇率
                    allCurrencies.forEach(currency => {
                        if (!rates[currency]) {
                            rates[currency] = 1.0;
                        }
                    });
                    
                    return rates;
                }
            }
            
            // 默认返回硬编码汇率
            const fallbackRates = {
                'SGD': 1.0,
                'CNY': 5.5841,
                'USD': 0.7786,
                'MYR': 3.2802
            };
            
            targetCurrencies.forEach(targetCurrency => {
                if (!rates[targetCurrency]) {
                    rates[targetCurrency] = fallbackRates[targetCurrency] || 1.0;
                }
            });
            
            // 确保所有货币都有汇率
            allCurrencies.forEach(currency => {
                if (!rates[currency]) {
                    rates[currency] = 1.0;
                }
            });
            
            return rates;
        }

        // 更新 recurring bills 多币种显示
        async function updateRecurringMultiCurrencyDisplay() {
            const amount = parseFloat(document.getElementById('recurring-amount').value) || 0;
            const currency = document.getElementById('recurring-currency').value;
            const anchorDate = document.getElementById('recurring-anchor').value;

            if (!amount || !currency || !anchorDate) {
                // 显示0占位符
                document.getElementById('recurring-sgd-amount').innerHTML = 'S$0.00';
                document.getElementById('recurring-sgd-rate').textContent = 'Rate: 1.0000';
                document.getElementById('recurring-cny-amount').innerHTML = '¥0.00';
                document.getElementById('recurring-cny-rate').textContent = 'Rate: 0.0000';
                document.getElementById('recurring-usd-amount').innerHTML = '$0.00';
                document.getElementById('recurring-usd-rate').textContent = 'Rate: 0.0000';
                document.getElementById('recurring-myr-amount').innerHTML = 'RM0.00';
                document.getElementById('recurring-myr-rate').textContent = 'Rate: 0.0000';
                return;
            }

            try {
                // 从 anchor date 提取月份用于汇率查询
                const month = new Date(anchorDate).toISOString().slice(0, 7); // YYYY-MM
                
                // 检查缓存键
                const cacheKey = `recurring_${currency}_${month}`;
                
                // 只在页面加载时获取汇率，后续只更新显示
                if (!window.recurringExchangeRatesLoaded || window.recurringExchangeRatesCacheKey !== cacheKey) {
                    console.log('Loading exchange rates for recurring bill...');
                    // 一次性获取所有汇率
                    const allRates = await getAllExchangeRates(currency, month);
                    
                    // 缓存汇率数据
                    window.recurringExchangeRates = allRates;
                    window.recurringExchangeRatesLoaded = true;
                    window.recurringExchangeRatesCacheKey = cacheKey;
                } else {
                    console.log('Using cached exchange rates for recurring bill...');
                }
                
                // 使用缓存的汇率数据
                const allRates = window.recurringExchangeRates;
                
                // 确保所有汇率都存在
                if (!allRates || !allRates.SGD || !allRates.CNY || !allRates.USD || !allRates.MYR) {
                    throw new Error('Incomplete exchange rates data');
                }
                
                // 计算转换后的金额
                const sgdAmount = currency === 'SGD' ? amount : (amount * allRates.SGD);
                const cnyAmount = currency === 'CNY' ? amount : (amount * allRates.CNY);
                const usdAmount = currency === 'USD' ? amount : (amount * allRates.USD);
                const myrAmount = currency === 'MYR' ? amount : (amount * allRates.MYR);

                // 更新显示
                document.getElementById('recurring-sgd-amount').innerHTML = formatCurrency(sgdAmount, 'SGD');
                document.getElementById('recurring-sgd-rate').textContent = `Rate: ${allRates.SGD.toFixed(4)}`;
                document.getElementById('recurring-cny-amount').innerHTML = formatCurrency(cnyAmount, 'CNY');
                document.getElementById('recurring-cny-rate').textContent = `Rate: ${allRates.CNY.toFixed(4)}`;
                document.getElementById('recurring-usd-amount').innerHTML = formatCurrency(usdAmount, 'USD');
                document.getElementById('recurring-usd-rate').textContent = `Rate: ${allRates.USD.toFixed(4)}`;
                document.getElementById('recurring-myr-amount').innerHTML = formatCurrency(myrAmount, 'MYR');
                document.getElementById('recurring-myr-rate').textContent = `Rate: ${allRates.MYR.toFixed(4)}`;

                // 高亮当前选择的货币
                document.querySelectorAll('#recurring-multi-currency-section .currency-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
                document.getElementById(`recurring-${currency.toLowerCase()}-display`).classList.add('highlighted');

            } catch (error) {
                console.error('Error updating recurring multi-currency display:', error);
                // 显示0占位符
                document.getElementById('recurring-sgd-amount').innerHTML = 'S$0.00';
                document.getElementById('recurring-sgd-rate').textContent = 'Rate: 1.0000';
                document.getElementById('recurring-cny-amount').innerHTML = '¥0.00';
                document.getElementById('recurring-cny-rate').textContent = 'Rate: 0.0000';
                document.getElementById('recurring-usd-amount').innerHTML = '$0.00';
                document.getElementById('recurring-usd-rate').textContent = 'Rate: 0.0000';
                document.getElementById('recurring-myr-amount').innerHTML = 'RM0.00';
                document.getElementById('recurring-myr-rate').textContent = 'Rate: 0.0000';
            }
        }

        // 更新多币种显示（新建或修改时使用）
        async function updateMultiCurrencyDisplay() {
            const amount = parseFloat(document.getElementById('budget-amount').value) || 0;
            const currency = document.getElementById('budget-currency').value;
            const month = document.getElementById('budget-month').value;

            if (!amount || !currency || !month) {
                // 显示0占位符
                document.getElementById('sgd-amount').innerHTML = 'S$0.00';
                document.getElementById('sgd-rate').textContent = 'Rate: 1.0000';
                document.getElementById('cny-amount').innerHTML = '¥0.00';
                document.getElementById('cny-rate').textContent = 'Rate: 0.0000';
                document.getElementById('usd-amount').innerHTML = '$0.00';
                document.getElementById('usd-rate').textContent = 'Rate: 0.0000';
                document.getElementById('myr-amount').innerHTML = 'RM0.00';
                document.getElementById('myr-rate').textContent = 'Rate: 0.0000';
                return;
            }

            try {
                // 检查缓存键
                const cacheKey = `${currency}_${month}`;
                
                // 只在页面加载时获取汇率，后续只更新显示
                if (!window.budgetExchangeRatesLoaded || window.budgetExchangeRatesCacheKey !== cacheKey) {
                    console.log('Loading exchange rates for budget...');
                    // 一次性获取所有汇率
                    const allRates = await getAllExchangeRates(currency, month);
                    
                    // 缓存汇率数据
                    window.budgetExchangeRates = allRates;
                    window.budgetExchangeRatesLoaded = true;
                    window.budgetExchangeRatesCacheKey = cacheKey;
                } else {
                    console.log('Using cached exchange rates for budget...');
                }
                
                // 使用缓存的汇率数据
                const allRates = window.budgetExchangeRates;
                
                // 确保所有汇率都存在
                if (!allRates || !allRates.SGD || !allRates.CNY || !allRates.USD || !allRates.MYR) {
                    throw new Error('Incomplete exchange rates data');
                }
                
                // 计算转换后的金额
                const sgdAmount = currency === 'SGD' ? amount : (amount * allRates.SGD);
                const cnyAmount = currency === 'CNY' ? amount : (amount * allRates.CNY);
                const usdAmount = currency === 'USD' ? amount : (amount * allRates.USD);
                const myrAmount = currency === 'MYR' ? amount : (amount * allRates.MYR);

                // 更新显示
                document.getElementById('sgd-amount').innerHTML = formatCurrency(sgdAmount, 'SGD');
                document.getElementById('sgd-rate').textContent = `Rate: ${allRates.SGD.toFixed(4)}`;
                document.getElementById('cny-amount').innerHTML = formatCurrency(cnyAmount, 'CNY');
                document.getElementById('cny-rate').textContent = `Rate: ${allRates.CNY.toFixed(4)}`;
                document.getElementById('usd-amount').innerHTML = formatCurrency(usdAmount, 'USD');
                document.getElementById('usd-rate').textContent = `Rate: ${allRates.USD.toFixed(4)}`;
                document.getElementById('myr-amount').innerHTML = formatCurrency(myrAmount, 'MYR');
                document.getElementById('myr-rate').textContent = `Rate: ${allRates.MYR.toFixed(4)}`;

                // 高亮当前选择的货币
                document.querySelectorAll('.currency-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
                document.getElementById(`${currency.toLowerCase()}-display`).classList.add('highlighted');

                // 显示多币种区域（已经是默认显示）

            } catch (error) {
                console.error('Error updating multi-currency display:', error);
                // 显示0占位符
                document.getElementById('sgd-amount').innerHTML = 'S$0.00';
                document.getElementById('sgd-rate').textContent = 'Rate: 1.0000';
                document.getElementById('cny-amount').innerHTML = '¥0.00';
                document.getElementById('cny-rate').textContent = 'Rate: 0.0000';
                document.getElementById('usd-amount').innerHTML = '$0.00';
                document.getElementById('usd-rate').textContent = 'Rate: 0.0000';
                document.getElementById('myr-amount').innerHTML = 'RM0.00';
                document.getElementById('myr-rate').textContent = 'Rate: 0.0000';
                
                // 如果是因为formatCompactWithTitle未定义，使用简单的数字格式化
                if (error.message.includes('formatCompactWithTitle is not defined')) {
                    console.log('Using fallback number formatting...');
                    const simpleFormatCurrency = (amount, currency) => {
                        const currencySymbols = {
                            'SGD': 'S$',
                            'USD': '$',
                            'CNY': '¥',
                            'MYR': 'RM'
                        };
                        const symbol = currencySymbols[currency] || currency;
                        return `${symbol}${Math.abs(amount).toFixed(2)}`;
                    };
                    
                    // 重新尝试更新显示
                    try {
                        document.getElementById('sgd-amount').textContent = simpleFormatCurrency(sgdAmount, 'SGD');
                        document.getElementById('cny-amount').textContent = simpleFormatCurrency(cnyAmount, 'CNY');
                        document.getElementById('usd-amount').textContent = simpleFormatCurrency(usdAmount, 'USD');
                        document.getElementById('myr-amount').textContent = simpleFormatCurrency(myrAmount, 'MYR');
                        document.getElementById('multi-currency-section').style.display = 'block';
                    } catch (fallbackError) {
                        console.error('Fallback formatting also failed:', fallbackError);
                    }
                }
            }
        }

        // 保存Budget
        async function saveBudget() {
            const ledgerId = document.getElementById('budget-ledger').value;
            const month = document.getElementById('budget-month').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            const currency = document.getElementById('budget-currency').value;
            const description = document.getElementById('budget-description').value.trim();
            
            if (!ledgerId || !month || !amount || !currency) {
                await showCustomAlert('Validation Error', 'Please fill in all required fields.');
                return;
            }
            
            if (amount <= 0) {
                await showCustomAlert('Validation Error', 'Budget amount must be greater than 0.');
                return;
            }
            
            try {
                // 检查是否需要更新汇率（新建或修改了关键字段）
                let needUpdateRates = !currentEditingBudget; // 新建时需要更新汇率
                
                if (currentEditingBudget) {
                    // 编辑时，检查是否修改了关键字段
                    const originalBudget = await supabase
                        .from('budgets')
                        .select('month, amount, currency')
                        .eq('id', currentEditingBudget)
                        .single();
                    
                    if (originalBudget.data) {
                        const original = originalBudget.data;
                        needUpdateRates = (original.month !== month || 
                                         original.amount !== amount || 
                                         original.currency !== currency);
                        
                        if (needUpdateRates) {
                            console.log('Key fields changed, updating exchange rates...');
                        } else {
                            console.log('No key fields changed, keeping existing exchange rates');
                        }
                    }
                }

                // 如果需要更新汇率，获取汇率并计算多币种金额
                let budgetData = {
                    ledger_id: ledgerId,
                    month: month,
                    amount: amount,
                    currency: currency,
                    description: description || null
                };

                if (needUpdateRates) {
                    console.log('Updating exchange rates for budget...');
                    
                                    // 直接使用已经缓存的汇率数据
                const allRates = window.budgetExchangeRates;
                
                // 如果没有缓存数据，才获取汇率
                if (!allRates || !allRates.SGD || !allRates.CNY || !allRates.USD || !allRates.MYR) {
                    console.log('No cached rates found, getting exchange rates...');
                    const fetchedRates = await getAllExchangeRates(currency, month);
                    window.budgetExchangeRates = fetchedRates;
                    allRates = fetchedRates;
                } else {
                    console.log('Using cached exchange rates for budget save...');
                }
                    
                    // 计算多币种金额
                    const sgdAmount = currency === 'SGD' ? amount : (amount * allRates.SGD);
                    const cnyAmount = currency === 'CNY' ? amount : (amount * allRates.CNY);
                    const usdAmount = currency === 'USD' ? amount : (amount * allRates.USD);
                    const myrAmount = currency === 'MYR' ? amount : (amount * allRates.MYR);

                    // 添加到budget数据中
                    budgetData = {
                        ...budgetData,
                        sgd_amount: sgdAmount,
                        sgd_rate: allRates.SGD,
                        cny_amount: cnyAmount,
                        cny_rate: allRates.CNY,
                        usd_amount: usdAmount,
                        usd_rate: allRates.USD,
                        myr_amount: myrAmount,
                        myr_rate: allRates.MYR
                    };
                }
                
                if (currentEditingBudget) {
                    // 更新现有Budget
                    const { error } = await supabase
                        .from('budgets')
                        .update(budgetData)
                        .eq('id', currentEditingBudget);
                    
                    if (error) throw error;
                } else {
                    // 创建新Budget
                    const { error } = await supabase
                        .from('budgets')
                        .insert([budgetData]);
                    
                    if (error) throw error;
                }
                
                hideBudgetForm();
                loadBudgetsList();
            } catch (error) {
                console.error('Error saving budget:', error);
                
                let errorMessage = 'Failed to save budget. Please try again.';
                
                // 检查是否是重复预算错误
                if (error.code === '23505' && error.message.includes('budgets_ledger_month_key')) {
                    errorMessage = `A budget for this ledger and month already exists. Please choose a different month or edit the existing budget.`;
                } else if (error.code === '23505') {
                    errorMessage = 'This budget already exists. Please choose a different month.';
                } else if (error.message) {
                    // 显示具体的错误信息
                    errorMessage = `Error: ${error.message}`;
                }
                
                await showCustomAlert('Error', errorMessage);
            }
        }

        // ==================== 钱包管理功能 ====================
        
        // 全局变量
        let currentEditingWallet = null;
        let isEditingWallet = false;
        let isViewingArchived = false;

        // 钱包汇率函数 - 使用当前汇率（不需要月份参数）
        function getWalletExchangeRate(fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return 1;
            
            // 使用简单的汇率映射（基于当前汇率）
            const exchangeRates = {
                'SGD': { 'CNY': 5.4, 'USD': 0.74, 'MYR': 3.5 },
                'CNY': { 'SGD': 0.185, 'USD': 0.137, 'MYR': 0.648 },
                'USD': { 'SGD': 1.35, 'CNY': 7.3, 'MYR': 4.73 },
                'MYR': { 'SGD': 0.286, 'CNY': 1.54, 'USD': 0.211 }
            };
            
            return exchangeRates[fromCurrency]?.[toCurrency] || 1;
        }

        // 显示添加钱包表单
        function showAddWalletForm() {
            isEditingWallet = false;
            currentEditingWallet = null;
            
            // 重置表单
            document.getElementById('wallet-form').reset();
            document.getElementById('wallet-form-title').textContent = 'Add New Wallet';
            document.getElementById('wallet-owner-group').style.display = 'none';
            
            // 加载用户选项
            loadWalletUserOptions();
            
            // 重置多币种显示
            resetWalletMultiCurrencyDisplay();
            
            // 显示表单
            document.getElementById('wallet-form-overlay').classList.add('show');
        }

        // 隐藏钱包表单
        function hideWalletForm() {
            document.getElementById('wallet-form-overlay').classList.remove('show');
            isEditingWallet = false;
            currentEditingWallet = null;
        }

        // 加载钱包用户选项
        async function loadWalletUserOptions() {
            try {
                const { data: users, error } = await supabase
                    .from('allowed_users')
                    .select('id, display_name, email')
                    .order('display_name');
                
                if (error) throw error;
                
                const ownerSelect = document.getElementById('wallet-owner');
                ownerSelect.innerHTML = '<option value="">Select Owner</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.display_name || user.email;
                    ownerSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading wallet user options:', error);
            }
        }

        // 加载钱包列表（支持访问控制）
        async function loadWalletsList() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let wallets = [];

                if (useAccessControl) {
                    const currentUser = await getCurrentUserInfo();
                    if (!currentUser) {
                        console.error('Current user not found for access control.');
                        throw new Error('Current user not found.');
                    }
                    const currentUserId = currentUser.id;

                    // 获取用户有权限的钱包
                    const { data: personalWallets, error: personalError } = await supabase
                        .from('wallets')
                        .select('*')
                        .eq('wallet_type', 'personal')
                        .eq('owner_id', currentUserId)
                        .eq('is_archived', false);
                    if (personalError) throw personalError;

                    const { data: sharedWallets, error: sharedError } = await supabase
                        .from('wallets')
                        .select('*, wallet_members!inner(user_id)')
                        .eq('wallet_type', 'shared')
                        .eq('wallet_members.user_id', currentUserId)
                        .eq('is_archived', false);
                    if (sharedError) throw sharedError;

                    wallets = [...(personalWallets || []), ...(sharedWallets || [])]
                        .sort((a, b) => (a.wallet_type === b.wallet_type ? a.name.localeCompare(b.name) : (a.wallet_type === 'shared' ? -1 : 1)));

                    // 无权限时显示空状态（不再回退显示全部）
                    if (wallets.length === 0) {
                        console.log('用户无钱包权限，显示空状态');
                    }
                } else {
                    // 访问控制未启用，加载所有钱包
                    const { data: allWallets, error: allError } = await supabase
                        .from('wallets')
                        .select('*')
                        .eq('is_archived', false)
                        .order('wallet_type', { ascending: false })
                        .order('name');
                    if (allError) throw allError;
                    wallets = allWallets || [];
                }

                // 获取用户数据
                const { data: users, error: userError } = await supabase
                    .from('allowed_users')
                    .select('id, display_name, email');
                
                if (userError) throw userError;
                
                const userMap = {};
                users.forEach(user => {
                    userMap[user.id] = user.display_name || user.email;
                });
                
                displayWalletsList(wallets, userMap);
                
            } catch (error) {
                console.error('Error loading wallets:', error);
                await showCustomAlert('Error', 'Failed to load wallets: ' + error.message);
            }
        }

        // 显示钱包列表
        function displayWalletsList(wallets, userMap) {
            const walletList = document.getElementById('wallet-list');
            walletList.innerHTML = '';
            
            if (wallets.length === 0) {
                showEmptyState('wallet-list', 'wallet');
            } else {
                wallets.forEach(wallet => {
                const walletItem = document.createElement('div');
                walletItem.className = 'ledger-item';
                
                // 根据钱包类型决定是否显示Users按钮
                const usersButton = wallet.wallet_type === 'shared' 
                    ? `<button class="icon-btn" title="Manage Members" onclick="manageWalletMembers('${wallet.id}', '${wallet.name}')">
                         <img src="assets/svg/user.svg" alt="Members" width="16" height="16">
                       </button>`
                    : '';
                
                walletItem.innerHTML = `
                    <div class="ledger-header">
                        <div class="ledger-name">${wallet.name}</div>
                        <div class="ledger-actions">
                            <button class="icon-btn edit-btn" onclick="editWallet('${wallet.id}')">
                                <img src="assets/svg/edit.svg?v=2" alt="Edit" width="16" height="16">
                            </button>
                            ${usersButton}
                            <button class="icon-btn archive-btn" onclick="archiveWallet('${wallet.id}')">
                                <img src="assets/svg/archive.svg?v=2" alt="Archive" width="16" height="16">
                            </button>
                        </div>
                    </div>
                    <div class="ledger-info">
                        <div class="info-row">
                            <span class="info-label">Type:</span>
                            <span class="info-value">${wallet.wallet_type === 'personal' ? 'Personal' : 'Shared'}</span>
                        </div>
                        ${wallet.wallet_type === 'personal' && wallet.owner_id ? `
                            <div class="info-row">
                                <span class="info-label">Owner:</span>
                                <span class="info-value">${userMap[wallet.owner_id] || 'Unknown'}</span>
                            </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Amount:</span>
                            <span class="info-value">${formatCurrency(parseFloat(wallet.balance), wallet.currency)}</span>
                        </div>
                        ${wallet.description ? `
                            <div class="info-row">
                                <span class="info-label">Description:</span>
                                <span class="info-value">${wallet.description}</span>
                            </div>
                        ` : ''}
                        
                        <!-- 多币种显示 -->
                        <div class="info-row multi-currency-row">
                            <span class="info-label">Multi-Currency:</span>
                            <div class="multi-currency-display">
                                <span class="currency-chip">SGD: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'SGD'), 'SGD')}</span></span>
                                <span class="currency-chip">CNY: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'CNY'), 'CNY')}</span></span>
                                <span class="currency-chip">USD: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'USD'), 'USD')}</span></span>
                                <span class="currency-chip">MYR: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'MYR'), 'MYR')}</span></span>
                            </div>
                        </div>
                    </div>
                `;
                walletList.appendChild(walletItem);
                });
            }
        }

        // 切换查看归档/活跃钱包
        async function toggleWalletView() {
            isViewingArchived = !isViewingArchived;
            
            const button = document.querySelector('.view-archived-btn');
            
            if (isViewingArchived) {
                button.textContent = 'View Active';
                await showArchivedWallets();
            } else {
                button.textContent = 'View Archived';
                await loadWalletsList();
            }
        }

        // 显示归档钱包列表
        async function showArchivedWallets() {
            try {
                // 检查访问控制是否启用
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let wallets = [];

                if (useAccessControl) {
                    // 获取当前用户信息
                    const { data: authData } = await supabase.auth.getUser();
                    if (!authData || !authData.user) {
                        throw new Error('Current user not found.');
                    }

                    // 获取用户在 allowed_users 中的 ID
                    const { data: userData, error: userError } = await supabase
                        .from('allowed_users')
                        .select('id, display_name, email')
                        .eq('email', authData.user.email)
                        .single();
                    if (userError) throw userError;
                    const currentUserId = userData.id;

                    // 获取用户有权限的归档钱包
                    const { data: personalWallets, error: personalError } = await supabase
                        .from('wallets')
                        .select('*')
                        .eq('wallet_type', 'personal')
                        .eq('owner_id', currentUserId)
                        .eq('is_archived', true);
                    if (personalError) throw personalError;

                    const { data: sharedWallets, error: sharedError } = await supabase
                        .from('wallets')
                        .select('*, wallet_members!inner(user_id)')
                        .eq('wallet_type', 'shared')
                        .eq('wallet_members.user_id', currentUserId)
                        .eq('is_archived', true);
                    if (sharedError) throw sharedError;

                    wallets = [...(personalWallets || []), ...(sharedWallets || [])]
                        .sort((a, b) => (a.archived_at > b.archived_at ? -1 : 1));

                    // 无权限时显示空状态（不再回退显示全部）
                    if (wallets.length === 0) {
                        console.log('用户无归档钱包权限，显示空状态');
                    }
                } else {
                    // 访问控制未启用，加载所有归档钱包
                    const { data: allWallets, error } = await supabase
                        .from('wallets')
                        .select('*')
                        .eq('is_archived', true)
                        .order('archived_at', { ascending: false });
                    if (error) throw error;
                    wallets = allWallets || [];
                }
                
                // 获取用户数据
                const { data: users, error: userError } = await supabase
                    .from('allowed_users')
                    .select('id, display_name, email');
                
                if (userError) throw userError;
                
                const userMap = {};
                users.forEach(user => {
                    userMap[user.id] = user.display_name || user.email;
                });
                
                // 显示归档钱包列表
                displayArchivedWalletsList(wallets, userMap);
                
            } catch (error) {
                console.error('Error loading archived wallets:', error);
                await showCustomAlert('Error', 'Failed to load archived wallets');
            }
        }

        // 显示归档钱包列表
        function displayArchivedWalletsList(wallets, userMap) {
            const walletList = document.getElementById('wallet-list');
            
            if (wallets.length === 0) {
                walletList.innerHTML = '<div class="empty-state">No archived wallets found</div>';
                return;
            }
            
            walletList.innerHTML = '';
            
            wallets.forEach(wallet => {
                const walletItem = document.createElement('div');
                walletItem.className = 'ledger-item';
                walletItem.innerHTML = `
                    <div class="ledger-header">
                        <div class="ledger-name" style="opacity: 0.7;">${wallet.name} (Archived)</div>
                        <div class="ledger-actions">
                            <button class="icon-btn unarchive-btn" onclick="unarchiveWallet('${wallet.id}')">
                                <img src="assets/svg/undo.svg?v=2" alt="Unarchive" width="16" height="16">
                            </button>
                        </div>
                    </div>
                    <div class="ledger-info" style="opacity: 0.7;">
                        <div class="info-row">
                            <span class="info-label">Type:</span>
                            <span class="info-value">${wallet.wallet_type === 'personal' ? 'Personal' : 'Shared'}</span>
                        </div>
                        ${wallet.wallet_type === 'personal' && wallet.owner_id ? `
                            <div class="info-row">
                                <span class="info-label">Owner:</span>
                                <span class="info-value">${userMap[wallet.owner_id] || 'Unknown'}</span>
                            </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Amount:</span>
                            <span class="info-value">${formatCurrency(parseFloat(wallet.balance), wallet.currency)}</span>
                        </div>
                        ${wallet.description ? `
                            <div class="info-row">
                                <span class="info-label">Description:</span>
                                <span class="info-value">${wallet.description}</span>
                            </div>
                        ` : ''}
                        
                        <!-- 多币种显示 -->
                        <div class="info-row multi-currency-row">
                            <span class="info-label">Multi-Currency:</span>
                            <div class="multi-currency-display">
                                <span class="currency-chip">SGD: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'SGD'), 'SGD')}</span></span>
                                <span class="currency-chip">CNY: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'CNY'), 'CNY')}</span></span>
                                <span class="currency-chip">USD: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'USD'), 'USD')}</span></span>
                                <span class="currency-chip">MYR: <span class="currency-amount-html">${formatCurrency(parseFloat(wallet.balance) * getWalletExchangeRate(wallet.currency, 'MYR'), 'MYR')}</span></span>
                            </div>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Archived:</span>
                            <span class="info-value">${new Date(wallet.archived_at).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                walletList.appendChild(walletItem);
            });
        }

        // 编辑钱包
        async function editWallet(walletId) {
            try {
                const { data: wallet, error } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('id', walletId)
                    .single();
                
                if (error) throw error;
                
                isEditingWallet = true;
                currentEditingWallet = walletId;
                
                // 填充表单
                document.getElementById('wallet-name').value = wallet.name;
                document.getElementById('wallet-type').value = wallet.wallet_type;
                document.getElementById('wallet-currency').value = wallet.currency;
                document.getElementById('wallet-amount').value = wallet.balance;
                document.getElementById('wallet-description').value = wallet.description || '';
                
                // 显示/隐藏owner字段
                const ownerGroup = document.getElementById('wallet-owner-group');
                
                // 所有类型的钱包都隐藏Account Holder选择，自动设置为当前用户
                    ownerGroup.style.display = 'none';
                
                // 自动设置owner为当前用户
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        const { data: userData } = await supabase
                            .from('allowed_users')
                            .select('id, display_name')
                            .eq('email', user.email)
                            .single();
                        
                        if (userData) {
                            document.getElementById('wallet-owner').value = userData.id;
                        }
                    }
                } catch (error) {
                    console.error('Error getting current user for wallet edit:', error);
                }
                
                // 加载用户选项
                await loadWalletUserOptions();
                
                // 所有类型的钱包owner都已自动设置为当前用户，无需手动设置
                
                // 更新多币种显示
                updateWalletMultiCurrencyDisplay();
                
                // 显示表单
                document.getElementById('wallet-form-title').textContent = 'Edit Wallet';
                document.getElementById('wallet-form-overlay').classList.add('show');
                
                // 添加点击外部关闭功能
                const overlay = document.getElementById('wallet-form-overlay');
                overlay.addEventListener('click', function(event) {
                    if (event.target === overlay) {
                        hideWalletForm();
                    }
                });
                
            } catch (error) {
                console.error('Error editing wallet:', error);
                await showCustomAlert('Error', 'Failed to load wallet details');
            }
        }

        // 归档钱包
        async function archiveWallet(walletId) {
            // 权限验证：只有owner可以归档wallet
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    await showCustomAlert('Authentication Error', 'User not authenticated');
                    return;
                }

                const { data: userData } = await supabase
                    .from('allowed_users')
                    .select('id')
                    .eq('email', user.email)
                    .single();
                
                if (!userData) {
                    await showCustomAlert('Permission Error', 'User not found in allowed users list');
                    return;
                }

                // 检查用户是否为wallet的owner
                const { data: memberData } = await supabase
                    .from('wallet_members')
                    .select('role')
                    .eq('wallet_id', walletId)
                    .eq('user_id', userData.id)
                    .single();

                if (!memberData || memberData.role !== 'owner') {
                    await showCustomAlert('Permission Denied', 'Only owners can archive wallets');
                    return;
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
                await showCustomAlert('Error', 'Failed to verify permissions');
                return;
            }

            // 使用自定义确认弹窗
            const confirmed = await showCustomConfirm(
                'Archive Wallet',
                'Are you sure you want to archive this wallet? It will be hidden but can be restored later.',
                'Archive',
                'Cancel',
                'warning'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                console.log('Archiving wallet:', walletId);
                
                // 更新钱包状态为已归档
                const { error: walletError } = await supabase
                    .from('wallets')
                    .update({ 
                        is_archived: true,
                        archived_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', walletId);
                
                if (walletError) throw walletError;
                
                console.log('Wallet archived successfully');
                loadWalletsList();
                
            } catch (error) {
                console.error('Error archiving wallet:', error);
                await showCustomAlert('Error', 'Failed to archive wallet');
            }
        }

        // 取消归档钱包
        async function unarchiveWallet(walletId) {
            // 权限验证：只有owner可以取消归档wallet
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    await showCustomAlert('Authentication Error', 'User not authenticated');
                    return;
                }

                const { data: userData } = await supabase
                    .from('allowed_users')
                    .select('id')
                    .eq('email', user.email)
                    .single();
                
                if (!userData) {
                    await showCustomAlert('Permission Error', 'User not found in allowed users list');
                    return;
                }

                // 检查用户是否为wallet的owner
                const { data: memberData } = await supabase
                    .from('wallet_members')
                    .select('role')
                    .eq('wallet_id', walletId)
                    .eq('user_id', userData.id)
                    .single();

                if (!memberData || memberData.role !== 'owner') {
                    await showCustomAlert('Permission Denied', 'Only owners can unarchive wallets');
                    return;
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
                await showCustomAlert('Error', 'Failed to verify permissions');
                return;
            }

            // 使用自定义确认弹窗
            const confirmed = await showCustomConfirm(
                'Unarchive Wallet',
                'Are you sure you want to unarchive this wallet? It will be restored to the active wallet list.',
                'Unarchive',
                'Cancel',
                'success'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                console.log('Unarchiving wallet:', walletId);
                
                // 更新钱包状态为未归档
                const { error: walletError } = await supabase
                    .from('wallets')
                    .update({ 
                        is_archived: false,
                        archived_at: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', walletId);
                
                if (walletError) throw walletError;
                
                console.log('Wallet unarchived successfully');
                await showCustomAlert('Success', 'Wallet unarchived successfully');
                
                // 如果当前在查看归档列表，切换到活跃列表
                if (isViewingArchived) {
                    isViewingArchived = false;
                    const button = document.querySelector('.view-archived-btn');
                    button.textContent = 'View Archived';
                    await loadWalletsList();
                } else {
                    // 重新加载钱包列表
                    await loadWalletsList();
                }
                
            } catch (error) {
                console.error('Error unarchiving wallet:', error);
                await showCustomAlert('Error', 'Failed to unarchive wallet');
            }
        }

        // 重置钱包多币种显示
        function resetWalletMultiCurrencyDisplay() {
            document.getElementById('wallet-sgd-amount').innerHTML = 'S$0.00';
            document.getElementById('wallet-sgd-rate').textContent = 'Rate: 1.0000';
            document.getElementById('wallet-cny-amount').innerHTML = '¥0.00';
            document.getElementById('wallet-cny-rate').textContent = 'Rate: 0.0000';
            document.getElementById('wallet-usd-amount').innerHTML = '$0.00';
            document.getElementById('wallet-usd-rate').textContent = 'Rate: 0.0000';
            document.getElementById('wallet-myr-amount').innerHTML = 'RM0.00';
            document.getElementById('wallet-myr-rate').textContent = 'Rate: 0.0000';
        }

        // 更新钱包多币种显示
        function updateWalletMultiCurrencyDisplay() {
            const amount = parseFloat(document.getElementById('wallet-amount').value) || 0;
            const currency = document.getElementById('wallet-currency').value;
            
            if (!currency) {
                resetWalletMultiCurrencyDisplay();
                return;
            }
            
            try {
                // SGD
                const sgdRate = getWalletExchangeRate(currency, 'SGD');
                const sgdAmount = amount * sgdRate;
                document.getElementById('wallet-sgd-amount').innerHTML = formatCurrency(sgdAmount, 'SGD');
                document.getElementById('wallet-sgd-rate').textContent = `Rate: ${sgdRate.toFixed(4)}`;
                
                // CNY
                const cnyRate = getWalletExchangeRate(currency, 'CNY');
                const cnyAmount = amount * cnyRate;
                document.getElementById('wallet-cny-amount').innerHTML = formatCurrency(cnyAmount, 'CNY');
                document.getElementById('wallet-cny-rate').textContent = `Rate: ${cnyRate.toFixed(4)}`;
                
                // USD
                const usdRate = getWalletExchangeRate(currency, 'USD');
                const usdAmount = amount * usdRate;
                document.getElementById('wallet-usd-amount').innerHTML = formatCurrency(usdAmount, 'USD');
                document.getElementById('wallet-usd-rate').textContent = `Rate: ${usdRate.toFixed(4)}`;
                
                // MYR
                const myrRate = getWalletExchangeRate(currency, 'MYR');
                const myrAmount = amount * myrRate;
                document.getElementById('wallet-myr-amount').innerHTML = formatCurrency(myrAmount, 'MYR');
                document.getElementById('wallet-myr-rate').textContent = `Rate: ${myrRate.toFixed(4)}`;
                
            } catch (error) {
                console.error('Error updating wallet multi-currency display:', error);
                resetWalletMultiCurrencyDisplay();
            }
        }

        // 保存钱包
        async function saveWallet() {
            try {
                const name = document.getElementById('wallet-name').value.trim();
                const walletType = document.getElementById('wallet-type').value;
                const ownerId = document.getElementById('wallet-owner').value;
                const currency = document.getElementById('wallet-currency').value;
                const amount = parseFloat(document.getElementById('wallet-amount').value) || 0;
                const description = document.getElementById('wallet-description').value.trim();
                
                // 验证必填字段
                if (!name || !walletType || !currency) {
                    await showCustomAlert('Validation Error', 'Please fill in all required fields');
                    return;
                }
                
                // 所有类型的钱包owner都会在选择类型时自动设置，不需要验证
                
                // 获取当前用户信息
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    await showCustomAlert('Authentication Error', 'User not authenticated');
                    return;
                }
                
                // 获取用户显示名称 - 使用email查询而不是id
                const { data: userData } = await supabase
                    .from('allowed_users')
                    .select('id, display_name')
                    .eq('email', user.email)
                    .single();
                
                if (!userData) {
                    await showCustomAlert('Permission Error', 'User not found in allowed users list');
                    return;
                }
                
                const currentUserName = userData.display_name || user.email;
                const currentUserId = userData.id;
                
                const walletData = {
                    name: name,
                    wallet_type: walletType,
                    owner_id: walletType === 'personal' ? ownerId : null,
                    currency: currency,
                    balance: amount.toString(),
                    description: description,
                    updated_at: new Date().toISOString(),
                    last_editor_name: currentUserName,
                    last_edited_at: new Date().toISOString()
                };
                
                if (isEditingWallet) {
                    // 获取当前钱包信息以比较余额/币种变化
                    const { data: currentWallet, error: fetchError } = await supabase
                        .from('wallets')
                        .select('balance, currency')
                        .eq('id', currentEditingWallet)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    const oldBalance = parseFloat(currentWallet.balance);
                    const oldCurrency = currentWallet.currency;
                    const newBalance = amount;
                    const newCurrency = currency;
                    
                    // 更新现有钱包
                    const { error } = await supabase
                        .from('wallets')
                        .update(walletData)
                        .eq('id', currentEditingWallet);
                    
                    if (error) throw error;
                    
                    // 货币未变化：写 manual_adjustment
                    if (oldCurrency === newCurrency) {
                        const balanceChange = newBalance - oldBalance;
                        if (Math.abs(balanceChange) > 0.01) { // 避免浮点数精度问题
                            const currencySymbols = {
                                'SGD': 'S$',
                                'USD': '$',
                                'CNY': '¥',
                                'MYR': 'RM'
                            };
                            const symbol = currencySymbols[newCurrency] || newCurrency;
                            const oldSign = oldBalance < 0 ? '-' : '';
                            const newSign = newBalance < 0 ? '-' : '';
                            const oldAmountText = `${oldSign}${symbol}${Math.abs(oldBalance).toFixed(2)}`;
                            const newAmountText = `${newSign}${symbol}${Math.abs(newBalance).toFixed(2)}`;
                            
                            const entryData = {
                                wallet_id: currentEditingWallet,
                                entry_type: 'manual_adjustment',
                                amount: balanceChange.toString(),
                                balance_after: newBalance.toString(),
                                currency: newCurrency,
                                reference_id: currentEditingWallet,
                                reference_type: 'wallet',
                                description: `Manual balance adjustment: ${oldAmountText} → ${newAmountText}`,
                                created_by: currentUserId,
                                created_by_name: currentUserName
                            };
                            
                            const { error: entryError } = await supabase
                                .from('wallet_entries')
                                .insert([entryData]);
                            
                            if (entryError) throw entryError;
                        }
                    } else {
                        // 货币已变化：写一条 currency_change 记录（按用户输入的新余额）
                        const currencySymbols = {
                            'SGD': 'S$',
                            'USD': '$',
                            'CNY': '¥',
                            'MYR': 'RM'
                        };
                        const oldSymbol = currencySymbols[oldCurrency] || oldCurrency;
                        const newSymbol = currencySymbols[newCurrency] || newCurrency;
                        
                        const desc = `Currency change: ${oldSymbol}${Math.abs(oldBalance).toFixed(2)} ${oldCurrency} → ${newSymbol}${Math.abs(newBalance).toFixed(2)} ${newCurrency}`;
                        
                        const singleChange = {
                            wallet_id: currentEditingWallet,
                            entry_type: 'currency_change',
                            amount: null,
                            balance_after: newBalance.toString(),
                            currency: newCurrency,
                            reference_id: currentEditingWallet,
                            reference_type: 'wallet',
                            description: desc,
                            created_by: currentUserId,
                            created_by_name: currentUserName
                        };
                        
                        const { error: entryError } = await supabase
                            .from('wallet_entries')
                            .insert([singleChange]);
                        if (entryError) throw entryError;
                    }
                } else {
                    // 创建新钱包
                    walletData.created_by = currentUserId;
                    walletData.created_at = new Date().toISOString();
                    walletData.is_archived = false; // 新钱包默认为未归档
                    walletData.archived_at = null; // 新钱包归档时间为空
                    
                    // 直接插入钱包（RLS策略已禁用或配置正确）
                    const { data: newWallet, error: walletError } = await supabase
                        .from('wallets')
                        .insert([walletData])
                        .select('id, wallet_type')
                        .single();
                    
                    if (walletError) throw walletError;
                    
                    // 由数据库触发器自动将创建者加入 wallet_members 作为 owner，避免前端重复插入导致唯一键冲突
                    
                    // 创建初始wallet_entries记录（包括零余额）
                    // 创建纯文本格式的货币显示
                    const currencySymbols = {
                        'SGD': 'S$',
                        'USD': '$',
                        'CNY': '¥',
                        'MYR': 'RM'
                    };
                    const symbol = currencySymbols[currency] || currency;
                    const plainTextAmount = `${symbol}${Math.abs(amount).toFixed(2)}`;
                    
                    const entryData = {
                        wallet_id: newWallet.id,
                        entry_type: 'initial',
                        amount: amount.toString(),
                        balance_after: amount.toString(),
                        currency: currency,
                        reference_id: newWallet.id,
                        reference_type: 'wallet',
                        description: `Initial wallet balance: ${plainTextAmount}`,
                        created_by: currentUserId,
                        created_by_name: currentUserName
                    };
                    
                    const { error: entryError } = await supabase
                        .from('wallet_entries')
                        .insert([entryData]);
                    
                    if (entryError) throw entryError;
                }
                
                hideWalletForm();
                loadWalletsList();
                
            } catch (error) {
                console.error('Error saving wallet:', error);
                await showCustomAlert('Save Error', 'Failed to save wallet');
            }
        }

        // 将钱包函数添加到全局作用域
        window.showAddWalletForm = showAddWalletForm;
        window.hideWalletForm = hideWalletForm;
        window.editWallet = editWallet;
        window.archiveWallet = archiveWallet;
        window.unarchiveWallet = unarchiveWallet;
        window.toggleWalletView = toggleWalletView;
        window.showArchivedWallets = showArchivedWallets;
        window.saveWallet = saveWallet;

        // ==================== 钱包管理功能结束 ====================

        // ==================== Recurring Bills 管理功能开始 ====================
        let isEditingRecurring = false;
        let currentEditingRecurring = null;

        async function loadRecurringList(){
            try {
                // 先获取 recurring bills 数据
                const { data: recurringData, error: recurringError } = await supabase
                    .from('recurring_bills')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (recurringError) throw recurringError;

                const list = document.getElementById('recurring-list');
                if (!list) return;
                list.innerHTML = '';
                if (!recurringData || recurringData.length === 0){
                    showEmptyState('recurring-list', 'recurring');
                    return;
                }

                // 获取所有相关的 category IDs
                const categoryIds = [...new Set(recurringData.map(item => item.category_id).filter(id => id))];
                
                // 批量查询 categories
                let categoriesMap = {};
                if (categoryIds.length > 0) {
                    const { data: categoriesData, error: categoriesError } = await supabase
                        .from('categories')
                        .select('id, name, emoji')
                        .in('id', categoryIds);
                    if (categoriesError) throw categoriesError;
                    
                    categoriesMap = categoriesData.reduce((acc, cat) => {
                        acc[cat.id] = { name: cat.name, emoji: cat.emoji || '📁' };
                        return acc;
                    }, {});
                }

                recurringData.forEach(tpl => {
                    const item = document.createElement('div');
                    item.className = 'ledger-item';
                    item.setAttribute('data-recurring-id', tpl.id);
                    item.setAttribute('data-recurring-status', tpl.status);
                    const freq = `${(tpl.frequency||'').replace(/^./, c=>c.toUpperCase())}`;
                    const statusChip = `<span style="padding:2px 8px;border-radius:10px;background:${tpl.status==='active'?'#dcfce7':'#fee2e2'};color:${tpl.status==='active'?'#065f46':'#991b1b'};font-size:12px;">${tpl.status}</span>`;
                    const categoryInfo = categoriesMap[tpl.category_id] || { name: 'Unknown', emoji: '📁' };
                    const categoryDisplay = `${categoryInfo.emoji} ${categoryInfo.name} • ${tpl.amount} ${tpl.currency}`;
                    item.innerHTML = `
                        <div class="ledger-header">
                            <div class="ledger-name">${categoryDisplay}</div>
                            <div class="ledger-actions">
                                <button class="icon-btn edit-btn recurring-edit-btn"><img src="assets/svg/edit.svg?v=2" width="16" height="16"></button>
                                <button class="icon-btn recurring-toggle-btn"><img src="assets/svg/${tpl.status==='active'?'pause':'play'}.svg" width="16" height="16"></button>
                                <button class="icon-btn recurring-delete-btn"><img src="assets/svg/delete.svg?v=2" width="16" height="16"></button>
                            </div>
                        </div>
                        <div class="ledger-info">
                            <div class="info-row"><span class="info-label">Type:</span><span class="info-value">${(tpl.type||'').replace(/^./, c=>c.toUpperCase())}</span></div>
                            <div class="info-row"><span class="info-label">Frequency:</span><span class="info-value">${freq}</span></div>
                            <div class="info-row"><span class="info-label">Date:</span><span class="info-value">${tpl.next_run_at ? new Date(tpl.next_run_at).toLocaleString() : '-'}</span></div>
                            <div class="info-row"><span class="info-label">Status:</span><span class="info-value">${statusChip}</span></div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (e) {
                console.error('Failed to load recurring bills:', e);
                await showCustomAlert('Error', 'Failed to load recurring bills: ' + e.message);
            }
        }

        async function showAddRecurringForm(){
            isEditingRecurring = false;
            currentEditingRecurring = null;
            const form = document.getElementById('recurring-form');
            if (form) form.reset();
            document.getElementById('recurring-form-title').textContent = 'Add Recurring Bill';
            
            // 默认 anchor 时间（当前时间）
            const now = new Date();
            const localISO = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
            document.getElementById('recurring-anchor').value = localISO;
            
            await loadRecurringDropdowns();
            
            // 设置默认值为第一个可用选项
            setTimeout(() => {
                const ledgerSel = document.getElementById('recurring-ledger');
                const walletSel = document.getElementById('recurring-wallet');
                const currencySel = document.getElementById('recurring-currency');
                
                // 设置 ledger 默认值
                if (ledgerSel && ledgerSel.options.length > 1) {
                    ledgerSel.value = ledgerSel.options[1].value; // 跳过第一个 "Select ledger" 选项
                }
                
                // 设置 wallet 默认值
                if (walletSel && walletSel.options.length > 1) {
                    walletSel.value = walletSel.options[1].value; // 跳过第一个 "Select wallet" 选项
                }
                
                // 设置 currency 默认值
                if (currencySel && currencySel.options.length > 1) {
                    currencySel.value = currencySel.options[1].value; // 跳过第一个 "Select currency" 选项
                }
                
                // 触发 category 更新（因为 ledger 和 type 已设置）
                const typeSel = document.getElementById('recurring-type');
                if (ledgerSel && typeSel) {
                    const event = new Event('change');
                    ledgerSel.dispatchEvent(event);
                    typeSel.dispatchEvent(event);
                }
                
                // 设置 category 默认值
                setTimeout(() => {
                    const catSel = document.getElementById('recurring-category');
                    if (catSel && catSel.options.length > 1) {
                        catSel.value = catSel.options[1].value; // 跳过第一个 "Select category" 选项
                    }
                }, 50);
                
                // 添加多币种转换事件监听器
                const amountInput = document.getElementById('recurring-amount');
                const anchorInput = document.getElementById('recurring-anchor');
                
                if (amountInput) {
                    amountInput.addEventListener('input', updateRecurringMultiCurrencyDisplay);
                }
                if (currencySel) {
                    currencySel.addEventListener('change', updateRecurringMultiCurrencyDisplay);
                }
                if (anchorInput) {
                    anchorInput.addEventListener('change', updateRecurringMultiCurrencyDisplay);
                }
                
                // 初始更新多币种显示
                updateRecurringMultiCurrencyDisplay();
            }, 100);
            
            document.getElementById('recurring-form-overlay').classList.add('show');
        }

        function hideRecurringForm(){
            document.getElementById('recurring-form-overlay').classList.remove('show');
            isEditingRecurring = false;
            currentEditingRecurring = null;
        }

        async function loadRecurringDropdowns(){
            try{
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                
                // 加载 Ledgers（支持访问控制）
                let ledgers = [];
                if (useAccessControl) {
                    const { data: authData } = await supabase.auth.getUser();
                    if (!authData || !authData.user) throw new Error('auth: no user');
                    
                    const { data: userData, error: userError } = await supabase
                        .from('allowed_users')
                        .select('id')
                        .eq('email', authData.user.email)
                        .single();
                    if (userError) throw userError;
                    const currentUserId = userData.id;

                    const { data: ledgerData, error: ledgerError } = await supabase
                        .from('ledgers')
                        .select('id, name, ledger_members!inner(user_id)')
                        .eq('is_active', true)
                        .eq('ledger_members.user_id', currentUserId)
                        .order('name');
                    if (ledgerError) throw ledgerError;
                    ledgers = ledgerData || [];
                } else {
                    const { data: ledgerData, error: ledgerError } = await supabase
                        .from('ledgers')
                        .select('id, name')
                        .eq('is_active', true)
                        .order('name');
                    if (ledgerError) throw ledgerError;
                    ledgers = ledgerData || [];
                }

                // 加载 Wallets（支持访问控制）
                let wallets = [];
                if (useAccessControl) {
                    const { data: authData } = await supabase.auth.getUser();
                    if (!authData || !authData.user) throw new Error('auth: no user');
                    
                    const { data: userData, error: userError } = await supabase
                        .from('allowed_users')
                        .select('id')
                        .eq('email', authData.user.email)
                        .single();
                    if (userError) throw userError;
                    const currentUserId = userData.id;

                    const { data: personal, error: pErr } = await supabase
                        .from('wallets')
                        .select('id, name, currency, wallet_type, owner_id')
                        .eq('is_archived', false)
                        .eq('wallet_type', 'personal')
                        .eq('owner_id', currentUserId);
                    if (pErr) throw pErr;

                    const { data: shared, error: sErr } = await supabase
                        .from('wallets')
                        .select('id, name, currency, wallet_type, owner_id, wallet_members!inner(user_id)')
                        .eq('is_archived', false)
                        .eq('wallet_type', 'shared')
                        .eq('wallet_members.user_id', currentUserId);
                    if (sErr) throw sErr;

                    wallets = [...(personal || []), ...(shared || [])];
                } else {
                    const { data: walletData, error: walletError } = await supabase
                        .from('wallets')
                        .select('id, name, currency, wallet_type, owner_id')
                        .eq('is_archived', false)
                        .order('created_at', { ascending: false });
                    if (walletError) throw walletError;
                    wallets = walletData || [];
                }

                // 加载 Categories（需要 ledger_id 和 type，这里先加载所有，后续根据选择动态更新）
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .select('id, name, emoji, ledger_id, parent_type')
                    .order('name');
                if (catError) throw catError;

                // 更新 UI
                const ledgerSel = document.getElementById('recurring-ledger');
                const walletSel = document.getElementById('recurring-wallet');
                const catSel = document.getElementById('recurring-category');
                const currencySel = document.getElementById('recurring-currency');
                
                if (ledgerSel) {
                    ledgerSel.innerHTML = '<option value="">Select ledger</option>' + 
                        ledgers.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                }
                
                if (walletSel) {
                    walletSel.innerHTML = '<option value="">Select wallet</option>' + 
                        wallets.map(w => `<option value="${w.id}" data-currency="${w.currency}">${w.name} (${w.currency})</option>`).join('');
                }
                
                if (catSel) {
                    catSel.innerHTML = '<option value="">Select category</option>' + 
                        categories.map(c => {
                            const emoji = c.emoji || '📁'; // 如果没有emoji，使用默认图标
                            return `<option value="${c.id}" data-ledger-id="${c.ledger_id}" data-parent-type="${c.parent_type}">${emoji} ${c.name}</option>`;
                        }).join('');
                }
                
                if (currencySel) {
                    currencySel.innerHTML = '<option value="">Select currency</option>' +
                        '<option value="SGD">SGD</option>' +
                        '<option value="CNY">CNY</option>' +
                        '<option value="USD">USD</option>' +
                        '<option value="MYR">MYR</option>';
                }

                // 添加 ledger 和 type 变化监听器，动态更新 categories
                if (ledgerSel && catSel) {
                    const updateCategories = () => {
                        const selectedLedgerId = ledgerSel.value;
                        const selectedType = document.getElementById('recurring-type').value;
                        
                        if (!selectedLedgerId || !selectedType) {
                            catSel.innerHTML = '<option value="">Select category</option>';
                            return;
                        }
                        
                        const filteredCats = categories.filter(c => 
                            c.ledger_id == selectedLedgerId && c.parent_type === selectedType
                        );
                        
                        catSel.innerHTML = '<option value="">Select category</option>' + 
                            filteredCats.map(c => {
                                const emoji = c.emoji || '📁'; // 如果没有emoji，使用默认图标
                                return `<option value="${c.id}">${emoji} ${c.name}</option>`;
                            }).join('');
                    };
                    
                    ledgerSel.addEventListener('change', updateCategories);
                    document.getElementById('recurring-type').addEventListener('change', updateCategories);
                }

                // 添加 wallet 变化监听器，自动更新 currency
                if (walletSel) {
                    walletSel.addEventListener('change', function() {
                        const selectedOption = walletSel.options[walletSel.selectedIndex];
                        const walletCurrency = selectedOption.getAttribute('data-currency');
                        const currencySel = document.getElementById('recurring-currency');
                        
                        // 自动同步币种至钱包币种
                        if (walletCurrency && currencySel) {
                            currencySel.value = walletCurrency;
                        }
                    });
                }
                
            }catch(e){
                console.error('loadRecurringDropdowns error', e);
            }
        }

        async function buildRecurringPayloadFromForm(){
            const freq = document.getElementById('recurring-frequency').value || 'monthly';
            const anchorLocal = document.getElementById('recurring-anchor').value;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
            const anchorUtc = new Date(anchorLocal).toISOString();
            
            // 获取当前用户ID
            let creatorId = null;
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    const { data: userData } = await supabase
                        .from('allowed_users')
                        .select('id')
                        .eq('email', user.email)
                        .single();
                    if (userData) {
                        creatorId = userData.id;
                    }
                }
            } catch (error) {
                console.error('Error getting current user:', error);
            }
            
            const payload = {
                creator_id: creatorId,
                ledger_id: parseInt(document.getElementById('recurring-ledger').value,10),
                wallet_id: document.getElementById('recurring-wallet').value,
                category_id: document.getElementById('recurring-category').value,
                type: document.getElementById('recurring-type').value,
                amount: document.getElementById('recurring-amount').value,
                currency: document.getElementById('recurring-currency').value,
                notes_template: document.getElementById('recurring-notes').value || null,
                frequency: freq,
                interval: 1, // 固定为1
                anchor_date: anchorUtc,
                timezone: timezone,
                status: 'active',
                start_at: anchorUtc,
                next_run_at: anchorUtc
            };
            
            // 根据频率设置对应的细化字段
            if (freq === 'monthly') {
                // 从 anchor_date 提取日期作为每月执行日
                const anchorDate = new Date(anchorLocal);
                payload.monthly_day = anchorDate.getDate();
            } else if (freq === 'yearly') {
                // 从 anchor_date 提取月日作为每年执行日期
                const anchorDate = new Date(anchorLocal);
                payload.yearly_month = anchorDate.getMonth() + 1; // 0-based to 1-based
                payload.yearly_day = anchorDate.getDate();
            }
            
            return payload;
        }

        async function editRecurring(id){
            try{
                const { data, error } = await supabase.from('recurring_bills').select('*').eq('id', id).single();
                if (error) throw error;
                isEditingRecurring = true;
                currentEditingRecurring = id;
                document.getElementById('recurring-form-title').textContent = 'Edit Recurring Bill';
                
                // 先加载约束条件，然后设置表单值
                await loadRecurringDropdowns();
                
                // 等待下拉框加载完成后再设置值
                setTimeout(() => {
                    document.getElementById('recurring-ledger').value = data.ledger_id;
                    document.getElementById('recurring-wallet').value = data.wallet_id;
                    document.getElementById('recurring-type').value = data.type;
                    
                    // 触发 category 更新
                    const ledgerSel = document.getElementById('recurring-ledger');
                    const typeSel = document.getElementById('recurring-type');
                    if (ledgerSel && typeSel) {
                        const event = new Event('change');
                        ledgerSel.dispatchEvent(event);
                        typeSel.dispatchEvent(event);
                    }
                    
                    // 等待 category 更新后再设置 category 值
                    setTimeout(() => {
                        document.getElementById('recurring-category').value = data.category_id;
                        document.getElementById('recurring-amount').value = data.amount;
                        document.getElementById('recurring-currency').value = data.currency;
                        document.getElementById('recurring-notes').value = data.notes_template || '';
                        document.getElementById('recurring-frequency').value = data.frequency;
                        document.getElementById('recurring-anchor').value = new Date(data.anchor_date).toISOString().slice(0,16);
                        
                        // 添加多币种转换事件监听器
                        const amountInput = document.getElementById('recurring-amount');
                        const currencySelect = document.getElementById('recurring-currency');
                        const anchorInput = document.getElementById('recurring-anchor');
                        
                        if (amountInput) {
                            amountInput.addEventListener('input', updateRecurringMultiCurrencyDisplay);
                        }
                        if (currencySelect) {
                            currencySelect.addEventListener('change', updateRecurringMultiCurrencyDisplay);
                        }
                        if (anchorInput) {
                            anchorInput.addEventListener('change', updateRecurringMultiCurrencyDisplay);
                        }
                        
                        // 初始更新多币种显示
                        updateRecurringMultiCurrencyDisplay();
                    }, 100);
                }, 100);
                
                document.getElementById('recurring-form-overlay').classList.add('show');
            }catch(e){
                console.error('editRecurring error', e);
            }
        }

        async function toggleRecurringStatus(id, status){
            try{
                const next = status==='active' ? 'paused' : 'active';
                const { error } = await supabase.from('recurring_bills').update({ status: next }).eq('id', id);
                if (error) throw error;
                await loadRecurringList();
            }catch(e){
                await showCustomAlert('Error', 'Failed to update status: ' + e.message);
            }
        }

        async function runRecurringNow(id){
            try{
                const { error } = await supabase.from('recurring_bills').update({ next_run_at: new Date().toISOString() }).eq('id', id);
                if (error) throw error;
                await showCustomAlert('Success', 'Scheduled to run on next trigger.');
            }catch(e){
                await showCustomAlert('Error', 'Failed to schedule: ' + e.message);
            }
        }

        async function deleteRecurring(id){
            if (!confirm('Delete this recurring bill?')) return;
            try{
                const { error } = await supabase.from('recurring_bills').delete().eq('id', id);
                if (error) throw error;
                await loadRecurringList();
            }catch(e){
                await showCustomAlert('Error', 'Failed to delete: ' + e.message);
            }
        }

        // 将 Recurring 相关函数暴露到全局
        window.showAddRecurringForm = showAddRecurringForm;
        window.hideRecurringForm = hideRecurringForm;
        window.editRecurring = editRecurring;
        window.toggleRecurringStatus = toggleRecurringStatus;
        window.runRecurringNow = runRecurringNow;
        window.deleteRecurring = deleteRecurring;
        
        // 添加 Recurring 按钮事件委托
        document.addEventListener('click', function(e) {
            if (e.target.closest('.recurring-edit-btn')) {
                const item = e.target.closest('.ledger-item');
                const id = item.getAttribute('data-recurring-id');
                editRecurring(id);
            } else if (e.target.closest('.recurring-toggle-btn')) {
                const item = e.target.closest('.ledger-item');
                const id = item.getAttribute('data-recurring-id');
                const status = item.getAttribute('data-recurring-status');
                toggleRecurringStatus(id, status);
            } else if (e.target.closest('.recurring-run-btn')) {
                const item = e.target.closest('.ledger-item');
                const id = item.getAttribute('data-recurring-id');
                runRecurringNow(id);
            } else if (e.target.closest('.recurring-delete-btn')) {
                const item = e.target.closest('.ledger-item');
                const id = item.getAttribute('data-recurring-id');
                deleteRecurring(id);
            }
        });
        
        // 添加 Recurring 表单事件监听器
        document.getElementById('recurring-form').addEventListener('submit', async function(e){
            e.preventDefault();
            try{
                const payload = await buildRecurringPayloadFromForm();
                if (isEditingRecurring && currentEditingRecurring){
                    const { error } = await supabase.from('recurring_bills').update(payload).eq('id', currentEditingRecurring);
                    if (error) throw error;
                } else {
                    const { error } = await supabase.from('recurring_bills').insert(payload);
                    if (error) throw error;
                }
                hideRecurringForm();
                await loadRecurringList();
            }catch(err){
                console.error('save recurring error', err);
                await showCustomAlert('Error', 'Failed to save: ' + err.message);
            }
        });
        
        
        // ==================== Recurring Bills 管理功能结束 ====================

        // 绑定导航点击事件
        function bindNavigationEvents() {
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        // 初始化页面
        async function init() {
            await checkAuth();
            
            // 绑定导航事件
            bindNavigationEvents();
            
            // 检查URL参数，决定显示哪个section
            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            const action = urlParams.get('action');
            
            if (section === 'ledger') {
                showSection('ledger');
                // 如果是创建操作，自动打开创建表单
                if (action === 'create') {
                    setTimeout(() => {
                        showAddLedgerForm();
                    }, 500);
                }
            } else if (section === 'wallet') {
                showSection('wallet');
                loadWalletsList(); // 加载钱包列表
                // 如果是创建操作，自动打开创建表单
                if (action === 'create') {
                    setTimeout(() => {
                        showAddWalletForm();
                    }, 500);
                }
            } else if (section === 'recurring') {
                showSection('recurring');
                loadRecurringList();
                if (action === 'create') {
                    setTimeout(() => {
                        showAddRecurringForm();
                    }, 500);
                }
            } else {
                loadProfileInfo(); // 默认显示Profile信息
            }
            
            loadLedgersList();
            
            // 检查URL参数，如果是从Budget Bar跳转过来的，自动打开编辑模态框
            checkAndOpenBudgetEdit();
            
            // 检查URL参数，如果是从Wallet页面跳转过来的，自动打开钱包编辑模态框
            checkAndOpenWalletEdit();
            
            // 添加表单提交事件监听器
            document.getElementById('ledger-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveLedger();
            });
            
            document.getElementById('category-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCategory();
            });
            
            document.getElementById('budget-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveBudget();
            });
            
            // 添加Budget表单字段的事件监听器
            document.getElementById('budget-amount').addEventListener('input', function() {
                // 金额变化时只更新显示，不清除缓存
                updateMultiCurrencyDisplay();
            });
            document.getElementById('budget-currency').addEventListener('change', function() {
                // 货币变化时清除缓存并重新获取汇率
                console.log('Budget currency changed, clearing cache...');
                window.budgetExchangeRatesLoaded = false;
                updateMultiCurrencyDisplay();
            });
            document.getElementById('budget-month').addEventListener('change', function() {
                // 月份变化时清除缓存并重新获取汇率
                console.log('Budget month changed, clearing cache...');
                window.budgetExchangeRatesLoaded = false;
                updateMultiCurrencyDisplay();
            });
            
            // 添加钱包表单事件监听器
            document.getElementById('wallet-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveWallet();
            });
            
            // 添加钱包表单字段的事件监听器
            document.getElementById('wallet-amount').addEventListener('input', function() {
                updateWalletMultiCurrencyDisplay();
            });
            document.getElementById('wallet-currency').addEventListener('change', function() {
                updateWalletMultiCurrencyDisplay();
            });
            document.getElementById('wallet-type').addEventListener('change', async function() {
                const ownerGroup = document.getElementById('wallet-owner-group');
                
                // 所有类型的钱包都隐藏Account Holder选择，自动设置为当前用户
                    ownerGroup.style.display = 'none';
                
                // 获取当前用户信息并自动设置
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        const { data: userData } = await supabase
                            .from('allowed_users')
                            .select('id, display_name')
                            .eq('email', user.email)
                            .single();
                        
                        if (userData) {
                            document.getElementById('wallet-owner').value = userData.id;
                        }
                    }
                } catch (error) {
                    console.error('Error getting current user for wallet:', error);
                }
            });
            
            // 添加category名称输入监听器
            document.getElementById('category-name').addEventListener('input', function(e) {
                const name = e.target.value.trim();
                if (name.length > 2) {
                    const recommendation = getCategoryRecommendations(name);
                    showRecommendedIcon(recommendation);
                } else {
                    hideRecommendedIcon();
                }
            });
            
            // 添加Change Icon按钮监听器
            document.getElementById('change-icon-btn').addEventListener('click', function() {
                showIconModal();
            });
        }
        
        // 检查URL参数并自动打开预算编辑或添加模态框
        async function checkAndOpenBudgetEdit() {
            try {
                const hash = window.location.hash;
                console.log('Checking hash:', hash);
                
                // 检查是否有编辑或添加参数
                const isEdit = hash.includes('edit=true');
                const isAdd = hash.includes('add=true');
                
                // 如果没有编辑或添加参数，直接返回
                if (!isEdit && !isAdd) {
                    console.log('No edit or add parameters found, skipping budget modal');
                    return;
                }
                
                // 解析URL参数
                const hashParams = hash.substring(hash.indexOf('&'));
                console.log('Hash params string:', hashParams);
                const params = new URLSearchParams(hashParams);
                const ledgerId = params.get('ledger');
                const month = params.get('month');
                
                console.log('Parsed parameters:', { ledgerId, month, isEdit, isAdd });
                
                // 等待页面加载完成后打开模态框
                setTimeout(() => {
                    console.log('Opening budget modal...');
                    
                    // 切换到预算标签页
                    showSection('budget');
                    console.log('Switched to budget section');
                    
                    // 再等待一下确保预算列表加载完成
                    setTimeout(() => {
                        if (isEdit && ledgerId && month) {
                            // 编辑现有预算
                            console.log('Auto-opening budget edit for:', { ledgerId, month });
                            
                            // 查找对应的预算数据
                            supabase
                                .from('budgets')
                                .select('id, ledger_id, month, amount, currency, description, sgd_amount, sgd_rate, cny_amount, cny_rate, usd_amount, usd_rate, myr_amount, myr_rate')
                                .eq('ledger_id', ledgerId)
                                .eq('month', month)
                                .single()
                                .then(({ data: budgetData, error }) => {
                                    if (error || !budgetData) {
                                        console.log('Budget not found for:', { ledgerId, month, error });
                                        return;
                                    }
                                    
                                    console.log('Found budget data:', budgetData);
                                    editBudget(budgetData);
                                    console.log('Opened edit budget modal');
                                });
                        } else if (isAdd) {
                            // 添加新预算
                            console.log('Auto-opening add budget form');
                            showAddBudgetForm();
                            
                            // 如果提供了账本和月份，预填这些字段
                            if (ledgerId && month) {
                                setTimeout(() => {
                                    const ledgerSelect = document.getElementById('budget-ledger');
                                    const monthInput = document.getElementById('budget-month');
                                    
                                    if (ledgerSelect) {
                                        ledgerSelect.value = ledgerId;
                                        console.log('Pre-filled ledger:', ledgerId);
                                    }
                                    
                                    if (monthInput) {
                                        monthInput.value = month;
                                        console.log('Pre-filled month:', month);
                                    }
                                }, 100);
                            }
                        }
                        
                        // 清除URL参数，避免刷新页面时重复打开
                        window.location.hash = '#budgets';
                    }, 300);
                }, 500);
                
            } catch (error) {
                console.error('Error auto-opening budget modal:', error);
            }
        }

        // 检查URL参数并自动打开钱包编辑模态框
        async function checkAndOpenWalletEdit() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const section = urlParams.get('section');
                const editWalletId = urlParams.get('edit');
                
                console.log('Checking wallet URL params:', { section, editWalletId });
                
                // 如果没有钱包编辑参数，直接返回
                if (section !== 'wallet' || !editWalletId) {
                    console.log('No wallet edit parameters found, skipping wallet modal');
                    return;
                }
                
                // 等待页面加载完成后打开模态框
                setTimeout(() => {
                    console.log('Opening wallet edit modal...');
                    
                    // 切换到钱包标签页
                    showSection('wallet');
                    console.log('Switched to wallet section');
                    
                    // 再等待一下确保钱包列表加载完成
                    setTimeout(() => {
                        console.log('Auto-opening wallet edit for:', editWalletId);
                        editWallet(editWalletId);
                        console.log('Opened edit wallet modal');
                        
                        // 清除URL参数，避免刷新页面时重复打开
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                    }, 300);
                }, 500);
                
            } catch (error) {
                console.error('Error auto-opening wallet edit modal:', error);
            }
        }

        init();
    </script>
</body>
</html>
