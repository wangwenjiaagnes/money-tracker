<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Home - Money Tracker</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="assets/png/app_icon.png" />
    <link rel="shortcut icon" type="image/png" href="assets/png/app_icon.png" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="assets/png/app_icon.png" />
    <link rel="apple-touch-icon-precomposed" href="assets/png/app_icon.png" />
    
    <!-- Android Web App Manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Money Tracker" />
    
    <style>
        :root {
            --font-weight-normal: 400;
            --font-weight-medium: 600;
            --font-weight-bold: 700;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            min-height: 100vh;
            background-attachment: fixed !important;
            background-repeat: no-repeat !important;
            background-size: cover !important;
        }
        
        /* 确保背景不会被任何元素覆盖 */
        html::before, body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -9999;
            pointer-events: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .brand {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 12px;
        }



        .category-ledger-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            padding: 10px 16px;
            text-decoration: none;
            color: #667eea;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-link img {
            color: #667eea;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-link.active {
            background: rgba(102, 126, 234, 0.15);
            color: #5a67d8;
            cursor: default;
            pointer-events: none;
        }

        .nav-link.active:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: none;
        }

        .transaction-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .transaction-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* 移动端响应式设计 */
        @media (max-width: 768px) {
            .nav-menu {
                gap: 12px !important;
                flex-direction: row !important;
                justify-content: center !important;
            }
            
            .nav-link {
                padding: 8px 12px;
            }
            
            .transaction-btn {
                padding: 8px 12px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .transaction-btn::before {
                content: '';
                width: 20px;
                height: 20px;
                background-image: url('assets/svg/add.svg');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                filter: brightness(0) invert(1);
            }
            
            .transaction-btn span {
                display: none;
            }
        }



        .main-container {
            max-width: 1200px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding: 20px 16px;
            box-sizing: border-box;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: none;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            margin-left: auto;
            margin-right: auto;
        }

        /* 强制移除filters-section的所有阴影和边框 */
        .filters-section,
        .filters-section * {
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            border: none !important;
        }

        /* Summary Section Styles */
        .summary-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-left: auto;
            margin-right: auto;
        }

        .summary-title {
            font-size: 18px;
            font-weight: var(--font-weight-bold);
            color: #333;
            margin-bottom: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-card.income {
            background: white;
            color: #333;
        }

        .summary-card.expense {
            background: white;
            color: #333;
        }

        .summary-card.net {
            background: white;
            color: #333;
        }

        .summary-card.count {
            background: white;
            color: #333;
        }

        .summary-label {
            font-size: 14px;
            font-weight: var(--font-weight-normal);
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: var(--font-weight-bold);
            margin-bottom: 4px;
        }

        /* Budget Progress Bar Styles */
        .budget-progress-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .budget-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .budget-usage {
            color: #666;
            font-weight: 500;
        }

        .budget-amount {
            color: #333;
            font-weight: 600;
        }
        
        .budget-amount-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .budget-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .budget-edit-btn:hover {
            background-color: #f0f0f0;
        }
        
        .budget-edit-icon {
            width: 12px;
            height: 12px;
            opacity: 0.7;
            filter: invert(40%) sepia(80%) saturate(1000%) hue-rotate(200deg) brightness(0.8) contrast(1);
        }

        .budget-progress-bar {
            width: 100%;
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0;
        }

        .budget-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .budget-progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
        }

        .budget-progress-fill.danger {
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
        }

        .budget-usage {
            font-size: 11px;
            color: #666;
            text-align: center;
            font-weight: 500;
        }
        
        /* Budget Setup Prompt Styles */
        .budget-setup-prompt {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .budget-setup-text {
            color: #666;
            font-size: 12px;
            font-weight: 500;
        }
        
        .budget-setup-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .budget-setup-btn,
        .budget-ignore-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .budget-setup-btn:hover {
            background-color: #f0f0f0;
        }
        
        .budget-ignore-btn:hover {
            background-color: #f0f0f0;
        }
        
        .budget-setup-icon,
        .budget-ignore-icon {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }
        


        /* Summary移动端优化 */
        @media (max-width: 768px) {
            .summary-section {
                padding: 16px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .summary-card {
                padding: 16px;
            }
            
            .summary-value {
                font-size: 24px;
            }
            
            .summary-label {
                font-size: 12px;
            }
            
            .budget-progress-container {
                margin-top: 8px;
                padding-top: 8px;
            }
            
            .budget-info {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .budget-progress-bar {
                height: 7px;
                margin-bottom: 4px;
            }
            
            .budget-usage {
                font-size: 10px;
            }
            
            .budget-setup-text {
                font-size: 11px;
            }
            
            .budget-setup-icon,
            .budget-ignore-icon {
                width: 12px;
                height: 12px;
            }
        }

        @media (max-width: 480px) {
            .summary-section {
                padding: 12px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .summary-card {
                padding: 12px;
            }
            
            .summary-value {
                font-size: 20px;
            }
        }



        /* Transaction List Styles */
        .transactions-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-left: auto;
            margin-right: auto;
        }

        .transactions-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .transaction-day {
            margin-bottom: 24px;
        }

        .day-header {
            background: transparent;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            font-size: 13px;
            font-weight: var(--font-weight-normal);
            color: #333;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-summary {
            font-size: 15px;
            font-weight: var(--font-weight-medium);
            color: #333;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .day-income {
            color: #333;
            font-weight: 500;
        }

        .day-expense {
            color: #333;
            font-weight: 500;
        }

        /* Mobile端优化 */
        @media (max-width: 768px) {
            .day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .day-summary {
                font-size: 15px;
                gap: 12px;
            }
            
            .day-date {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .day-summary {
                font-size: 14px;
                gap: 8px;
            }
            
            .day-date {
                font-size: 13px;
            }
            
            .transaction-item {
                padding: 8px;
                gap: 8px;
            }
            
            .category-icon {
                width: 32px !important;
                height: 32px !important;
                font-size: 16px !important;
            }
            
            .transaction-right {
                gap: 6px;
            }
            
            /* 移除旧的按钮样式，因为现在使用弹窗 */
            
            .transaction-amounts {
                gap: 2px;
            }
            
            .amount-primary {
                font-size: 14px;
            }
            
            .amount-secondary {
                font-size: 11px;
            }
        }

        @media (max-width: 360px) {
            .transaction-item {
                padding: 6px;
                gap: 6px;
            }
            
            .category-icon {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }
            
            .transaction-right {
                gap: 4px;
            }
            
            /* 移除旧的按钮样式，因为现在使用弹窗 */
            
            .amount-primary {
                font-size: 13px;
            }
            
            .amount-secondary {
                font-size: 10px;
            }
        }

        .transaction-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .transaction-category {
            background: #f8f9fa;
            color: #333;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }

        .transaction-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-notes {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .transaction-payer {
            font-size: 12px;
            color: #666;
        }

        .transaction-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: #f8f9fa;
            color: #666;
        }

        .status-approved {
            background: #f8f9fa;
            color: #666;
        }

        .status-rejected {
            background: #f8f9fa;
            color: #666;
        }

        .transaction-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .transaction-amounts {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .amount-primary {
            font-weight: 600;
            font-size: 16px;
        }

        .amount-secondary {
            font-size: 12px;
            color: #666;
        }

        .amount-positive {
            color: #333;
        }

        .amount-negative {
            color: #333;
        }

        /* 移除旧的按钮样式，因为现在使用弹窗 */

        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .no-transactions {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .filters-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .filters-grid {
            display: flex;
            gap: 16px;
            max-width: 100%;
            width: 100%;
            align-items: center;
            /* 防止内容过长时拉伸 */
            overflow: hidden;
        }

        .filter-row {
            display: contents;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* 确保每个筛选器组不会超出容器 */
            min-width: 0;
            max-width: 100%;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .filter-select {
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
            /* Safari优化 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* 自定义下拉箭头 */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            /* Safari边框优化 */
            border: 1px solid rgba(0, 0, 0, 0.1);
            /* Safari字体渲染优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* 字体颜色改为黑色 */
            color: #333;
            /* 限制最大宽度，防止被拉伸 */
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            /* 处理长文本溢出 */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-input {
            padding: 10px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s ease;
            /* 防止移动端自动放大 */
            font-size: 16px;
            transform: scale(1);
            -webkit-transform: scale(1);
            min-width: 120px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* 限制最大宽度，防止被拉伸 */
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            /* 处理长文本溢出 */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Search notes输入框特殊样式 */
        #notes-search {
            padding-left: 12px;
            padding-right: 40px;
        }

        /* 清除搜索按钮样式 */
        .clear-search-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }

        .clear-search-btn:hover {
            opacity: 0.8;
        }

        .clear-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
            filter: grayscale(100%) brightness(0.7);
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-input::placeholder {
            color: #999;
        }


        /* Safari特定优化 */
        @supports (-webkit-appearance: none) {
            .filter-select {
                /* Safari圆角优化 */
                border-radius: 8px;
                /* Safari背景优化 */
                background-color: white;
            }
            
            .filter-select:hover {
                border-color: #667eea;
                box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
            }
            
            .filter-select:active {
                transform: translateY(1px);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
        }





        .btn-primary {
            background: #667eea;
            color: white;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            line-height: 1.2;
            box-sizing: border-box;
        }

        .btn-primary:hover {
            background: #5a67d8;
            border-color: #5a67d8;
        }

        /* Filter Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background-color: #f8f9fa;
        }

        .modal-body {
            padding: 24px;
        }

        .filter-modal-group {
            margin-bottom: 20px;
        }

        .filter-modal-group:last-child {
            margin-bottom: 0;
        }

        .filter-modal-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            line-height: 1.2;
            box-sizing: border-box;
        }

        .btn-secondary:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        /* Custom Confirmation Modal Styles */
        .custom-modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .custom-modal.show {
            display: flex;
        }

        .custom-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .custom-modal-header {
            padding: 24px 24px 16px 24px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .custom-modal-body {
            padding: 20px 24px;
            text-align: center;
        }

        .custom-modal-message {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin: 0;
        }

        .custom-modal-actions {
            padding: 16px 24px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .custom-modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            min-width: 80px;
        }

        .custom-modal-btn-secondary {
            background: transparent;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-secondary:hover {
            background: rgba(102, 126, 234, 0.05);
            color: #667eea;
        }

        .custom-modal-btn-danger {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-danger:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .custom-modal-btn-primary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-primary:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .custom-modal-btn-warning {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .custom-modal-btn-warning:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .transaction-actions-modal-buttons {
            flex-direction: column;
            gap: 8px;
        }

        .transaction-actions-modal-buttons .custom-modal-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-start;
            width: 100%;
            text-align: left;
            background: rgba(102, 126, 234, 0.1) !important;
            color: #667eea !important;
            border: 1px solid rgba(102, 126, 234, 0.2) !important;
        }

        .transaction-actions-modal-buttons .custom-modal-btn:hover {
            background: rgba(102, 126, 234, 0.15) !important;
            color: #667eea !important;
        }

        .transaction-info {
            padding: 24px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            margin-bottom: 16px;
            text-align: center;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 24px;
        }



        /* Date Range Styles */
        .date-range-container {
            display: flex;
            gap: 24px;
            min-height: 400px;
        }

        .range-modes {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 100px;
        }

        .range-mode-btn {
            padding: 12px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            transition: all 0.2s ease;
        }

        .range-mode-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .range-mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .range-content {
            flex: 1;
            min-height: 400px;
        }

        .range-view {
            height: 100%;
        }

        /* Year Selection Styles */
        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .year-range {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .nav-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .year-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .year-btn {
            padding: 12px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .year-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .year-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .year-btn.default-selected {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.4);
        }

        /* Week and Month Selection Styles */
        .week-header, .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .week-range, .month-range {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .week-grid, .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .week-btn, .month-btn {
            padding: 10px 6px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .week-btn:hover, .month-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .week-btn.selected, .month-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .week-btn.default-selected, .month-btn.default-selected {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.4);
        }

        /* Calendar Styles */
        .calendar-container {
            display: flex;
            gap: 20px;
        }

        .calendar {
            flex: 1;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            padding: 8px 4px;
            border: 1px solid #eee;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .calendar-day.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calendar-day.default-selected {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.4);
        }

        .calendar-day.in-range {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calendar-day.other-month {
            color: #ccc;
            background: #f9f9f9;
        }

        .calendar-day-header {
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            color: #666;
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 16px;
            }

            .nav-menu {
                flex-direction: row;
                gap: 12px;
                justify-content: center;
            }


            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .filters-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .filter-row {
                display: flex;
                gap: 12px;
                width: 100%;
            }

            .filter-row .filter-group {
                flex: 1;
            }

            .filter-row:nth-child(2) .filter-group:first-child {
                flex: 3;
            }

            .filter-row:nth-child(2) .filter-group:last-child {
                flex: 0 0 auto;
                margin-left: auto;
            }

            .filter-row:last-child .filter-group {
                flex: 1;
            }

            .date-range-container {
                flex-direction: column;
                gap: 16px;
            }

            .calendar-container {
                flex-direction: column;
                gap: 16px;
            }
            
            .calendar {
                min-width: 0;
                width: 100%;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
            }
            
            .calendar-day {
                padding: 6px 2px;
                font-size: 11px;
            }
            
            .calendar-day-header {
                padding: 6px 2px;
                font-size: 11px;
            }
            
            .modal-content {
                width: 95%;
                max-width: 500px;
                max-height: 90vh;
                margin: 5% auto;
            }
            
            .modal-body {
                padding: 16px;
                max-height: 70vh;
                overflow-y: auto;
            }

            /* 移动端Transaction Actions按钮样式优化 */
            .transaction-actions-modal-buttons .custom-modal-btn {
                box-shadow: none !important;
                text-shadow: none !important;
                -webkit-box-shadow: none !important;
                -webkit-text-shadow: none !important;
                filter: none !important;
                -webkit-filter: none !important;
                border: 1px solid #e9ecef !important;
                background: white !important;
                color: #667eea !important;
                font-weight: 500 !important;
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
            }

            .transaction-actions-modal-buttons .custom-modal-btn:hover {
                background: #f8f9fa !important;
                color: #5a67d8 !important;
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
            }

            .transaction-actions-modal-buttons .custom-modal-btn:active {
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
                transform: none !important;
            }

            /* 移动端图标渲染优化 - 增强版 */
            .transaction-actions-modal-buttons .custom-modal-btn img {
                /* 图像渲染优化 */
                image-rendering: -webkit-optimize-contrast !important;
                image-rendering: crisp-edges !important;
                image-rendering: pixelated !important;
                -webkit-image-rendering: -webkit-optimize-contrast !important;
                -webkit-image-rendering: crisp-edges !important;
                -webkit-image-rendering: pixelated !important;
                
                /* 移除所有filter */
                filter: none !important;
                -webkit-filter: none !important;
                
                /* 硬件加速和3D变换 */
                transform: translateZ(0) scale(1.001) !important;
                -webkit-transform: translateZ(0) scale(1.001) !important;
                
                /* 背面可见性 */
                backface-visibility: hidden !important;
                -webkit-backface-visibility: hidden !important;
                
                /* 抗锯齿优化 */
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
                
                /* 像素对齐 */
                will-change: transform !important;
                -webkit-will-change: transform !important;
                
                /* 强制GPU渲染 */
                transform-style: preserve-3d !important;
                -webkit-transform-style: preserve-3d !important;
                
                /* 边缘优化 */
                outline: none !important;
                -webkit-outline: none !important;
                
                            /* 确保像素完美对齐 */
            width: 18px !important;
            height: 18px !important;
            flex-shrink: 0 !important;
            
            /* 高分辨率优化 */
            image-resolution: 144dpi !important;
            -webkit-image-resolution: 144dpi !important;
            
            /* 强制高质量渲染 */
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            image-rendering: pixelated !important;
            
            /* 移动端特殊优化 */
            -webkit-transform: translateZ(0) scale(1.002) !important;
            transform: translateZ(0) scale(1.002) !important;
            
            /* 确保锐利边缘 */
            -webkit-backface-visibility: hidden !important;
            backface-visibility: hidden !important;
            -webkit-perspective: 1000px !important;
            perspective: 1000px !important;
            
            /* 移动端高分辨率图标 */
            width: 20px !important;
            height: 20px !important;
            min-width: 20px !important;
            min-height: 20px !important;
            
            /* 强制高质量渲染 */
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            image-rendering: pixelated !important;
            -webkit-image-rendering: -webkit-optimize-contrast !important;
            -webkit-image-rendering: crisp-edges !important;
            -webkit-image-rendering: pixelated !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-container">
            <div class="brand">
                Money Tracker
            </div>
            <div class="nav-menu">
                <span class="nav-link active" title="Home">
                    <img src="assets/svg/home.svg?v=2" alt="Home" width="20" height="20">
                </span>
                <a href="analysis.html" class="nav-link" title="Analysis">
                    <img src="assets/svg/analysis.svg?v=2" alt="Analysis" width="20" height="20">
                </a>
                <a href="wallet.html" class="nav-link" title="Wallet">
                    <img src="assets/svg/wallet.svg?v=2" alt="Wallet" width="20" height="20">
                </a>
                <a href="settings.html" class="nav-link" title="Settings">
                    <img src="assets/svg/settings.svg?v=2" alt="Settings" width="20" height="20">
                </a>
                <a href="transaction.html" class="nav-link transaction-btn"><span>+Transaction</span></a>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="filters-section">
    
            <div class="filters-grid">
                <div class="filter-row">
                    <div class="filter-group">
                        <select id="ledger-filter" class="filter-select">
                            <option value="all">All Ledgers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="currency-filter" class="filter-select">
                            <!-- 币种选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <button id="date-range-btn" class="filter-select" style="text-align: left; cursor: pointer;">
                            Date Range
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="filters-btn" class="filter-select" style="text-align: left; cursor: pointer; background: #f8f9fa; border: 2px solid #e9ecef; display: flex; align-items: center; gap: 8px;">
                            <img src="assets/svg/filter.svg" alt="Filter" style="width: 16px; height: 16px; opacity: 0.7;">
                            <span id="filters-text"></span>
                        </button>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group" style="flex: 1; position: relative;">
                        <input type="text" id="notes-search" class="filter-input" placeholder="Search notes...">
                        <button type="button" id="clear-search" class="clear-search-btn" style="display: none;">
                            <img src="assets/svg/close.svg" alt="Clear" class="clear-icon">
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Modal -->
        <div id="filter-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Filters</h3>
                    <button id="close-filter-modal" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="filter-modal-group">
                        <label for="modal-payer-filter">Payer:</label>
                        <select id="modal-payer-filter" class="filter-select">
                            <option value="all">All Payers</option>
                        </select>
                    </div>
                    <div class="filter-modal-group">
                        <label for="modal-status-filter">Status:</label>
                        <select id="modal-status-filter" class="filter-select">
                            <option value="all">All Statuses</option>
                        </select>
                    </div>
                    <div class="filter-modal-group">
                        <label for="modal-category-filter">Category:</label>
                        <select id="modal-category-filter" class="filter-select">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="clear-filters" class="btn-secondary">Clear</button>
                    <button id="apply-filters" class="btn-primary">Apply</button>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
    
            <div class="summary-grid">
                <div class="summary-card expense">
                    <div class="summary-label">Total Expense</div>
                    <div class="summary-value" id="total-expense">$0.00</div>
                    <div class="budget-progress-container" id="budget-progress-container" style="display: none;">
                        <div class="budget-info" id="budget-info">
                            <div class="budget-usage" id="budget-usage">0% used</div>
                            <div class="budget-amount-container" id="budget-amount-container">
                                <span class="budget-amount" id="budget-amount">$0.00</span>
                                <button class="budget-edit-btn" onclick="navigateToBudgetSettings()">
                                    <img src="assets/svg/edit.svg" alt="Edit Budget" class="budget-edit-icon">
                                </button>
                            </div>
                        </div>
                        <div class="budget-progress-bar" id="budget-progress-bar">
                            <div class="budget-progress-fill" id="budget-progress-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="summary-card income">
                    <div class="summary-label">Total Income</div>
                    <div class="summary-value" id="total-income">$0.00</div>
                </div>
                <div class="summary-card net">
                    <div class="summary-label">Net Result</div>
                    <div class="summary-value" id="net-result">$0.00</div>
                </div>
                <div class="summary-card count">
                    <div class="summary-label">Transactions</div>
                    <div class="summary-value" id="transaction-count">0</div>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="transactions-section">
    
            <div id="transactions-container">
                <div class="loading-spinner">Loading transactions...</div>
            </div>
        </div>

    </div>



    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="confirm-title">Confirm Action</h3>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message" id="confirm-message">Are you sure you want to proceed?</p>
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="confirm-cancel">Cancel</button>
                <button class="custom-modal-btn custom-modal-btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-modal" style="z-index: 2000;">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="alert-title">Notice</h3>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message" id="alert-message">Operation completed.</p>
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-btn-primary" id="alert-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Transaction Actions Modal -->
    <div id="transaction-actions-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title">Transaction Actions</h3>
            </div>
            <div class="custom-modal-body">
                <div class="transaction-info" id="transaction-info">
                    <!-- Transaction info will be populated by JavaScript -->
                </div>
            </div>
            <div class="custom-modal-actions transaction-actions-modal-buttons">
                <button class="custom-modal-btn custom-modal-btn-primary" id="action-view">
                    <img src="assets/svg/view.svg?v=2" alt="View" width="18" height="18">
                    View
                </button>
                <button class="custom-modal-btn custom-modal-btn-secondary" id="action-edit">
                    <img src="assets/svg/edit.svg" alt="Edit" width="18" height="18">
                    Edit
                </button>
                <button class="custom-modal-btn custom-modal-btn-warning" id="action-reimburse" style="display: none;">
                    <img src="assets/svg/complete.svg?v=2" alt="Reimburse" width="18" height="18">
                    Reimburse
                </button>
                <button class="custom-modal-btn custom-modal-btn-warning" id="action-cancel-reimburse" style="display: none;">
                    <img src="assets/svg/undo.svg?v=2" alt="Cancel" width="18" height="18">
                    Cancel Reimbursement
                </button>
                <button class="custom-modal-btn custom-modal-btn-danger" id="action-delete">
                    <img src="assets/svg/delete.svg?v=2" alt="Delete" width="18" height="18">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Date Range Modal -->
    <div id="date-range-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Date Range</h3>
                <span class="close" onclick="hideDateRangeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="date-range-container">
                    <div class="range-modes">
                        <button class="range-mode-btn" data-mode="week">Week</button>
                        <button class="range-mode-btn" data-mode="month">Month</button>
                        <button class="range-mode-btn" data-mode="year">Year</button>
                        <button class="range-mode-btn" data-mode="custom">Custom</button>
                        <button class="range-mode-btn" data-mode="all">All Time</button>
                    </div>
                    <div class="range-content">
                        <!-- Week Selection View -->
                        <div id="week-view" class="range-view" style="display: none;">
                            <div class="week-header">
                                <button class="nav-btn" id="prev-week">&lt;</button>
                                <span id="week-range">Week (2024)</span>
                                <button class="nav-btn" id="next-week">&gt;</button>
                            </div>
                            <div class="week-grid" id="week-grid">
                                <!-- Weeks will be populated by JavaScript -->
                            </div>
                        </div>
                        <!-- Month Selection View -->
                        <div id="month-view" class="range-view" style="display: none;">
                            <div class="month-header">
                                <button class="nav-btn" id="prev-month">&lt;</button>
                                <span id="month-range">Month (2024)</span>
                                <button class="nav-btn" id="next-month">&gt;</button>
                            </div>
                            <div class="month-grid" id="month-grid">
                                <!-- Months will be populated by JavaScript -->
                            </div>
                        </div>
                        <!-- Year Selection View -->
                        <div id="year-view" class="range-view" style="display: none;">
                            <div class="year-header">
                                <button class="nav-btn" id="prev-year">&lt;</button>
                                <span id="year-range">Year (2006-2025)</span>
                                <button class="nav-btn" id="next-year">&gt;</button>
                            </div>
                            <div class="year-grid" id="year-grid">
                                <!-- Years will be populated by JavaScript -->
                            </div>
                        </div>
                        <!-- Custom Date Range View -->
                        <div id="custom-view" class="range-view" style="display: none;">
                            <div class="calendar-container">
                                <div class="calendar">
                                    <div class="calendar-header">
                                        <button class="nav-btn" id="prev-custom-month">&lt;</button>
                                        <span id="month1">August</span>
                                        <span></span>
                                    </div>
                                    <div class="calendar-grid" id="calendar1">
                                        <!-- Calendar 1 will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div class="calendar">
                                    <div class="calendar-header">
                                        <span></span>
                                        <span id="month2">September</span>
                                        <button class="nav-btn" id="next-custom-month">&gt;</button>
                                    </div>
                                    <div class="calendar-grid" id="calendar2">
                                        <!-- Calendar 2 will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/timezoneManager.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.56.0/dist/umd/supabase.js"></script>
    <script type="module">
        import { formatCompactWithTitle, applyNumberFormat } from './assets/js/numberFormat.js';
        
        const supabase = window.supabase.createClient('https://glduiypkpsuxzdjscuhq.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsZHVpeXBrcHN1eHpkanNjdWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzYwOTEsImV4cCI6MjA3MTAxMjA5MX0.dZO3fa7PCcJG0yxSbtJXPVbp31c-C4VAFKmk9SOtji8');

        // 初始化时区管理器
        window.timezoneManager = new TimezoneManager(supabase);

        // 全局筛选器状态
        let globalFilters = {
            ledger: 'all',
            payer: 'all',
            status: 'all',
            currency: 'SGD', // 将在初始化时更新为第一个币种
            category: 'all',
            notesSearch: '',
            dateRange: {
                mode: 'all',
                value: null
            }
        };

        // 从sessionStorage加载筛选器状态
        function loadFilters() {
            const saved = sessionStorage.getItem('moneyTrackerFilters');
            if (saved) {
                globalFilters = JSON.parse(saved);
            }
            
            // 如果没有保存的Date Range模式，设置默认值
            if (globalFilters.dateRange.mode === 'all' || !globalFilters.dateRange.mode) {
                globalFilters.dateRange.mode = 'month';
                // 设置默认的月份值
                if (!globalFilters.dateRange.value) {
                    globalFilters.dateRange.value = {
                        month: new Date().getMonth(),
                        year: new Date().getFullYear()
                    };
                }
            }

            // 兼容旧的缓存：为新增字段设置默认值
            if (!('category' in globalFilters)) {
                globalFilters.category = 'all';
            }
            if (!('notesSearch' in globalFilters)) {
                globalFilters.notesSearch = '';
            }
        }

        // 保存筛选器状态到sessionStorage
        function saveFilters() {
            sessionStorage.setItem('moneyTrackerFilters', JSON.stringify(globalFilters));
        }

        // 应用筛选器到页面
        function applyFilters() {
            document.getElementById('ledger-filter').value = globalFilters.ledger;
            document.getElementById('currency-filter').value = globalFilters.currency;
            document.getElementById('notes-search').value = globalFilters.notesSearch || '';
            
            // Update modal dropdowns
            document.getElementById('modal-payer-filter').value = globalFilters.payer || 'all';
            document.getElementById('modal-status-filter').value = globalFilters.status || 'all';
            document.getElementById('modal-category-filter').value = globalFilters.category || 'all';
            
            // 更新Date Range按钮文本
            updateDateRangeButtonText();
            // Update filter button text
            updateFilterButtonText();
        }
        


        // 获取Ledger选项（支持访问控制开关）
        async function loadLedgers() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];

                if (useAccessControl) {
                    try {
                        // 读取当前用户ID
                        const currentUser = await getCurrentUserInfo();
                        // 仅加载我有成员关系的账本
                        const { data: ledgers, error } = await supabase
                            .from('ledgers')
                            .select('id, name, ledger_members!inner(user_id)')
                            .eq('is_active', true)
                            .eq('ledger_members.user_id', currentUser.id)
                            .order('name');
                        if (error) throw error;
                        data = ledgers || [];
                        // 无权限时显示空状态（不再回退显示全部）
                        if (data.length === 0) {
                            console.log('用户无账本权限，显示空状态');
                        }
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        // 如果用户不存在或没有权限，显示空状态
                        data = [];
                    }
                } else {
                    // 旧逻辑：加载全部活跃账本
                    const { data: allLedgers, error } = await supabase
                        .from('ledgers')
                        .select('id, name')
                        .eq('is_active', true)
                        .order('name');
                    if (error) throw error;
                    data = allLedgers || [];
                }

                const select = document.getElementById('ledger-filter');
                select.innerHTML = '<option value="all">All Ledgers</option>';

                data.forEach(ledger => {
                    const option = document.createElement('option');
                    option.value = ledger.id;
                    option.textContent = ledger.name;
                    select.appendChild(option);
                });

                // 如果没有保存的筛选器状态，设置第一个账本为默认值
                const saved = sessionStorage.getItem('moneyTrackerFilters');
                if (!saved && data.length > 0) {
                    globalFilters.ledger = data[0].id;
                    saveFilters();
                }

                // 如果没有账本，显示友好提示
                if (data.length === 0 && useAccessControl) {
                    console.log('🔍 条件满足，准备显示友好提示');
                    console.log('data.length:', data.length);
                    console.log('useAccessControl:', useAccessControl);
                    const showMessage = showNoLedgerMessage();
                    if (showMessage) {
                        // 如果显示了友好提示，停止后续初始化
                        return true;
                    }
                } else {
                    console.log('🔍 条件不满足，不显示友好提示');
                    console.log('data.length:', data.length);
                    console.log('useAccessControl:', useAccessControl);
                }
            } catch (error) {
                console.error('Error loading ledgers:', error);
            }
        }

        // 获取Payer选项
        async function loadPayers() {
            try {
                const { data, error } = await supabase
                    .from('allowed_users')
                    .select('id, email, display_name')
                    .eq('is_active', true)
                    .order('display_name');
                
                if (error) throw error;
                
                // 构建email到UUID的映射
                userUUIDMap = {};
                data.forEach(user => {
                    userUUIDMap[user.email] = user.id;
                });
                
                const modalSelect = document.getElementById('modal-payer-filter');
                modalSelect.innerHTML = '<option value="all">All Payers</option>';
                
                data.forEach(user => {
                    const modalOption = document.createElement('option');
                    modalOption.value = user.email; // 使用email作为筛选值，因为用户更熟悉email
                    modalOption.textContent = user.display_name || user.email;
                    modalSelect.appendChild(modalOption);
                });
            } catch (error) {
                console.error('Error loading payers:', error);
            }
        }

        // 获取Category选项
        async function loadCategories() {
            try {
                let query = supabase
                    .from('categories')
                    .select('id, name, emoji, background_color, parent_type, ledger_id')
                    .order('name');

                // 当选择了特定的ledger时，仅加载该ledger下的分类
                if (globalFilters.ledger && globalFilters.ledger !== 'all') {
                    query = query.eq('ledger_id', globalFilters.ledger);
                }

                const { data, error } = await query;
                if (error) throw error;

                const previous = globalFilters.category || 'all';
                const modalSelect = document.getElementById('modal-category-filter');
                modalSelect.innerHTML = '<option value="all">All Categories</option>';
                
                let hasPrevious = false;
                data.forEach(category => {
                    const modalOption = document.createElement('option');
                    modalOption.value = category.id;
                    modalOption.textContent = `${category.emoji || ''} ${category.name}`.trim();
                    if (category.id === previous) hasPrevious = true;
                    modalSelect.appendChild(modalOption);
                });

                // 恢复或重置选择
                modalSelect.value = hasPrevious ? previous : 'all';
                if (!hasPrevious) {
                    globalFilters.category = 'all';
                    saveFilters();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // 获取Status选项
        async function loadStatuses() {
            try {
                const { data, error } = await supabase
                    .from('reimbursement_status')
                    .select('code, name')
                    .eq('is_active', true)
                    .order('name');
                
                if (error) throw error;
                
                const modalSelect = document.getElementById('modal-status-filter');
                modalSelect.innerHTML = '<option value="all">All Statuses</option>';
                
                data.forEach(status => {
                    const modalOption = document.createElement('option');
                    modalOption.value = status.code;
                    // 格式化显示文本：首字母大写，下划线替换为空格
                    const formattedName = status.code.replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());
                    modalOption.textContent = formattedName;
                    modalSelect.appendChild(modalOption);
                });
            } catch (error) {
                console.error('Error loading statuses:', error);
            }
        }



        // 检查用户认证状态
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            

        }

        // 筛选器变化事件
        document.getElementById('ledger-filter').addEventListener('change', async function(e) {
            globalFilters.ledger = e.target.value;
            // 切换账本时需要按账本重新加载分类
            await loadCategories();
            // 防止旧的category在新账本下无效
            if (document.getElementById('modal-category-filter').value === 'all') {
                globalFilters.category = 'all';
            } else {
                globalFilters.category = document.getElementById('modal-category-filter').value;
            }
            saveFilters();
            reloadData();
        });

        // Filter modal functionality
        const filterModal = document.getElementById('filter-modal');
        const filtersBtn = document.getElementById('filters-btn');
        const closeFilterModal = document.getElementById('close-filter-modal');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFilters = document.getElementById('clear-filters');

        // Open modal
        filtersBtn.addEventListener('click', function() {
            // Sync modal values with current filters
            document.getElementById('modal-payer-filter').value = globalFilters.payer || 'all';
            document.getElementById('modal-status-filter').value = globalFilters.status || 'all';
            document.getElementById('modal-category-filter').value = globalFilters.category || 'all';
            
            // Update filter button text
            updateFilterButtonText();
            
            filterModal.style.display = 'flex';
        });

        // Close modal
        closeFilterModal.addEventListener('click', function() {
            filterModal.style.display = 'none';
        });

        // Close modal when clicking outside
        filterModal.addEventListener('click', function(e) {
            if (e.target === filterModal) {
                filterModal.style.display = 'none';
            }
        });

        // Apply filters
        applyFiltersBtn.addEventListener('click', function() {
            globalFilters.payer = document.getElementById('modal-payer-filter').value;
            globalFilters.status = document.getElementById('modal-status-filter').value;
            globalFilters.category = document.getElementById('modal-category-filter').value;
            
            saveFilters();
            reloadData();
            updateFilterButtonText();
            filterModal.style.display = 'none';
        });

        // Clear all filters
        clearFilters.addEventListener('click', function() {
            document.getElementById('modal-payer-filter').value = 'all';
            document.getElementById('modal-status-filter').value = 'all';
            document.getElementById('modal-category-filter').value = 'all';
            
            globalFilters.payer = 'all';
            globalFilters.status = 'all';
            globalFilters.category = 'all';
            
            saveFilters();
            reloadData();
            updateFilterButtonText();
            filterModal.style.display = 'none';
        });

        // Function to update filter button text
        function updateFilterButtonText() {
            const activeFilters = [];
            if (globalFilters.payer && globalFilters.payer !== 'all') {
                activeFilters.push(globalFilters.payer);
            }
            if (globalFilters.status && globalFilters.status !== 'all') {
                activeFilters.push(globalFilters.status);
            }
            if (globalFilters.category && globalFilters.category !== 'all') {
                activeFilters.push(globalFilters.category);
            }
            
            const filterText = activeFilters.length > 0 ? `(${activeFilters.length})` : '';
            document.getElementById('filters-text').textContent = filterText;
        }

        document.getElementById('currency-filter').addEventListener('change', async function(e) {
            globalFilters.currency = e.target.value;
            saveFilters();
            await updateSummary();
            renderTransactions();
        });


        // 防抖搜索函数
        let searchTimeout;
        function debounceSearch(value) {
            clearTimeout(searchTimeout);
            
            // 显示搜索状态
            const searchInput = document.getElementById('notes-search');
            searchInput.style.opacity = '0.7';
            
            searchTimeout = setTimeout(() => {
                globalFilters.notesSearch = value;
                saveFilters();
                reloadData().then(() => {
                    // 搜索完成后恢复状态
                    searchInput.style.opacity = '1';
                });
            }, 500); // 500毫秒延迟
        }

        document.getElementById('notes-search').addEventListener('input', function(e) {
            debounceSearch(e.target.value);
            // 控制清除按钮的显示/隐藏
            const clearBtn = document.getElementById('clear-search');
            if (e.target.value.trim() !== '') {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
        });

        // 清除搜索按钮功能
        document.getElementById('clear-search').addEventListener('click', function() {
            const searchInput = document.getElementById('notes-search');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.value = '';
            clearBtn.style.display = 'none';
            
            // 清除搜索并重新加载数据
            globalFilters.notesSearch = '';
            saveFilters();
            reloadData();
        });

        // Date Range相关变量
        let currentYearRange = { start: 2006, end: 2025 };
        let currentYear = new Date().getFullYear();
        let currentMonth1 = new Date().getMonth();
        let currentMonth2 = new Date().getMonth() + 1;
        let currentYear1 = new Date().getFullYear();
        let currentYear2 = new Date().getFullYear();
        
        // 处理currentMonth2的年份跨越
        if (currentMonth2 > 11) {
            currentMonth2 = 0;
            currentYear2++;
        }
        let selectedStartDate = null;
        let selectedEndDate = null;
        let selectedYear = null;
        let selectedWeek = null;
        let selectedMonth = null;
        let currentWeekYear = new Date().getFullYear();
        let currentMonthYear = new Date().getFullYear();
        let currentWeekPage = 1;
        let isFirstTimeWeek = true; // 标记是否是第一次进入Week模式

        // 获取当前日期是第几周
        function getCurrentWeekOfYear() {
            const now = new Date();
            const jan1 = new Date(now.getFullYear(), 0, 1);
            const startOfYear = new Date(jan1);
            // 调整到最近的周一
            const dayOfWeek = jan1.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startOfYear.setDate(jan1.getDate() - daysToMonday);
            
            const diffTime = now.getTime() - startOfYear.getTime();
            const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
            return Math.max(1, diffWeeks);
        }



        // 获取指定年份和周的日期范围（修复版本）
        function getWeekDateRange(year, week, showYear = false) {
            // 获取该年第一周的起始日期（以周一为开始）
            const jan1 = new Date(year, 0, 1);
            const startOfYear = new Date(jan1);
            // 调整到最近的周一
            const dayOfWeek = jan1.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startOfYear.setDate(jan1.getDate() - daysToMonday);
            
            // 计算指定周的起始日期
            const startOfWeek = new Date(startOfYear);
            startOfWeek.setDate(startOfYear.getDate() + (week - 1) * 7);
            
            // 计算指定周的结束日期
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // 格式化日期为 MM/DD 格式
            const formatDate = (date) => {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}/${day}`;
            };
            
            if (showYear) {
                // 检查是否跨年
                if (startOfWeek.getFullYear() === endOfWeek.getFullYear()) {
                    // 同一年：只显示 MM/DD-MM/DD
                    return `${formatDate(startOfWeek)}-${formatDate(endOfWeek)}`;
                } else {
                    // 跨年：显示 MM/DD/YYYY-MM/DD/YYYY
                    const formatDateWithYear = (date) => {
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const day = date.getDate().toString().padStart(2, '0');
                        const year = date.getFullYear();
                        return `${month}/${day}/${year}`;
                    };
                    return `${formatDateWithYear(startOfWeek)}-${formatDateWithYear(endOfWeek)}`;
                }
            } else {
                // 弹窗内部：始终显示 MM/DD-MM/DD 格式
                return `${formatDate(startOfWeek)}-${formatDate(endOfWeek)}`;
            }
        }

        // 获取Custom日期范围文本（修复版本）
        function getCustomDateRangeText(startDate, endDate, showYear = false) {
            // 对于custom模式，直接解析日期字符串，避免时区转换
            let start, end;
            
            if (typeof startDate === 'string' && startDate.includes('T')) {
                // 如果是UTC时间字符串，提取日期部分
                start = new Date(startDate.split('T')[0] + 'T00:00:00');
                end = new Date(endDate.split('T')[0] + 'T00:00:00');
            } else {
                // 如果是日期字符串，直接解析
                start = new Date(startDate);
                end = new Date(endDate);
            }
            
            // 调试信息
            console.log('getCustomDateRangeText input:', { startDate, endDate });
            console.log('getCustomDateRangeText parsed:', { start, end });
            
            if (showYear) {
                // 外部按钮：智能显示年份
                if (start.getFullYear() === end.getFullYear()) {
                    // 同一年：隐藏年份
                    const result = `${start.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit'})}-${end.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit'})}`;
                    console.log('getCustomDateRangeText result:', result);
                    return result;
                } else {
                    // 跨年：显示完整日期
                    const result = `${start.toLocaleDateString()}-${end.toLocaleDateString()}`;
                    console.log('getCustomDateRangeText result:', result);
                    return result;
                }
            } else {
                // 弹窗内部：始终显示 MM/DD-MM/DD 格式
                const result = `${start.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit'})}-${end.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit'})}`;
                console.log('getCustomDateRangeText result:', result);
                return result;
            }
        }

        // 更新Date Range按钮文本
        function updateDateRangeButtonText() {
            const btn = document.getElementById('date-range-btn');
            const dateRange = globalFilters.dateRange;
            
            if (dateRange.mode === 'all') {
                btn.textContent = 'All Time';
            } else if (dateRange.mode === 'week' && dateRange.value) {
                // 智能显示周日期格式
                const weekDates = getWeekDateRange(dateRange.value.year, dateRange.value.week, true);
                btn.textContent = weekDates;
            } else if (dateRange.mode === 'month' && dateRange.value) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                btn.textContent = `${monthNames[dateRange.value.month]} ${dateRange.value.year}`;
            } else if (dateRange.mode === 'year' && dateRange.value) {
                btn.textContent = `${dateRange.value}`;
            } else if (dateRange.mode === 'custom' && dateRange.value) {
                // 使用新的Custom日期范围格式化函数
                const customText = getCustomDateRangeText(dateRange.value.start, dateRange.value.end, true);
                btn.textContent = customText;
            } else {
                btn.textContent = 'Date Range';
            }
        }

                // 显示Date Range弹窗
        function showDateRangeModal() {
            const modal = document.getElementById('date-range-modal');
            modal.style.display = 'block';
            
            // 添加点击外围关闭弹窗功能
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideDateRangeModal();
                }
            });
            
            // 重置第一次进入标记
            isFirstTimeWeek = true;
            
            // 设置当前模式
            let currentMode = globalFilters.dateRange.mode;
            
            // 如果没有保存的模式或模式为'all'，默认设置为'month'
            if (currentMode === 'all' || !currentMode) {
                currentMode = 'month';
                globalFilters.dateRange.mode = 'month';
            }
            
            document.querySelector(`[data-mode="${currentMode}"]`).classList.add('active');
            
            // 设置当前选择的值
            if (currentMode === 'week' && globalFilters.dateRange.value) {
                selectedWeek = globalFilters.dateRange.value.week;
                currentWeekYear = globalFilters.dateRange.value.year;
                // 计算当前周所在的页面
                currentWeekPage = Math.ceil(selectedWeek / 28);
                isFirstTimeWeek = false; // 有保存的选择，不是第一次
            } else if (currentMode === 'month' && globalFilters.dateRange.value) {
                selectedMonth = globalFilters.dateRange.value.month;
                currentMonthYear = globalFilters.dateRange.value.year;
            } else if (currentMode === 'year' && globalFilters.dateRange.value) {
                selectedYear = globalFilters.dateRange.value;
            } else {
                // 如果没有保存的选择，设置默认值
                if (currentMode === 'week') {
                    const currentWeek = getCurrentWeekOfYear();
                    currentWeekPage = Math.ceil(currentWeek / 28);
                    selectedWeek = currentWeek;
                    // 确保使用当前年份
                    currentWeekYear = new Date().getFullYear();
                    console.log(`Setting week page: ${currentWeekPage}, selected week: ${selectedWeek}, year: ${currentWeekYear}`);
                } else if (currentMode === 'month') {
                    selectedMonth = new Date().getMonth();
                    currentMonthYear = new Date().getFullYear();
                } else if (currentMode === 'year') {
                    selectedYear = new Date().getFullYear();
                }
            }
            
            showRangeView(currentMode);
        }

        // 隐藏Date Range弹窗
        function hideDateRangeModal() {
            const modal = document.getElementById('date-range-modal');
            modal.style.display = 'none';
        }
        
        // 挂载到全局作用域
        window.hideDateRangeModal = hideDateRangeModal;
        


        

        

        


        // 显示指定的范围视图
        function showRangeView(mode) {
            // 隐藏所有视图
            document.getElementById('week-view').style.display = 'none';
            document.getElementById('month-view').style.display = 'none';
            document.getElementById('year-view').style.display = 'none';
            document.getElementById('custom-view').style.display = 'none';
            
            // 移除所有按钮的active状态
            document.querySelectorAll('.range-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 激活当前模式按钮
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            if (mode === 'week') {
                document.getElementById('week-view').style.display = 'block';
                // 如果是第一次进入Week模式，设置默认值
                if (isFirstTimeWeek) {
                    const currentWeek = getCurrentWeekOfYear();
                    currentWeekPage = Math.ceil(currentWeek / 28);
                    selectedWeek = currentWeek;
                    isFirstTimeWeek = false;
                    console.log(`First time entering Week mode: currentWeek=${currentWeek}, page=${currentWeekPage}`);
                }
                renderWeekView();
            } else if (mode === 'month') {
                document.getElementById('month-view').style.display = 'block';
                // 如果是第一次进入Month模式，设置默认值
                if (!selectedMonth) {
                    selectedMonth = new Date().getMonth();
                }
                renderMonthView();
            } else if (mode === 'year') {
                document.getElementById('year-view').style.display = 'block';
                // 如果是第一次进入Year模式，设置默认值
                if (!selectedYear) {
                    selectedYear = new Date().getFullYear();
                }
                // 动态调整年份范围，确保当前年份在范围内
                const currentYear = new Date().getFullYear();
                currentYearRange.start = currentYear - 10;
                currentYearRange.end = currentYear + 9;
                renderYearView();
            } else if (mode === 'custom') {
                document.getElementById('custom-view').style.display = 'block';
                renderCustomView();
            } else if (mode === 'all') {
                // All Time模式：直接确认选择
                globalFilters.dateRange.mode = 'all';
                globalFilters.dateRange.value = null;
                saveFilters();
                updateDateRangeButtonText();
                hideDateRangeModal();
                reloadData();
            }
        }

        // 渲染周视图
        function renderWeekView() {
            const weekGrid = document.getElementById('week-grid');
            const weekRange = document.getElementById('week-range');
            
            weekRange.textContent = `Week (${currentWeekYear})`;
            weekGrid.innerHTML = '';
            
            // 计算当前页的起始周
            const weeksPerPage = 28;
            const startWeek = 1 + (currentWeekPage - 1) * weeksPerPage;
            const endWeek = Math.min(startWeek + weeksPerPage - 1, 52);
            
            // 生成当前页的周按钮
            for (let week = startWeek; week <= endWeek; week++) {
                const weekBtn = document.createElement('button');
                weekBtn.className = 'week-btn';
                
                // 计算该周的日期范围
                const weekDates = getWeekDateRange(currentWeekYear, week);
                weekBtn.textContent = weekDates;
                weekBtn.onclick = () => selectWeek(week);
                
                if (week === selectedWeek) {
                    // 检查是否是默认值（当前周且未有实际选择）
                    const isDefaultValue = selectedWeek === getCurrentWeekOfYear() && 
                                         (!globalFilters.dateRange || globalFilters.dateRange.mode !== 'week');
                    weekBtn.classList.add(isDefaultValue ? 'default-selected' : 'selected');
                }
                
                weekGrid.appendChild(weekBtn);
            }
        }



        // 渲染月份视图
        function renderMonthView() {
            const monthGrid = document.getElementById('month-grid');
            const monthRange = document.getElementById('month-range');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            monthRange.textContent = `Month (${currentMonthYear})`;
            monthGrid.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthBtn = document.createElement('button');
                monthBtn.className = 'month-btn';
                monthBtn.textContent = monthNames[month];
                monthBtn.onclick = () => selectMonth(month);
                
                if (month === selectedMonth) {
                    // 检查是否是默认值（当前月份且未有实际选择）
                    const isDefaultValue = selectedMonth === new Date().getMonth() && 
                                         (!globalFilters.dateRange || globalFilters.dateRange.mode !== 'month');
                    monthBtn.classList.add(isDefaultValue ? 'default-selected' : 'selected');
                }
                
                monthGrid.appendChild(monthBtn);
            }
        }

        // 渲染年份视图
        function renderYearView() {
            const yearGrid = document.getElementById('year-grid');
            const yearRange = document.getElementById('year-range');
            
            yearRange.textContent = `Year (${currentYearRange.start}-${currentYearRange.end})`;
            yearGrid.innerHTML = '';
            
            for (let year = currentYearRange.start; year <= currentYearRange.end; year++) {
                const yearBtn = document.createElement('button');
                yearBtn.className = 'year-btn';
                yearBtn.textContent = year;
                yearBtn.onclick = () => selectYear(year);
                
                if (year === selectedYear) {
                    // 检查是否是默认值（当前年份且未有实际选择）
                    const isDefaultValue = selectedYear === new Date().getFullYear() && 
                                         (!globalFilters.dateRange || globalFilters.dateRange.mode !== 'year');
                    yearBtn.classList.add(isDefaultValue ? 'default-selected' : 'selected');
                }
                
                yearGrid.appendChild(yearBtn);
            }
        }

        // 渲染自定义日期范围视图
        function renderCustomView() {
            renderCalendar(1, currentMonth1);
            renderCalendar(2, currentMonth2);
            updateCalendarHeaders();
        }

        // 渲染日历
        function renderCalendar(calendarNum, month) {
            const calendar = document.getElementById(`calendar${calendarNum}`);
            const year = calendarNum === 1 ? currentYear1 : currentYear2;
            const date = new Date(year, month, 1);
            
            calendar.innerHTML = '';
            
            // 添加星期标题
            const daysOfWeek = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // 获取月份的第一天是星期几（0是星期日，1是星期一）
            const firstDayOfWeek = date.getDay();
            const adjustedFirstDay = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // 调整为星期一开始
            
            // 添加空白天数
            for (let i = 0; i < adjustedFirstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendar.appendChild(emptyDay);
            }
            
            // 添加月份天数
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.onclick = () => selectDate(calendarNum, year, month, day);
                
                const currentDate = new Date(year, month, day);
                if (selectedStartDate && selectedEndDate) {
                    if (currentDate >= selectedStartDate && currentDate <= selectedEndDate) {
                        dayElement.classList.add('in-range');
                    }
                }
                if (selectedStartDate && currentDate.getTime() === selectedStartDate.getTime()) {
                    dayElement.classList.add('selected');
                }
                if (selectedEndDate && currentDate.getTime() === selectedEndDate.getTime()) {
                    dayElement.classList.add('selected');
                }
                
                calendar.appendChild(dayElement);
            }
        }

        // 更新日历标题
        function updateCalendarHeaders() {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            document.getElementById('month1').textContent = `${monthNames[currentMonth1]} ${currentYear1}`;
            document.getElementById('month2').textContent = `${monthNames[currentMonth2]} ${currentYear2}`;
        }

        // 选择周
        function selectWeek(week) {
            selectedWeek = week;
            document.querySelectorAll('.week-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            // 找到对应的按钮并添加selected类
            document.querySelectorAll('.week-btn').forEach(btn => {
                const weekDates = getWeekDateRange(currentWeekYear, week);
                if (btn.textContent === weekDates) {
                    btn.classList.add('selected');
                }
            });
            
            // 保存选择并生效
            globalFilters.dateRange = {
                mode: 'week',
                value: {
                    week: selectedWeek,
                    year: currentWeekYear
                }
            };
            saveFilters();
            updateDateRangeButtonText();
            hideDateRangeModal();
            reloadData();
        }

        // 选择月份
        function selectMonth(month) {
            selectedMonth = month;
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            // 找到对应的按钮并添加selected类
            document.querySelectorAll('.month-btn').forEach(btn => {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                if (btn.textContent === monthNames[month]) {
                    btn.classList.add('selected');
                }
            });
            
            // 保存选择并生效
            globalFilters.dateRange = {
                mode: 'month',
                value: {
                    month: selectedMonth,
                    year: currentMonthYear
                }
            };
            saveFilters();
            updateDateRangeButtonText();
            hideDateRangeModal();
            reloadData();
        }

        // 选择年份
        function selectYear(year) {
            selectedYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            // 找到对应的按钮并添加selected类
            document.querySelectorAll('.year-btn').forEach(btn => {
                if (btn.textContent == year) {
                    btn.classList.add('selected');
                }
            });
            
            // 保存选择并生效
            globalFilters.dateRange = {
                mode: 'year',
                value: selectedYear
            };
            saveFilters();
            updateDateRangeButtonText();
            hideDateRangeModal();
            reloadData();
        }

        // 选择日期
        async function selectDate(calendarNum, year, month, day) {
            const selectedDate = new Date(year, month, day);
            
            if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                selectedStartDate = selectedDate;
                selectedEndDate = null;
            } else {
                if (selectedDate < selectedStartDate) {
                    selectedEndDate = selectedStartDate;
                    selectedStartDate = selectedDate;
                } else {
                    selectedEndDate = selectedDate;
                }
            }
            
            renderCustomView();
            
            // 如果选择了两个日期，自动保存并生效
            if (selectedStartDate && selectedEndDate) {
                // 保存本地日期字符串，避免时区转换问题
                const startDateStr = `${selectedStartDate.getFullYear()}-${String(selectedStartDate.getMonth() + 1).padStart(2, '0')}-${String(selectedStartDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${selectedEndDate.getFullYear()}-${String(selectedEndDate.getMonth() + 1).padStart(2, '0')}-${String(selectedEndDate.getDate()).padStart(2, '0')}`;
                
                console.log('selectDate - 选择的日期:', { selectedStartDate, selectedEndDate });
                console.log('selectDate - 保存的日期字符串:', { startDateStr, endDateStr });
                
                globalFilters.dateRange = {
                    mode: 'custom',
                    value: {
                        start: startDateStr,
                        end: endDateStr
                    }
                };
                saveFilters();
                updateDateRangeButtonText();
                hideDateRangeModal();
                reloadData();
            }
        }



        // 登出函数
        window.logout = async function() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        };



        // 临时清理localStorage的函数 - 调试用
        function clearLocalStorage() {
            localStorage.clear();
            console.log('localStorage已清理');
            location.reload();
        }
        
        // 模拟不同日期访问的函数 - 测试用
        function simulateDate(dateString) {
            const mockDate = new Date(dateString);
            
            // 保存原始的Date构造函数
            const OriginalDate = Date;
            
            // 创建模拟的Date构造函数
            function MockDate(...args) {
                if (args.length === 0) {
                    return new OriginalDate(mockDate);
                }
                return new OriginalDate(...args);
            }
            
            // 复制所有静态方法
            Object.setPrototypeOf(MockDate, OriginalDate);
            Object.getOwnPropertyNames(OriginalDate).forEach(name => {
                if (name !== 'length' && name !== 'name' && name !== 'prototype') {
                    MockDate[name] = OriginalDate[name];
                }
            });
            
            // 重写now方法
            MockDate.now = function() {
                return mockDate.getTime();
            };
            
            // 替换全局Date
            window.Date = MockDate;
            
            console.log('已模拟日期:', new Date().toLocaleDateString());
            console.log('当前周:', getCurrentWeekOfYear());
            console.log('当前月份:', new Date().getMonth());
            console.log('当前年份:', new Date().getFullYear());
        }
        
        // 恢复真实日期的函数
        function restoreRealDate() {
            Date = window.Date;
            console.log('已恢复真实日期:', new Date().toLocaleDateString());
        }
        
        // 快速测试不同日期的函数
        function testDate(dateString) {
            console.log('=== 测试日期:', dateString, '===');
            
            // 模拟日期
            const mockDate = new Date(dateString);
            const OriginalDate = Date;
            
            function MockDate(...args) {
                if (args.length === 0) {
                    return new OriginalDate(mockDate);
                }
                return new OriginalDate(...args);
            }
            
            Object.setPrototypeOf(MockDate, OriginalDate);
            MockDate.now = () => mockDate.getTime();
            window.Date = MockDate;
            
            // 清理localStorage并重新加载
            localStorage.clear();
            
            // 手动设置默认值
            globalFilters.dateRange.mode = 'month';
            globalFilters.dateRange.value = {
                month: mockDate.getMonth(),
                year: mockDate.getFullYear()
            };
            
            // 更新按钮文本
            updateDateRangeButtonText();
            
            console.log('模拟日期:', new Date().toLocaleDateString());
            console.log('Date Range按钮文本:', document.getElementById('date-range-btn').textContent);
            console.log('当前周:', getCurrentWeekOfYear());
            console.log('当前月份:', new Date().getMonth());
            console.log('当前年份:', new Date().getFullYear());
        }
        
        // 完整测试不同日期的函数（包括弹窗内部）
        function testDateComplete(dateString) {
            console.log('=== 完整测试日期:', dateString, '===');
            
            // 模拟日期
            const mockDate = new Date(dateString);
            const OriginalDate = Date;
            
            function MockDate(...args) {
                if (args.length === 0) {
                    return new OriginalDate(mockDate);
                }
                return new OriginalDate(...args);
            }
            
            Object.setPrototypeOf(MockDate, OriginalDate);
            MockDate.now = () => mockDate.getTime();
            window.Date = MockDate;
            
            // 清理localStorage
            localStorage.clear();
            
            // 手动设置默认值
            globalFilters.dateRange.mode = 'month';
            globalFilters.dateRange.value = {
                month: mockDate.getMonth(),
                year: mockDate.getFullYear()
            };
            
            // 设置弹窗内部变量 - 修复所有模式
            selectedMonth = mockDate.getMonth();
            currentMonthYear = mockDate.getFullYear();
            selectedYear = mockDate.getFullYear();
            currentWeekYear = mockDate.getFullYear();
            currentMonth1 = mockDate.getMonth();
            currentMonth2 = mockDate.getMonth() + 1;
            if (currentMonth2 > 11) {
                currentMonth2 = 0;
            }
            
            // 更新按钮文本
            updateDateRangeButtonText();
            
            console.log('模拟日期:', new Date().toLocaleDateString());
            console.log('Date Range按钮文本:', document.getElementById('date-range-btn').textContent);
            console.log('selectedMonth:', selectedMonth);
            console.log('currentMonthYear:', currentMonthYear);
            console.log('selectedYear:', selectedYear);
            console.log('currentWeekYear:', currentWeekYear);
            console.log('currentMonth1:', currentMonth1);
            console.log('currentMonth2:', currentMonth2);
            console.log('当前周:', getCurrentWeekOfYear());
        }
        
        // 在控制台中运行这些函数来测试
        window.clearLocalStorage = clearLocalStorage;
        window.simulateDate = simulateDate;
        window.restoreRealDate = restoreRealDate;
        window.testDate = testDate;
        window.testDateComplete = testDateComplete;

        // 添加Date Range事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // Date Range按钮点击事件
            document.getElementById('date-range-btn').addEventListener('click', showDateRangeModal);
            
            // 关闭弹窗事件
            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideDateRangeModal);
            }
            
            // 初始化清除搜索按钮的显示状态
            const searchInput = document.getElementById('notes-search');
            const clearBtn = document.getElementById('clear-search');
            if (searchInput.value.trim() !== '') {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            

            
            // 范围模式按钮事件
            document.querySelectorAll('.range-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    showRangeView(mode);
                });
            });
            
            // 周导航按钮事件
            document.getElementById('prev-week').addEventListener('click', function() {
                if (currentWeekPage > 1) {
                    currentWeekPage--;
                } else {
                    currentWeekYear--;
                    currentWeekPage = Math.ceil(52 / 28); // 计算总页数
                }
                renderWeekView();
            });
            
            document.getElementById('next-week').addEventListener('click', function() {
                const totalPages = Math.ceil(52 / 28);
                if (currentWeekPage < totalPages) {
                    currentWeekPage++;
                } else {
                    currentWeekYear++;
                    currentWeekPage = 1;
                }
                renderWeekView();
            });
            
            // 月份导航按钮事件
            document.getElementById('prev-month').addEventListener('click', function() {
                currentMonthYear--;
                renderMonthView();
            });
            
            document.getElementById('next-month').addEventListener('click', function() {
                currentMonthYear++;
                renderMonthView();
            });
            
            // 年份导航按钮事件
            document.getElementById('prev-year').addEventListener('click', function() {
                currentYearRange.start -= 20;
                currentYearRange.end -= 20;
                renderYearView();
            });
            
            document.getElementById('next-year').addEventListener('click', function() {
                currentYearRange.start += 20;
                currentYearRange.end += 20;
                renderYearView();
            });
            
            // Custom日期选择器月份导航按钮事件
            document.getElementById('prev-custom-month').addEventListener('click', function() {
                // 两个日历都往前一个月
                currentMonth1--;
                currentMonth2--;
                
                if (currentMonth1 < 0) {
                    currentMonth1 = 11;
                    currentYear1--;
                }
                if (currentMonth2 < 0) {
                    currentMonth2 = 11;
                    currentYear2--;
                }
                renderCustomView();
            });
            
            document.getElementById('next-custom-month').addEventListener('click', function() {
                // 两个日历都往后一个月
                currentMonth1++;
                currentMonth2++;
                
                if (currentMonth1 > 11) {
                    currentMonth1 = 0;
                    currentYear1++;
                }
                if (currentMonth2 > 11) {
                    currentMonth2 = 0;
                    currentYear2++;
                }
                renderCustomView();
            });
            
            // 点击弹窗外部关闭
            window.addEventListener('click', function(event) {
                const dateRangeModal = document.getElementById('date-range-modal');
                const settingsModal = document.getElementById('settings-modal');
                
                if (event.target === dateRangeModal) {
                    hideDateRangeModal();
                }
                
                if (event.target === settingsModal) {
                    hideSettingsModal();
                }
            });
        });

        // 交易数据相关变量
        let transactions = [];
        let currentPage = 0;
        const pageSize = 10;
        let isLoading = false;
        let hasMoreData = true;
        let userUUIDMap = {}; // 存储email到UUID的映射

        // 跳转到创建ledger页面
        function goToCreateLedger() {
            // 跳转到设置页面，并添加参数来指示要打开ledger部分
            window.location.href = 'settings.html?section=ledger&action=create';
        }

        // 将函数添加到全局作用域
        window.goToCreateLedger = goToCreateLedger;

        // 显示没有账本的友好提示
        function showNoLedgerMessage() {
            console.log('🔍 showNoLedgerMessage 被调用');
            const mainContainer = document.querySelector('.main-container');
            console.log('🔍 mainContainer 元素:', mainContainer);
            
            if (mainContainer) {
                console.log('🔍 准备替换 mainContainer 内容');
                mainContainer.innerHTML = `
                    <div style="text-align: center; padding: 48px 24px; max-width: 480px; margin: 0 auto; background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                        <div style="width: 64px; height: 64px; margin: 0 auto 24px; background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">📊</div>
                        <h2 style="color: #374151; margin-bottom: 16px; font-size: 20px; font-weight: 600; letter-spacing: -0.025em;">Welcome to Money Tracker!</h2>
                        <p style="color: #6b7280; margin-bottom: 32px; line-height: 1.6; font-size: 15px; max-width: 320px; margin-left: auto; margin-right: auto;">
                            It looks like you don't have any ledgers set up yet. Let's create your first ledger to start tracking your finances!
                        </p>
                        <button onclick="goToCreateLedger()" 
                                style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.2s ease;"
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
                            Create Your First Ledger
                        </button>
                    </div>
                `;
                console.log('🔍 mainContainer 内容已替换');
                
                // 停止后续的初始化流程，避免错误
                return true;
            } else {
                console.error('❌ 找不到 .main-container 元素');
                return false;
            }
        }

        // 获取当前用户信息
        async function getCurrentUserInfo() {
            try {
                console.log('Getting current user info...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
                console.log('Current user:', user.email);
                
                // 从userUUIDMap中获取当前用户的UUID和display_name
                console.log('userUUIDMap:', userUUIDMap);
                const currentUserUUID = userUUIDMap[user.email];
                if (!currentUserUUID) {
                    console.error('User not found in userUUIDMap:', user.email);
                    throw new Error('User not found in allowed_users table');
                }
                console.log('Current user UUID:', currentUserUUID);
                
                // 从allowed_users表中获取用户的display_name
                const { data: userData, error } = await supabase
                    .from('allowed_users')
                    .select('display_name')
                    .eq('id', currentUserUUID)
                    .single();
                
                if (error) throw error;
                
                const result = {
                    id: currentUserUUID,
                    name: userData.display_name || user.email.split('@')[0]
                };
                console.log('User info result:', result);
                return result;
            } catch (error) {
                console.error('Error getting current user info:', error);
                throw error;
            }
        }

        // 加载交易数据
        async function loadTransactions() {
            if (isLoading || !hasMoreData) return;
            
            isLoading = true;
            updateLoadingState(true);
            
            try {
                // 访问控制：仅加载有权限的账本/钱包的交易
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let userLedgerIds = [];
                let userWalletIds = [];
                if (useAccessControl) {
                    const currentUser = await getCurrentUserInfo();
                    // 获取有权限的账本ID列表
                    const { data: ledgerMembers, error: lmErr } = await supabase
                        .from('ledger_members')
                        .select('ledger_id')
                        .eq('user_id', currentUser.id);
                    if (lmErr) throw lmErr;
                    userLedgerIds = (ledgerMembers || []).map(m => m.ledger_id);
                    
                    // 获取有权限的钱包ID列表（personal owner + shared member）
                    const currentUserInfo = await getCurrentUserInfo();
                    const currentAllowedUserId = currentUserInfo ? currentUserInfo.id : null; // allowed_users.id (uuid)
                    if (currentAllowedUserId) {
                        const { data: personalWallets, error: pwErr } = await supabase
                            .from('wallets')
                            .select('id')
                            .eq('wallet_type', 'personal')
                            .eq('owner_id', currentAllowedUserId);
                        if (pwErr) throw pwErr;

                        const { data: sharedWallets, error: swErr } = await supabase
                            .from('wallets')
                            .select('id, wallet_members!inner(user_id)')
                            .eq('wallet_type', 'shared')
                            .eq('wallet_members.user_id', currentAllowedUserId);
                        if (swErr) throw swErr;

                        userWalletIds = [...(personalWallets || []).map(w => w.id), ...(sharedWallets || []).map(w => w.id)];
                    }
                }

                let query = supabase
                    .from('transactions')
                    .select(`
                        *,
                        ledgers(name),
                        reimbursement_status(name, code),
                        categories(name, emoji, background_color)
                    `)
                    .order('transaction_date', { ascending: false })
                    .range(currentPage * pageSize, (currentPage + 1) * pageSize - 1);

                // 访问控制：过滤交易
                if (useAccessControl) {
                    if (userLedgerIds.length > 0 || userWalletIds.length > 0) {
                        const conditions = [];
                        if (userLedgerIds.length > 0) conditions.push(`ledger_id.in.(${userLedgerIds.join(',')})`);
                        if (userWalletIds.length > 0) conditions.push(`wallet_id.in.(${userWalletIds.join(',')})`);
                        if (conditions.length > 0) {
                            query = query.or(conditions.join(','));
                        } else {
                            // 无权限数据，返回空结果
                            query = query.eq('id', '00000000-0000-0000-0000-000000000000');
                        }
                    } else {
                        // 无权限数据，返回空结果
                        query = query.eq('id', '00000000-0000-0000-0000-000000000000');
                    }
                }

                // 应用筛选器
                if (globalFilters.ledger !== 'all') {
                    query = query.eq('ledger_id', globalFilters.ledger);
                }
                if (globalFilters.payer !== 'all') {
                    const payerUUID = userUUIDMap[globalFilters.payer];
                    if (payerUUID) {
                        query = query.eq('payer_id', payerUUID);
                    }
                }
                if (globalFilters.status !== 'all') {
                    query = query.eq('reimbursement_status', globalFilters.status);
                }
                if (globalFilters.category !== 'all') {
                    query = query.eq('category_id', globalFilters.category);
                }
                if (globalFilters.notesSearch && globalFilters.notesSearch.trim() !== '') {
                    query = query.ilike('notes', `%${globalFilters.notesSearch.trim()}%`);
                }

                // 应用日期范围筛选器
                if (globalFilters.dateRange.mode !== 'all' && globalFilters.dateRange.value) {
                    const dateFilter = await buildDateFilter(globalFilters.dateRange);
                    if (dateFilter) {
                        query = query.gte('transaction_date', dateFilter.start)
                                   .lte('transaction_date', dateFilter.end);
                    }
                }

                const { data, error } = await query;
                
                if (error) throw error;
                
                if (data) {
                    if (currentPage === 0) {
                        transactions = data;
                    } else {
                        transactions = [...transactions, ...data];
                    }
                    
                    hasMoreData = data.length === pageSize;
                    currentPage++;
                    
                    await updateSummary();
                    renderTransactions();
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
            } finally {
                isLoading = false;
                updateLoadingState(false);
            }
        }

        // 构建日期筛选器
        async function buildDateFilter(dateRange) {
            if (!dateRange.value) return null;
            
            const now = new Date();
            let startDate, endDate;
            
            if (dateRange.mode === 'week') {
                const weekStart = getWeekStartDate(dateRange.value.year, dateRange.value.week);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                
                startDate = weekStart.toISOString();
                endDate = weekEnd.toISOString();
            } else if (dateRange.mode === 'month') {
                startDate = new Date(dateRange.value.year, dateRange.value.month, 1).toISOString();
                endDate = new Date(dateRange.value.year, dateRange.value.month + 1, 0, 23, 59, 59, 999).toISOString();
            } else if (dateRange.mode === 'year') {
                startDate = new Date(dateRange.value, 0, 1).toISOString();
                endDate = new Date(dateRange.value, 11, 31, 23, 59, 59, 999).toISOString();
            } else if (dateRange.mode === 'custom') {
                // 对于custom模式，使用时区管理器将本地日期转换为UTC时间范围
                const utcRange = await window.timezoneManager.getUTCDateRange(dateRange.value.start, dateRange.value.end);
                startDate = utcRange.utc_start;
                endDate = utcRange.utc_end;
            }
            
            return { start: startDate, end: endDate };
        }

        // 获取周开始日期
        function getWeekStartDate(year, week) {
            const jan1 = new Date(year, 0, 1);
            const startOfYear = new Date(jan1);
            const dayOfWeek = jan1.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startOfYear.setDate(jan1.getDate() - daysToMonday);
            
            const startOfWeek = new Date(startOfYear);
            startOfWeek.setDate(startOfYear.getDate() + (week - 1) * 7);
            return startOfWeek;
        }

        // 更新汇总数据
        async function updateSummary() {
            try {
                // 检查是否有后端API不支持的筛选条件
                const hasUnsupportedFilters = globalFilters.category !== 'all' || 
                    (globalFilters.notesSearch && globalFilters.notesSearch.trim() !== '');
                
                if (hasUnsupportedFilters) {
                    console.log('🔄 Using frontend calculation due to unsupported filters (category/notes)');
                    await fallbackUpdateSummary();
                    return;
                }
                
                let params = {
                    p_currency: globalFilters.currency
                };
                
                if (globalFilters.ledger !== 'all') {
                    params.p_ledger_id = parseInt(globalFilters.ledger);
                }
                if (globalFilters.payer !== 'all') {
                    const payerUUID = userUUIDMap[globalFilters.payer];
                    if (payerUUID) {
                        params.p_payer_id = payerUUID;
                    }
                }
                if (globalFilters.status !== 'all') {
                    params.p_status = globalFilters.status;
                }
                
                if (globalFilters.dateRange.mode !== 'all' && globalFilters.dateRange.value) {
                    const dateFilter = await buildDateFilter(globalFilters.dateRange);
                    if (dateFilter) {
                        params.p_start_date = dateFilter.start;
                        params.p_end_date = dateFilter.end;
                    }
                }
                
                // 当启用了访问控制且选择了 All Ledgers 时，后端RPC无法按成员做过滤，改用前端计算
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                if (useAccessControl && globalFilters.ledger === 'all') {
                    await fallbackUpdateSummary();
                    return;
                }

                console.log('🔍 Calling optimized backend API get_transaction_summary_optimized with params:', params);
                const { data, error } = await supabase.rpc('get_transaction_summary_optimized', params);
                
                if (error) {
                    console.error('❌ Error calling get_transaction_summary_optimized:', error);
                    console.log('🔄 Falling back to frontend calculation...');
                    await fallbackUpdateSummary();
                    return;
                }
                
                if (data && data.length > 0) {
                    const summary = data[0];
                    console.log('✅ Optimized backend API returned data:', summary);
                    
                    const totalExpense = parseFloat(summary.total_expense || 0);
                    const totalIncome = parseFloat(summary.total_income || 0);
                    const netResult = parseFloat(summary.net_result || 0);
                    
                    console.log(`💰 Summary calculated from optimized backend: Expense: ${totalExpense}, Income: ${totalIncome}, Net: ${netResult}, Count: ${summary.transaction_count}`);
                    
                    document.getElementById('total-expense').innerHTML = formatCurrency(totalExpense, globalFilters.currency);
                    document.getElementById('total-income').innerHTML = formatCurrency(totalIncome, globalFilters.currency);
                    document.getElementById('net-result').innerHTML = formatCurrency(netResult, globalFilters.currency);
                    document.getElementById('transaction-count').textContent = summary.transaction_count || 0;
                    
                    // 检查并显示预算进度（包含预算数据）
                    console.log('🔍 Budget data from backend:', {
                        budget_amount: summary.budget_amount,
                        has_budget: summary.has_budget,
                        budget_currency: summary.budget_currency
                    });
                    checkAndDisplayBudgetProgress(totalExpense, summary.budget_amount, summary.has_budget);
                } else {
                    console.log('⚠️ No data returned from optimized backend, falling back to frontend calculation');
                    await fallbackUpdateSummary();
                }
                
            } catch (error) {
                console.error('Error in updateSummary:', error);
                await fallbackUpdateSummary();
            }
        }
        
        // 备用汇总计算（当后端API失败时使用）
        async function fallbackUpdateSummary() {
            console.log('🔄 Using fallback frontend calculation with Supabase query');
            
            try {
                // 构建查询条件
                let query = supabase
                    .from('transactions')
                    .select('id, type, sgd_amount, cny_amount, usd_amount, myr_amount, notes, category_id, ledger_id, payer_id, reimbursement_status');
                
                // 访问控制：仅统计我有权限的账本/钱包
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                if (useAccessControl) {
                    const currentUser = await getCurrentUserInfo();
                    let userLedgerIds = [];
                    let userWalletIds = [];
                    // ledgers
                    const { data: lm, error: lmErr } = await supabase
                        .from('ledger_members')
                        .select('ledger_id')
                        .eq('user_id', currentUser.id);
                    if (lmErr) throw lmErr;
                    userLedgerIds = (lm || []).map(x => x.ledger_id);
                    // wallets
                    const currentAllowedUserId = currentUser.id;
                    const { data: personalWallets, error: pwErr } = await supabase
                        .from('wallets')
                        .select('id')
                        .eq('wallet_type', 'personal')
                        .eq('owner_id', currentAllowedUserId);
                    if (pwErr) throw pwErr;
                    const { data: sharedWallets, error: swErr } = await supabase
                        .from('wallets')
                        .select('id, wallet_members!inner(user_id)')
                        .eq('wallet_type', 'shared')
                        .eq('wallet_members.user_id', currentAllowedUserId);
                    if (swErr) throw swErr;
                    userWalletIds = [...(personalWallets || []).map(w => w.id), ...(sharedWallets || []).map(w => w.id)];

                    const conditions = [];
                    if (userLedgerIds.length > 0) conditions.push(`ledger_id.in.(${userLedgerIds.join(',')})`);
                    if (userWalletIds.length > 0) conditions.push(`wallet_id.in.(${userWalletIds.join(',')})`);
                    if (conditions.length > 0) {
                        query = query.or(conditions.join(','));
                    } else {
                        // 确保返回空
                        query = query.eq('id', '00000000-0000-0000-0000-000000000000');
                    }
                }

                // 应用筛选器
                if (globalFilters.ledger !== 'all') {
                    query = query.eq('ledger_id', parseInt(globalFilters.ledger));
                }
                if (globalFilters.payer !== 'all') {
                    const payerUUID = userUUIDMap[globalFilters.payer];
                    if (payerUUID) {
                        query = query.eq('payer_id', payerUUID);
                    }
                }
                if (globalFilters.status !== 'all') {
                    query = query.eq('reimbursement_status', globalFilters.status);
                }
                if (globalFilters.category !== 'all') {
                    query = query.eq('category_id', globalFilters.category);
                }
                if (globalFilters.notesSearch && globalFilters.notesSearch.trim() !== '') {
                    query = query.ilike('notes', `%${globalFilters.notesSearch.trim()}%`);
                }
                
                // 应用日期筛选
                if (globalFilters.dateRange.mode !== 'all' && globalFilters.dateRange.value) {
                    const dateFilter = await buildDateFilter(globalFilters.dateRange);
                    if (dateFilter) {
                        query = query.gte('transaction_date', dateFilter.start);
                        query = query.lte('transaction_date', dateFilter.end);
                    }
                }
                
                const { data: allTransactions, error } = await query;
                
                if (error) {
                    console.error('❌ Error querying transactions for fallback summary:', error);
                    return;
                }
                
                let totalExpense = 0;
                let totalIncome = 0;
                let filteredCount = 0;
                
                allTransactions.forEach(transaction => {
                    let amount = 0;
                    
                    // 根据当前选择的币种获取对应的金额
                    switch (globalFilters.currency) {
                        case 'SGD':
                            amount = parseFloat(transaction.sgd_amount || 0);
                            break;
                        case 'CNY':
                            amount = parseFloat(transaction.cny_amount || 0);
                            break;
                        case 'USD':
                            amount = parseFloat(transaction.usd_amount || 0);
                            break;
                        case 'MYR':
                            amount = parseFloat(transaction.myr_amount || 0);
                            break;
                        default:
                            amount = parseFloat(transaction.sgd_amount || 0);
                            break;
                    }
                    
                    if (transaction.type === 'expense') {
                        totalExpense += Math.abs(amount);
                    } else if (transaction.type === 'income') {
                        totalIncome += Math.abs(amount);
                    }
                    
                    filteredCount++;
                });
                
                const netResult = totalIncome - totalExpense;
                
                console.log(`💰 Summary calculated from Supabase query: Expense: ${totalExpense}, Income: ${totalIncome}, Net: ${netResult}, Count: ${filteredCount}`);
                
                // 更新显示
                document.getElementById('total-expense').innerHTML = formatCurrency(totalExpense, globalFilters.currency);
                document.getElementById('total-income').innerHTML = formatCurrency(totalIncome, globalFilters.currency);
                document.getElementById('net-result').innerHTML = formatCurrency(netResult, globalFilters.currency);
                document.getElementById('transaction-count').textContent = filteredCount;
                
                // 检查并显示预算进度（无预算数据）
                checkAndDisplayBudgetProgress(totalExpense, 0, false);
                
            } catch (error) {
                console.error('❌ Error in fallbackUpdateSummary:', error);
            }
        }

        // 格式化货币
        function formatCurrency(amount, currency) {
            const currencySymbols = {
                'SGD': 'S$',
                'USD': '$',
                'CNY': '¥',
                'MYR': 'RM'
            };
            
            const symbol = currencySymbols[currency] || currency;
            return `${symbol}${formatCompactWithTitle(Math.abs(amount))}`;
        }

        // 初始化币种选择器
        function initializeCurrencyFilter() {
            const currencyFilter = document.getElementById('currency-filter');
            currencyFilter.innerHTML = APP_CONFIG.generateCurrencyOptions();
            // 设置默认选择第一个币种
            const firstCurrency = APP_CONFIG.getCurrencyCodes()[0];
            if (firstCurrency) {
                currencyFilter.value = firstCurrency;
                globalFilters.currency = firstCurrency;
            }
        }

        // 渲染交易列表
        function renderTransactions() {
            const container = document.getElementById('transactions-container');
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="no-transactions">No transactions found</div>';
                return;
            }
            
            // 按日期分组交易
            const groupedTransactions = groupTransactionsByDate(transactions);
            
            let html = '';
            
            Object.keys(groupedTransactions).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const dayTransactions = groupedTransactions[date];
                const daySummary = calculateDaySummary(dayTransactions);
                
                // 使用存储的原始日期字符串进行格式化
                const originalDate = dayTransactions._originalDate || date;
                
                html += `
                    <div class="transaction-day">
                        <div class="day-header">
                            <div class="day-date">${formatDate(originalDate)}</div>
                            <div class="day-summary">
                                ${daySummary.expense > 0 ? `<span class="day-expense">Expense: ${formatCurrency(daySummary.expense, globalFilters.currency)}</span>` : ''}
                                ${daySummary.income > 0 ? `<span class="day-income">Income: ${formatCurrency(daySummary.income, globalFilters.currency)}</span>` : ''}
                            </div>
                        </div>
                        ${dayTransactions.map(transaction => renderTransactionItem(transaction)).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加事件监听器
            addTransactionEventListeners();
        }

        // 按日期分组交易 - 优先使用本地时间
        function groupTransactionsByDate(transactions) {
            const grouped = {};
            
            transactions.forEach(transaction => {
                // 使用时区管理器转换UTC时间为本地时间
                const localTimeString = window.timezoneManager.convertToLocalTime(transaction.transaction_date);
                const localDate = new Date(localTimeString);
                
                // 直接使用本地日期的年月日，避免时区偏移
                const year = localDate.getFullYear();
                const month = String(localDate.getMonth() + 1).padStart(2, '0');
                const day = String(localDate.getDate()).padStart(2, '0');
                const dateOnly = `${year}-${month}-${day}`;
                
                const transactionDate = new Date(dateOnly + 'T00:00:00');
                const dateKey = transactionDate.toDateString();
                
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                    // 存储原始日期字符串用于格式化
                    grouped[dateKey]._originalDate = dateOnly;
                }
                grouped[dateKey].push(transaction);
            });
            
            return grouped;
        }

        // 计算每日汇总
        function calculateDaySummary(transactions) {
            let expense = 0;
            let income = 0;
            
            transactions.forEach(transaction => {
                let amount = 0;
                
                // 根据当前选择的币种获取对应的金额
                switch (globalFilters.currency) {
                    case 'SGD':
                        amount = parseFloat(transaction.sgd_amount || 0);
                        break;
                    case 'CNY':
                        amount = parseFloat(transaction.cny_amount || 0);
                        break;
                    case 'USD':
                        amount = parseFloat(transaction.usd_amount || 0);
                        break;
                    case 'MYR':
                        amount = parseFloat(transaction.myr_amount || 0);
                        break;
                    default:
                        amount = parseFloat(transaction.sgd_amount || 0);
                        break;
                }
                
                if (transaction.type === 'expense') {
                    expense += Math.abs(amount);
                } else if (transaction.type === 'income') {
                    income += Math.abs(amount);
                }
            });
            
            return { expense, income };
        }

        // 格式化日期 - 使用时区管理器
        function formatDate(dateString) {
            // 添加调试信息
            console.log('formatDate input:', dateString);
            
            // 使用时区管理器转换UTC时间为本地时间
            const localTimeString = window.timezoneManager.convertToLocalTime(dateString);
            const date = new Date(localTimeString);
            console.log('parsed date:', date);
            
            // 检查日期是否有效
            if (isNaN(date.getTime())) {
                console.error('Invalid date:', dateString, 'parsed as:', date);
                return 'Invalid Date';
            }
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }

        // 渲染单个交易项
        function renderTransactionItem(transaction) {
            let amount = 0;
            
            // 根据当前选择的币种获取对应的金额
            switch (globalFilters.currency) {
                case 'SGD':
                    amount = parseFloat(transaction.sgd_amount || 0);
                    break;
                case 'CNY':
                    amount = parseFloat(transaction.cny_amount || 0);
                    break;
                case 'USD':
                    amount = parseFloat(transaction.usd_amount || 0);
                    break;
                case 'MYR':
                    amount = parseFloat(transaction.myr_amount || 0);
                    break;
                default:
                    amount = parseFloat(transaction.sgd_amount || 0);
                    break;
            }
            
            const isIncome = transaction.type === 'income';
            const statusClass = getStatusClass(transaction.reimbursement_status?.code);
            const statusText = formatStatusText(transaction.reimbursement_status?.code);
            const isPending = transaction.reimbursement_status?.code === 'pending';
            
            // 创建category icon显示，包含Pending状态的紫色小圆点
            let categoryIcon = '';
            if (transaction.categories?.emoji && transaction.categories?.background_color) {
                categoryIcon = `
                    <div class="category-icon-container" style="position: relative; margin-right: 16px;">
                        <div class="category-icon" style="
                            width: 48px; 
                            height: 48px; 
                            border-radius: 12px; 
                            background-color: ${transaction.categories.background_color}; 
                            color: white; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 24px;
                        ">${transaction.categories.emoji}</div>
                        ${isPending ? `
                            <div class="pending-indicator" style="
                                position: absolute;
                                top: -2px;
                                right: -2px;
                                width: 12px;
                                height: 12px;
                                background-color: #9C27B0;
                                border-radius: 50%;
                                border: 2px solid white;
                            "></div>
                        ` : ''}
                    </div>
                `;
            }
            
            return `
                <div class="transaction-item" data-id="${transaction.id}" onclick="showTransactionActions('${transaction.id}').catch(console.error)" style="cursor: pointer;">
                    <div class="transaction-left" style="display: flex; align-items: center; flex: 1;">
                        ${categoryIcon}
                        <div class="transaction-details" style="display: flex; flex-direction: column; gap: 4px;">
                            <div class="transaction-category-name" style="font-weight: 600; font-size: 16px; color: #333;">
                                ${transaction.categories?.name || 'Unknown'}
                            </div>
                            ${transaction.allowed_users?.display_name || transaction.allowed_users?.email ? `
                                <div class="transaction-payer" style="font-size: 14px; color: #666;">
                                    ${transaction.allowed_users.display_name || transaction.allowed_users.email}
                                </div>
                            ` : ''}
                            ${transaction.notes ? `
                                <div class="transaction-notes" style="font-size: 14px; color: #666;">
                                    ${window.innerWidth <= 768 ? (transaction.notes.length > 66 ? transaction.notes.substring(0, 66) + '...' : transaction.notes) : transaction.notes}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="transaction-right">
                        <div class="transaction-amounts">
                            <div class="amount-primary ${isIncome ? 'amount-positive' : 'amount-negative'}">
                                ${isIncome ? '+' : ''}${formatCurrency(amount, globalFilters.currency)}
                            </div>
                            <div class="amount-secondary">
                                ${formatCurrency(parseFloat(transaction.amount || 0), transaction.currency)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'status-pending';
                case 'approved': return 'status-approved';
                case 'rejected': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        // 格式化状态文本
        function formatStatusText(status) {
            if (!status) return 'Pending';
            return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // 更新加载状态
        function updateLoadingState(loading) {
            const container = document.getElementById('transactions-container');
            if (loading && transactions.length === 0) {
                container.innerHTML = '<div class="loading-spinner">Loading transactions...</div>';
            }
        }

        // 添加交易事件监听器
        function addTransactionEventListeners() {
            // 滚动加载更多
            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                    loadTransactions();
                }
            });
        }

        // 查看交易
        function viewTransaction(id) {
            window.location.href = `transaction.html?mode=view&id=${id}`;
        }

        // 编辑交易
        async function editTransaction(id) {
            try {
                // 检查交易是否已经报销
                const hasActiveReimbursement = await checkActiveReimbursement(id);
                if (hasActiveReimbursement) {
                    await showCustomAlert(
                        'Cannot Edit Transaction', 
                        'This transaction has been reimbursed. Please cancel the reimbursement first before editing the transaction.',
                        'OK',
                        'warning'
                    );
                    return;
                }
                
                // 如果未报销，允许编辑
            window.location.href = `transaction.html?mode=edit&id=${id}`;
            } catch (error) {
                console.error('Error checking reimbursement status for edit:', error);
                await showCustomAlert('Error', 'Failed to check transaction status. Please try again.');
            }
        }

        // Custom confirmation and alert functions
        function showCustomConfirm(title, message, confirmText = 'Delete', cancelText = 'Cancel', type = 'danger') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel');
                const confirmBtn = document.getElementById('confirm-delete');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                cancelBtn.textContent = cancelText;
                confirmBtn.textContent = confirmText;
                
                // Update button styles based on type
                confirmBtn.className = `custom-modal-btn custom-modal-btn-${type}`;
                
                modal.classList.add('show');
                
                const handleConfirm = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve(false);
                };
                
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleOutsideClick);
            });
        }

        function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-alert-modal');
                const titleEl = document.getElementById('alert-title');
                const messageEl = document.getElementById('alert-message');
                const okBtn = document.getElementById('alert-ok');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                modal.classList.add('show');
                
                const handleOk = () => {
                    modal.classList.remove('show');
                    cleanup();
                    resolve();
                };
                
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        handleOk();
                    }
                };
                
                const cleanup = () => {
                    okBtn.removeEventListener('click', handleOk);
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                okBtn.addEventListener('click', handleOk);
                modal.addEventListener('click', handleOutsideClick);
            });
        }

        // 删除交易
        async function deleteTransaction(id) {
            try {
                // 检查是否有未撤销的报销
                const hasActiveReimbursement = await checkActiveReimbursement(id);
                if (hasActiveReimbursement) {
                    await showCustomAlert(
                        'Cannot Delete Transaction',
                        'This transaction has been reimbursed. Please cancel the reimbursement first before deleting the transaction.',
                        'warning'
                    );
                    return;
                }

            const confirmed = await showCustomConfirm(
                'Delete Transaction',
                'Are you sure you want to delete this transaction? This action cannot be undone.',
                'Delete',
                'Cancel',
                'danger'
            );
            
            if (!confirmed) return;
            
            try {
                // 读取交易以便回滚钱包
                const { data: tx, error: readErr } = await supabase
                    .from('transactions')
                    .select('id, wallet_id, amount, type')
                    .eq('id', id)
                    .single();
                if (readErr) throw readErr;

                const { error } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;

                // 回滚钱包余额并写入钱包流水
                if (tx && tx.wallet_id) {
                    const delta = (tx.type === 'income' ? -1 : 1) * parseFloat(tx.amount || 0);
                    const { data: u, error: ue } = await supabase.auth.getUser();
                    const currentUserName = u?.user?.user_metadata?.full_name || u?.user?.email || 'Unknown';

                    // 获取钱包当前余额
                    const { data: w, error: wErr } = await supabase
                        .from('wallets')
                        .select('id, balance, currency')
                        .eq('id', tx.wallet_id)
                        .single();
                    if (!wErr && w) {
                        const newBalance = (parseFloat(w.balance || 0) + delta).toFixed(2);
                        await supabase
                            .from('wallets')
                            .update({ balance: newBalance, last_editor_name: currentUserName, updated_at: new Date().toISOString() })
                            .eq('id', tx.wallet_id);
                        await supabase
                            .from('wallet_entries')
                            .insert([{
                                wallet_id: tx.wallet_id,
                                entry_type: 'transaction',
                                amount: parseFloat(delta.toFixed(2)),
                                balance_after: newBalance,
                                currency: w.currency,
                                reference_id: tx.id,
                                reference_type: 'transaction',
                                description: 'Transaction deleted',
                                created_at: new Date().toISOString()
                            }]);
                    }
                }
                
                // 重新加载数据
                currentPage = 0;
                hasMoreData = true;
                transactions = [];
                await loadTransactions();
            } catch (error) {
                console.error('Error deleting transaction:', error);
                await showCustomAlert('Error', 'Failed to delete transaction. Please try again.');
                }
            } catch (error) {
                console.error('Error in delete transaction check:', error);
                await showCustomAlert('Error', 'Failed to check transaction status. Please try again.');
            }
        }

        // 检查是否有活跃的报销（未撤销的）
        async function checkActiveReimbursement(transactionId) {
            try {
                // 首先检查wallet_entries表中的报销记录（新逻辑）
                const { data: originalEntries, error: originalError } = await supabase
                    .from('wallet_entries')
                    .select('id, reimbursement_pair_id')
                    .eq('reference_id', transactionId)
                    .eq('entry_type', 'reimbursement')
                    .is('reimbursement_reversal_of', null) // 原始报销记录
                    .order('created_at', { ascending: false }); // 按时间倒序，最新的在前
                
                if (originalError) throw originalError;
                
                // 如果有wallet_entries记录，使用新逻辑
                if (originalEntries && originalEntries.length > 0) {
                    // 检查最新的报销记录是否有对应的撤销记录
                    const latestPairId = originalEntries[0].reimbursement_pair_id;
                    const { data: reversalEntries, error: reversalError } = await supabase
                        .from('wallet_entries')
                        .select('id')
                        .eq('reference_id', transactionId)
                        .eq('entry_type', 'reimbursement')
                        .eq('reimbursement_reversal_of', latestPairId) // 对应的撤销记录
                        .limit(1);
                    
                    if (reversalError) throw reversalError;
                    
                    // 如果最新的报销记录没有撤销记录，说明报销仍然活跃
                    return !reversalEntries || reversalEntries.length === 0;
                }
                
                // 如果没有wallet_entries记录，检查transactions表的reimbursement_status（兼容历史数据）
                const { data: transaction, error: transactionError } = await supabase
                    .from('transactions')
                    .select('reimbursement_status, reimbursement_canceler_id')
                    .eq('id', transactionId)
                    .single();
                
                if (transactionError) throw transactionError;
                
                // 如果reimbursement_status是'reimbursed'且没有取消报销人，说明报销仍然活跃
                if (transaction && transaction.reimbursement_status === 'reimbursed' && !transaction.reimbursement_canceler_id) {
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Error checking active reimbursement:', error);
                return false;
            }
        }

        // 报销交易
        async function reimburseTransaction(id) {
            // 防止重复点击 - 立即设置标志
            if (window.processingReimbursement) {
                console.log('Reimbursement already in progress, ignoring duplicate request');
                return;
            }
            window.processingReimbursement = true;
            
            console.log('Starting reimbursement for transaction:', id);
            try {
                
                // 获取交易信息
                const transaction = transactions.find(t => t.id === id);
                if (!transaction) {
                    console.error('Transaction not found:', id);
                    await showCustomAlert('Error', 'Transaction not found.');
                    return;
                }
                console.log('Transaction found:', transaction);

                // 检查是否已经报销
                console.log('Checking if transaction already reimbursed...');
                const hasReimbursement = await checkTransactionReimbursement(id);
                if (hasReimbursement) {
                    console.log('Transaction already reimbursed');
                    await showCustomAlert('Error', 'This transaction has already been reimbursed.');
                    return;
                }

                // 获取共享钱包列表
                console.log('Loading shared wallets...');
                const sharedWallets = await getSharedWallets();
                console.log('Shared wallets:', sharedWallets);
                if (sharedWallets.length === 0) {
                    await showCustomAlert('Error', 'No shared wallets available for reimbursement.');
                    return;
                }

                // 显示共享钱包选择弹窗
                console.log('Showing wallet selector...');
                const selectedWallet = await showSharedWalletSelector(sharedWallets, transaction);
                if (!selectedWallet) {
                    console.log('No wallet selected');
                    return;
                }
                console.log('Selected wallet:', selectedWallet);

                // 确认报销
            const confirmed = await showCustomConfirm(
                'Reimburse Transaction',
                    `Are you sure you want to reimburse this transaction from ${selectedWallet.name}?`,
                'Reimburse',
                'Cancel',
                'primary'
            );
            
                if (!confirmed) {
                    console.log('Reimbursement cancelled by user');
                    return;
                }
                
                // 执行报销
                console.log('Processing reimbursement...');
                await processReimbursement(id, selectedWallet, transaction);
                
                // 重新加载数据
                console.log('Reloading transactions...');
                currentPage = 0;
                hasMoreData = true;
                transactions = [];
                await loadTransactions();
                console.log('Reimbursement completed successfully');
            } catch (error) {
                console.error('Error reimbursing transaction:', error);
                await showCustomAlert('Error', `Failed to reimburse transaction: ${error.message}`);
            } finally {
                window.processingReimbursement = false;
            }
        }

        // 检查交易是否已报销（使用与checkActiveReimbursement相同的逻辑）
        async function checkTransactionReimbursement(transactionId) {
            return await checkActiveReimbursement(transactionId);
        }

        // 获取共享钱包列表（支持访问控制）
        async function getSharedWallets() {
            try {
                const useAccessControl = !!(window.APP_CONFIG && window.APP_CONFIG.accessControl && window.APP_CONFIG.accessControl.enabled);
                let data = [];

                if (useAccessControl) {
                    try {
                        const currentUser = await getCurrentUserInfo();
                        // 只获取用户有权限的共享钱包
                        const { data: sharedWallets, error } = await supabase
                            .from('wallets')
                            .select('id, name, currency, balance, wallet_members!inner(user_id)')
                            .eq('wallet_type', 'shared')
                            .eq('is_archived', false)
                            .eq('wallet_members.user_id', currentUser.id)
                            .order('name');
                        if (error) throw error;
                        data = sharedWallets || [];
                    } catch (userError) {
                        console.error('Error getting user info:', userError);
                        data = [];
                    }
                } else {
                    // 旧逻辑：加载全部共享钱包
                    const { data: allSharedWallets, error } = await supabase
                        .from('wallets')
                        .select('id, name, currency, balance')
                        .eq('wallet_type', 'shared')
                        .eq('is_archived', false)
                        .order('name');
                    if (error) throw error;
                    data = allSharedWallets || [];
                }
                
                return data;
            } catch (error) {
                console.error('Error loading shared wallets:', error);
                return [];
            }
        }

        // 显示共享钱包选择器
        async function showSharedWalletSelector(sharedWallets, transaction) {
            return new Promise((resolve) => {
                console.log('Creating wallet selector modal...');
                
                // 创建弹窗HTML - 使用应用标准样式
                const modalHtml = `
                    <div id="wallet-selector-modal" style="
                        position: fixed;
                        z-index: 1000;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.5);
                        backdrop-filter: blur(5px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 0;
                            width: 90%;
                            max-width: 450px;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                            animation: modalSlideIn 0.3s ease-out;
                            overflow: hidden;
                        ">
                            <div style="
                                padding: 24px 24px 16px 24px;
                                text-align: center;
                                border-bottom: 1px solid #f0f0f0;
                                position: relative;
                            ">
                                <h3 style="
                                    font-size: 20px;
                                    font-weight: 600;
                                    color: #333;
                                    margin: 0;
                                ">Select Shared Wallet</h3>
                                <button type="button" onclick="closeWalletSelector()" style="
                                    position: absolute;
                                    top: 20px;
                                    right: 20px;
                                    background: none;
                                    border: none;
                                    font-size: 24px;
                                    color: #999;
                                    cursor: pointer;
                                    width: 32px;
                                    height: 32px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border-radius: 50%;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.backgroundColor='#f5f5f5'; this.style.color='#666';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#999';">×</button>
                                <p style="
                                    font-size: 14px;
                                    color: #666;
                                    margin: 8px 0 0 0;
                                    line-height: 1.4;
                                ">
                                    Choose a shared wallet to reimburse this transaction from:
                                </p>
                            </div>
                            <div style="padding: 20px 24px;">
                                <div style="max-height: 300px; overflow-y: auto; padding: 2px 0;">
                                    ${sharedWallets.map(wallet => `
                                        <div class="wallet-option" data-wallet-id="${wallet.id}" style="
                                            padding: 20px;
                                            border: 2px solid #f0f0f0;
                                            border-radius: 12px;
                                            margin-bottom: 12px;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
                                            position: relative;
                                            overflow: hidden;
                                        " onmouseover="
                                            this.style.borderColor='rgba(102, 126, 234, 0.3)';
                                            this.style.backgroundColor='rgba(102, 126, 234, 0.05)';
                                            this.style.transform='translateY(-2px)';
                                            this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.15)';
                                        " onmouseout="
                                            this.style.borderColor='#f0f0f0';
                                            this.style.backgroundColor='linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%)';
                                            this.style.transform='translateY(0)';
                                            this.style.boxShadow='none';
                                        ">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                <div style="font-weight: 600; color: #333; font-size: 16px;">${wallet.name}</div>
                                                <div style="font-size: 12px; color: #999; background: rgba(102, 126, 234, 0.1); padding: 4px 8px; border-radius: 12px;">${wallet.currency}</div>
                                            </div>
                                            <div style="font-size: 18px; font-weight: 600; color: #667eea;">
                                                ${formatCurrency(parseFloat(wallet.balance), wallet.currency)}
                                            </div>
                                            <div style="font-size: 12px; color: #999; margin-top: 4px;">Available</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="
                                padding: 16px 24px 24px 24px;
                                display: flex;
                                gap: 12px;
                                justify-content: center;
                            ">
                                <button type="button" onclick="closeWalletSelector()" style="
                                    padding: 12px 24px;
                                    background: #f5f5f5;
                                    color: #666;
                                    border: 1px solid #e0e0e0;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.backgroundColor='#eeeeee'; this.style.borderColor='#d0d0d0';" onmouseout="this.style.backgroundColor='#f5f5f5'; this.style.borderColor='#e0e0e0';">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;

                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                console.log('Modal HTML added to page');

                // 添加点击事件
                document.querySelectorAll('.wallet-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const walletId = option.dataset.walletId;
                        const selectedWallet = sharedWallets.find(w => w.id === walletId);
                        console.log('Wallet selected:', selectedWallet);
                        
                        // 直接关闭弹窗并返回选中的钱包
                        const modal = document.getElementById('wallet-selector-modal');
                        if (modal) {
                            modal.remove();
                            console.log('Modal removed');
                        }
                        resolve(selectedWallet);
                    });
                });

                // 关闭函数（只用于取消按钮和X按钮）
                window.closeWalletSelector = () => {
                    console.log('Closing wallet selector (cancelled)...');
                    const modal = document.getElementById('wallet-selector-modal');
                    if (modal) {
                        modal.remove();
                        console.log('Modal removed');
                    }
                    resolve(null);
                };
                
                console.log('Wallet selector modal created and ready');
            });
        }

        // 处理报销
        async function processReimbursement(transactionId, sharedWallet, transaction) {
            try {
                // 获取当前用户信息
                const currentUser = await getCurrentUserInfo();
                
                // 生成报销配对ID
                const reimbursementPairId = crypto.randomUUID();
                
                // 获取交易钱包信息
                const originalTransactionWallet = await getWalletById(transaction.wallet_id);
                if (!originalTransactionWallet) {
                    throw new Error('Transaction wallet not found');
                }
                
                // 确定个人钱包和共享钱包
                // 原始交易钱包是共享钱包，需要找到对应的个人钱包
                let personalWallet, companyWallet;
                if (originalTransactionWallet.wallet_type === 'shared') {
                    // 原始交易在共享钱包，需要找到个人钱包
                    companyWallet = originalTransactionWallet;
                    // 这里需要根据用户信息找到对应的个人钱包
                    // 暂时使用一个简单的方法：查找用户的个人钱包
                    const { data: personalWallets, error: personalError } = await supabase
                        .from('wallets')
                        .select('*')
                        .eq('wallet_type', 'personal')
                        .eq('is_archived', false)
                        .limit(1);
                    
                    if (personalError || !personalWallets || personalWallets.length === 0) {
                        throw new Error('Personal wallet not found');
                    }
                    personalWallet = personalWallets[0];
                } else {
                    // 原始交易在个人钱包，共享钱包是用户选择的
                    personalWallet = originalTransactionWallet;
                    companyWallet = sharedWallet;
                }

                // 计算报销金额（使用原始交易的币种和金额）
                let reimbursementAmount = 0;
                let transactionCurrency = '';
                
                // 根据原始交易钱包的币种确定报销金额
                if (originalTransactionWallet.currency === 'SGD') {
                    reimbursementAmount = parseFloat(transaction.sgd_amount || 0);
                    transactionCurrency = 'SGD';
                } else if (originalTransactionWallet.currency === 'CNY') {
                    reimbursementAmount = parseFloat(transaction.cny_amount || 0);
                    transactionCurrency = 'CNY';
                } else if (originalTransactionWallet.currency === 'USD') {
                    reimbursementAmount = parseFloat(transaction.usd_amount || 0);
                    transactionCurrency = 'USD';
                } else if (originalTransactionWallet.currency === 'MYR') {
                    reimbursementAmount = parseFloat(transaction.myr_amount || 0);
                    transactionCurrency = 'MYR';
                } else {
                    throw new Error('Invalid transaction currency');
                }

                if (reimbursementAmount <= 0) {
                    throw new Error('Invalid reimbursement amount');
                }

                // 计算各钱包的金额（正确的报销逻辑）
                // 个人钱包：总是得到原始交易金额，币种不变
                const personalAmount = reimbursementAmount;
                
                // 公司钱包：只有当币种不同时才需要汇率转换
                let companyAmount;
                let companyRateString = '1.00';
                if (transactionCurrency === companyWallet.currency) {
                    // 币种相同，直接使用原始金额
                    companyAmount = reimbursementAmount;
                } else {
                    // 币种不同，需要汇率转换
                    companyAmount = await convertCurrency(reimbursementAmount, transactionCurrency, companyWallet.currency, transaction.transaction_date);
                    companyRateString = await getExchangeRateString(transactionCurrency, companyWallet.currency, transaction.transaction_date);
                }

                // 创建报销流水
                const entries = [];

                // 获取汇率字符串用于描述
                const personalRateString = '1.00';
                
                // 计算正确的汇率显示（公司钱包描述中应该显示从公司币种到个人币种的汇率）
                let companyRateStringForDescription = '1.00';
                if (transactionCurrency !== companyWallet.currency) {
                    // 需要显示从公司币种到个人币种的汇率
                    const reverseRate = await getExchangeRateString(companyWallet.currency, transactionCurrency, transaction.transaction_date);
                    companyRateStringForDescription = reverseRate;
                }

                // 个人钱包入账
                const personalEntry = {
                    wallet_id: personalWallet.id,
                    entry_type: 'reimbursement',
                    amount: personalAmount,
                    balance_after: (parseFloat(personalWallet.balance) + personalAmount).toFixed(2),
                    currency: personalWallet.currency,
                    reference_id: transactionId,
                    reference_type: 'transaction',
                    description: `Reimbursement from ${companyWallet.name} (${personalWallet.currency} ${personalAmount.toFixed(2)} @ 1.00)`,
                    created_at: new Date().toISOString(),
                    created_by: currentUser.id,
                    created_by_name: currentUser.name,
                    reimbursement_pair_id: reimbursementPairId
                };
                entries.push(personalEntry);

                // 公司钱包出账
                const companyEntry = {
                    wallet_id: companyWallet.id,
                    entry_type: 'reimbursement',
                    amount: -companyAmount,
                    balance_after: (parseFloat(companyWallet.balance) - companyAmount).toFixed(2),
                    currency: companyWallet.currency,
                    reference_id: transactionId,
                    reference_type: 'transaction',
                    description: `Reimbursement to ${personalWallet.name} (${companyWallet.currency} ${companyAmount.toFixed(2)} @ ${companyRateStringForDescription})`,
                    created_at: new Date().toISOString(),
                    created_by: currentUser.id,
                    created_by_name: currentUser.name,
                    reimbursement_pair_id: reimbursementPairId
                };
                entries.push(companyEntry);

                // 批量插入流水
                const { error: entriesError } = await supabase
                    .from('wallet_entries')
                    .insert(entries);
                
                if (entriesError) throw entriesError;

                // 更新钱包余额
                const { error: personalWalletError } = await supabase
                    .from('wallets')
                    .update({ 
                        balance: personalEntry.balance_after,
                        last_editor_name: currentUser.name,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', personalWallet.id);
                
                if (personalWalletError) throw personalWalletError;

                const { error: companyWalletError } = await supabase
                    .from('wallets')
                    .update({ 
                        balance: companyEntry.balance_after,
                        last_editor_name: currentUser.name,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', companyWallet.id);
                
                if (companyWalletError) throw companyWalletError;

                // 更新交易状态
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .update({ 
                        reimbursement_status: 'reimbursed',
                        reimburser_id: currentUser.id,
                        reimburser_name: currentUser.name,
                        reimbursement_date: new Date().toISOString()
                    })
                    .eq('id', transactionId);
                
                if (transactionError) throw transactionError;
                
            } catch (error) {
                console.error('Error processing reimbursement:', error);
                throw error;
            }
        }

        // 获取钱包信息
        async function getWalletById(walletId) {
            try {
                const { data, error } = await supabase
                    .from('wallets')
                    .select('id, name, balance, currency')
                    .eq('id', walletId)
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error getting wallet:', error);
                return null;
            }
        }

        // 货币转换（使用实时汇率）
        async function convertCurrency(amount, fromCurrency, toCurrency, transactionDate = null) {
            if (fromCurrency === toCurrency) return amount;
            
            try {
                // 使用现有的汇率获取函数
                const rate = await getExchangeRateForReimbursement(fromCurrency, toCurrency, transactionDate);
                return parseFloat((amount * rate).toFixed(2));
            } catch (error) {
                console.error('Error getting exchange rate:', error);
                // 回退到硬编码汇率
                const fallbackRates = {
                    'SGD': { 'CNY': 5.3, 'USD': 0.74, 'MYR': 3.4 },
                    'CNY': { 'SGD': 0.19, 'USD': 0.14, 'MYR': 0.64 },
                    'USD': { 'SGD': 1.35, 'CNY': 7.2, 'MYR': 4.6 },
                    'MYR': { 'SGD': 0.29, 'CNY': 1.56, 'USD': 0.22 }
                };
                const rate = fallbackRates[fromCurrency]?.[toCurrency] || 1;
                return parseFloat((amount * rate).toFixed(2));
            }
        }

        // 获取汇率（用于报销，基于交易日期）
        async function getExchangeRateForReimbursement(fromCurrency, toCurrency, transactionDate = null) {
            if (fromCurrency === toCurrency) return 1;
            
            try {
                // 使用与 settings.html 相同的汇率逻辑
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                // 确定汇率获取日期
                let targetDate;
                if (transactionDate) {
                    const transDate = new Date(transactionDate);
                    const transYear = transDate.getFullYear();
                    const transMonth = transDate.getMonth() + 1;
                    
                    if (transYear === currentYear && transMonth === currentMonth) {
                        // 情况A: 交易是当月，使用今天的最新汇率
                        targetDate = new Date();
                    } else if (transYear < currentYear || (transYear === currentYear && transMonth < currentMonth)) {
                        // 情况B: 交易是过去月，使用该月最后一天的汇率
                        targetDate = new Date(transYear, transMonth, 0); // 获取该月最后一天
                    } else {
                        // 情况C: 交易是未来月，使用本月最新汇率
                        targetDate = new Date();
                    }
                } else {
                    targetDate = new Date();
                }

                const targetDateStr = targetDate.getFullYear() + '-' + 
                    String(targetDate.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(targetDate.getDate()).padStart(2, '0');

                console.log(`Getting exchange rate for ${fromCurrency} to ${toCurrency} on ${targetDateStr}`);

                // 1. 检查数据库中是否有目标日期的汇率
                const { data: dateRates, error: dateError } = await supabase
                    .from('exchange_rates')
                    .select('rate')
                    .eq('base_currency', fromCurrency)
                    .eq('target_currency', toCurrency)
                    .eq('local_date', targetDateStr)
                    .limit(1);

                if (dateRates && dateRates.length > 0) {
                    console.log('Found exact date rates in database');
                    return dateRates[0].rate;
                }

                // 2. 如果目标日期是今天，先检查数据库中是否已有今天的数据
                const today = new Date();
                const targetDateOnly = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                if (targetDateOnly.getTime() === todayOnly.getTime()) {
                    console.log('Target date is today, checking database first...');
                    
                    // 先检查数据库中是否已有今天的数据
                    const todayDateStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
                    
                    const { data: todayRates, error: todayError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .eq('local_date', todayDateStr)
                        .limit(1);

                    if (todayRates && todayRates.length > 0) {
                        console.log('Found today\'s rate in database, using it');
                        return todayRates[0].rate;
                    }

                    // 如果数据库中没有今天的数据，才调用API
                    console.log('No today\'s rate in database, calling API...');
                    const { data, error } = await supabase.functions.invoke('exchange-rate', {
                        body: { baseCurrency: fromCurrency }
                    });

                    if (error) {
                        console.error('Edge function error:', error);
                        throw error;
                    }

                    if (!data || !data.conversionRates) {
                        throw new Error('Invalid API response');
                    }

                    console.log('API response received, saving to database...');
                    // 保存汇率到数据库
                    const ratesToInsert = Object.keys(data.conversionRates).map(currency => ({
                        base_currency: fromCurrency,
                        target_currency: currency,
                        rate: data.conversionRates[currency]
                    }));

                    const { error: saveError } = await supabase
                        .from('exchange_rates')
                        .insert(ratesToInsert);

                    if (saveError) {
                        console.warn('Failed to save rates to database:', saveError);
                        // 如果是重复数据错误，忽略它
                        if (saveError.code === '23505') {
                            console.log('Rate already exists, continuing...');
                        }
                    }

                    return data.conversionRates[toCurrency] || 1;
                }

                // 3. 如果目标日期是过去某天且无数据，查找最近的历史汇率
                if (targetDateOnly < todayOnly) {
                    console.log('Target date is in the past, getting nearest historical rate...');
                    
                    // 先查找该月之前的最后一天
                    const { data: beforeRates, error: beforeError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .lt('local_date', targetDateStr)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (beforeRates && beforeRates.length > 0) {
                        return beforeRates[0].rate;
                    }

                    // 如果之前没有，查找该月之后的第一天
                    const { data: afterRates, error: afterError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .gt('created_at', targetDateStr + 'T23:59:59')
                        .order('created_at', { ascending: true })
                        .limit(1);

                    if (afterRates && afterRates.length > 0) {
                        return afterRates[0].rate;
                    }
                }

                // 4. 如果目标日期是未来某天，按今日处理
                if (targetDateOnly > todayOnly) {
                    console.log('Target date is in the future, treating as today...');
                    
                    // 先检查数据库中是否有今天的汇率
                    const todayDateStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
                    
                    const { data: todayRates, error: todayError } = await supabase
                        .from('exchange_rates')
                        .select('rate')
                        .eq('base_currency', fromCurrency)
                        .eq('target_currency', toCurrency)
                        .eq('local_date', todayDateStr)
                        .limit(1);

                    if (todayRates && todayRates.length > 0) {
                        console.log('Found today\'s rate in database, using it for future date');
                        return todayRates[0].rate;
                    } else {
                        // 今天没有数据，调用API
                        console.log('No today\'s rate in database, calling API...');
                        const { data, error } = await supabase.functions.invoke('exchange-rate', {
                            body: { baseCurrency: fromCurrency }
                        });

                        if (error) {
                            console.error('Edge function error:', error);
                            throw error;
                        }

                        if (!data || !data.conversionRates) {
                            throw new Error('Invalid API response');
                        }

                        console.log('API response received, saving to database...');
                        const ratesToInsert = Object.keys(data.conversionRates).map(currency => ({
                            base_currency: fromCurrency,
                            target_currency: currency,
                            rate: data.conversionRates[currency]
                        }));

                        const { error: saveError } = await supabase
                            .from('exchange_rates')
                            .insert(ratesToInsert);

                        if (saveError) {
                            console.warn('Failed to save rates to database:', saveError);
                            // 如果是重复数据错误，忽略它
                            if (saveError.code === '23505') {
                                console.log('Rate already exists, continuing...');
                            }
                        }

                        return data.conversionRates[toCurrency] || 1;
                    }
                }

                // 5. 如果所有方法都失败，回退到硬编码汇率
                console.log('All methods failed, using hardcoded rates...');
                const rates = {
                    'SGD': { 'CNY': 5.30000, 'USD': 0.74000, 'MYR': 3.45000 },
                    'CNY': { 'SGD': 0.18868, 'USD': 0.13962, 'MYR': 0.65094 },
                    'USD': { 'SGD': 1.35135, 'CNY': 7.16216, 'MYR': 4.66216 },
                    'MYR': { 'SGD': 0.28986, 'CNY': 1.53623, 'USD': 0.21449 }
                };
                return rates[fromCurrency]?.[toCurrency] || 1;

            } catch (err) {
                console.error('Error in exchange rate function:', err);
                console.log('Falling back to hardcoded rates...');

                // 回退到硬编码汇率
                const rates = {
                    'SGD': { 'CNY': 5.30000, 'USD': 0.74000, 'MYR': 3.45000 },
                    'CNY': { 'SGD': 0.18868, 'USD': 0.13962, 'MYR': 0.65094 },
                    'USD': { 'SGD': 1.35135, 'CNY': 7.16216, 'MYR': 4.66216 },
                    'MYR': { 'SGD': 0.28986, 'CNY': 1.53623, 'USD': 0.21449 }
                };
                return rates[fromCurrency]?.[toCurrency] || 1;
            }
        }

        // 获取汇率字符串（用于描述）
        async function getExchangeRateString(fromCurrency, toCurrency, transactionDate = null) {
            if (fromCurrency === toCurrency) return '1.00';
            
            try {
                const rate = await getExchangeRateForReimbursement(fromCurrency, toCurrency, transactionDate);
                return rate.toFixed(2);
            } catch (error) {
                console.error('Error getting exchange rate string:', error);
                // 回退到硬编码汇率
                const fallbackRates = {
                    'SGD': { 'CNY': '5.30', 'USD': '0.74', 'MYR': '3.40' },
                    'CNY': { 'SGD': '0.19', 'USD': '0.14', 'MYR': '0.64' },
                    'USD': { 'SGD': '1.35', 'CNY': '7.20', 'MYR': '4.60' },
                    'MYR': { 'SGD': '0.29', 'CNY': '1.56', 'USD': '0.22' }
                };
                return fallbackRates[fromCurrency]?.[toCurrency] || '1.00';
            }
        }

        // 取消报销
        async function cancelReimbursement(id) {
            console.log('🚨 cancelReimbursement called for transaction:', id);
            console.log('🚨 Current window.cancellingReimbursement:', window.cancellingReimbursement);
            
            // 防止重复点击 - 立即设置标志
            if (window.cancellingReimbursement) {
                console.log('❌ Cancellation already in progress, ignoring duplicate request');
                return;
            }
            window.cancellingReimbursement = true;
            console.log('✅ Set window.cancellingReimbursement = true');
            
            try {
                
                // 检查是否已经有活跃的报销
                const hasActiveReimbursement = await checkActiveReimbursement(id);
                if (!hasActiveReimbursement) {
                    await showCustomAlert('Error', 'No active reimbursement found for this transaction.');
                    return;
                }

                // 获取原始报销流水
                const originalEntries = await getReimbursementEntries(id);
                if (!originalEntries || originalEntries.length === 0) {
                    await showCustomAlert('Error', 'No reimbursement found for this transaction.');
                    return;
                }

                // 检查是否已经有撤销记录（防止重复取消）
                const originalPairId = originalEntries[0].reimbursement_pair_id;
                const { data: existingReversals, error: reversalCheckError } = await supabase
                    .from('wallet_entries')
                    .select('id')
                    .eq('reference_id', id)
                    .eq('entry_type', 'reimbursement')
                    .eq('reimbursement_reversal_of', originalPairId)
                    .limit(1);
                
                if (reversalCheckError) throw reversalCheckError;
                
                if (existingReversals && existingReversals.length > 0) {
                    await showCustomAlert('Error', 'This reimbursement has already been cancelled.');
                    return;
                }

                // 确认取消报销
            const confirmed = await showCustomConfirm(
                'Cancel Reimbursement',
                    'Are you sure you want to cancel the reimbursement for this transaction? This will reverse the wallet entries.',
                'Cancel Reimbursement',
                'Keep',
                'warning'
            );
            
            if (!confirmed) return;
            
                // 执行取消报销
                await processReimbursementCancellation(id, originalEntries);
                
                // 重新加载数据
                currentPage = 0;
                hasMoreData = true;
                transactions = [];
                await loadTransactions();
            } catch (error) {
                console.error('Error canceling reimbursement:', error);
                await showCustomAlert('Error', 'Failed to cancel reimbursement. Please try again.');
            } finally {
                window.cancellingReimbursement = false;
            }
        }

        // 获取报销流水
        async function getReimbursementEntries(transactionId) {
            try {
                const { data, error } = await supabase
                    .from('wallet_entries')
                    .select('*')
                    .eq('reference_id', transactionId)
                    .eq('entry_type', 'reimbursement')
                    .is('reimbursement_reversal_of', null) // 只获取原始报销，不包括已撤销的
                    .order('created_at', { ascending: false }); // 按时间倒序，最新的在前
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error getting reimbursement entries:', error);
                return [];
            }
        }

        // 处理取消报销
        async function processReimbursementCancellation(transactionId, originalEntries) {
            console.log('🚨 processReimbursementCancellation called for transaction:', transactionId);
            console.log('🚨 Original entries count:', originalEntries.length);
            
            try {
                // 获取当前用户信息
                const currentUser = await getCurrentUserInfo();
                
                // 只处理最新的原始报销记录（按时间倒序，取最新的）
                const latestEntries = originalEntries.slice(0, 2); // 只取前2条（个人钱包 + 公司钱包）
                console.log('🚨 Processing only latest entries:', latestEntries.length);
                
                // 生成新的配对ID用于撤销
                const reversalPairId = crypto.randomUUID();
                
                // 获取原始配对ID
                const originalPairId = latestEntries[0]?.reimbursement_pair_id;
                if (!originalPairId) {
                    throw new Error('Original reimbursement pair ID not found');
                }

                // 创建撤销流水
                const reversalEntries = [];

                for (const originalEntry of latestEntries) {
                    // 获取当前钱包余额
                    const { data: wallet, error: walletError } = await supabase
                        .from('wallets')
                        .select('balance')
                        .eq('id', originalEntry.wallet_id)
                        .single();
                    
                    if (walletError) throw walletError;

                    // 计算撤销金额（取反）
                    const reversalAmount = -originalEntry.amount;
                    const newBalance = (parseFloat(wallet.balance) + reversalAmount).toFixed(2);

                    // 创建撤销流水
                    const reversalEntry = {
                        wallet_id: originalEntry.wallet_id,
                        entry_type: 'reimbursement',
                        amount: reversalAmount,
                        balance_after: newBalance,
                        currency: originalEntry.currency,
                        reference_id: transactionId,
                        reference_type: 'transaction',
                        description: `Reimbursement cancellation: ${originalEntry.description}`,
                        created_at: new Date().toISOString(),
                        created_by: currentUser.id,
                        created_by_name: currentUser.name,
                        reimbursement_pair_id: reversalPairId,
                        reimbursement_reversal_of: originalPairId
                    };
                    reversalEntries.push(reversalEntry);
                }

                // 批量插入撤销流水
                const { error: entriesError } = await supabase
                    .from('wallet_entries')
                    .insert(reversalEntries);
                
                if (entriesError) throw entriesError;

                // 更新钱包余额
                for (const entry of reversalEntries) {
                    const { error: walletError } = await supabase
                        .from('wallets')
                        .update({ 
                            balance: entry.balance_after,
                            last_editor_name: currentUser.name,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', entry.wallet_id);
                    
                    if (walletError) throw walletError;
                }

                // 更新交易状态
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .update({ 
                        reimbursement_status: 'pending',
                        reimbursement_canceler_id: currentUser.id,
                        reimbursement_canceler_name: currentUser.name,
                        reimbursement_canceler_date: new Date().toISOString()
                    })
                    .eq('id', transactionId);
                
                if (transactionError) throw transactionError;
                
            } catch (error) {
                console.error('Error processing reimbursement cancellation:', error);
                throw error;
            }
        }

        // 显示交易操作弹窗
        async function showTransactionActions(transactionId) {
            // 找到对应的交易数据
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                console.error('Transaction not found:', transactionId);
                return;
            }

            // 更新弹窗中的交易信息
            const transactionInfo = document.getElementById('transaction-info');
            let amount = 0;
            
            // 根据当前选择的币种获取对应的金额
            switch (globalFilters.currency) {
                case 'SGD':
                    amount = parseFloat(transaction.sgd_amount || 0);
                    break;
                case 'CNY':
                    amount = parseFloat(transaction.cny_amount || 0);
                    break;
                case 'USD':
                    amount = parseFloat(transaction.usd_amount || 0);
                    break;
                case 'MYR':
                    amount = parseFloat(transaction.myr_amount || 0);
                    break;
                default:
                    amount = parseFloat(transaction.sgd_amount || 0);
                    break;
            }

            const isIncome = transaction.type === 'income';
            const statusText = formatStatusText(transaction.reimbursement_status?.code);

            transactionInfo.innerHTML = `
                <div style="font-weight: 600; font-size: 18px; color: #333; margin-bottom: 12px;">
                    ${transaction.categories?.name || 'Unknown'}
                </div>
                ${transaction.allowed_users?.display_name || transaction.allowed_users?.email ? `
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        ${transaction.allowed_users.display_name || transaction.allowed_users.email}
                    </div>
                ` : ''}
                <div style="font-size: 16px; color: #333; margin-bottom: 12px; font-weight: 500;">
                    ${isIncome ? '+' : ''}${formatCurrency(amount, globalFilters.currency)}
                </div>
                ${transaction.notes ? `
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px; font-style: italic;">
                        ${transaction.notes}
                    </div>
                ` : ''}
                <div style="font-size: 12px; color: #999; text-transform: uppercase; letter-spacing: 0.5px;">
                    Status: ${statusText}
                </div>
            `;

            // 显示/隐藏报销相关按钮
            const reimburseBtn = document.getElementById('action-reimburse');
            const cancelReimburseBtn = document.getElementById('action-cancel-reimburse');
            
            // 检查是否有活跃的报销
            const hasActiveReimbursement = await checkActiveReimbursement(transactionId);
            
            if (hasActiveReimbursement) {
                // 已报销，显示取消报销按钮，禁用编辑按钮
                reimburseBtn.style.display = 'none';
                cancelReimburseBtn.style.display = 'flex';
            } else if (transaction.reimbursement_status?.code === 'pending' || transaction.reimbursement_status?.code === 'not_needed') {
                // 待报销或不需要报销，显示报销按钮，启用编辑按钮
                reimburseBtn.style.display = 'flex';
                cancelReimburseBtn.style.display = 'none';
            } else {
                // 其他状态，隐藏报销按钮，启用编辑按钮
                reimburseBtn.style.display = 'none';
                cancelReimburseBtn.style.display = 'none';
            }

            // 控制编辑按钮的可用性
            const editBtn = document.getElementById('action-edit');
            // 编辑按钮始终保持正常外观，允许点击
            editBtn.disabled = false;
            editBtn.style.opacity = '1';
            editBtn.style.cursor = 'pointer';
            editBtn.title = 'Edit transaction';

            // 显示弹窗
            const modal = document.getElementById('transaction-actions-modal');
            modal.classList.add('show');

            // 添加事件监听器
            const viewBtn = document.getElementById('action-view');
            const deleteBtn = document.getElementById('action-delete');

            const handleView = () => {
                modal.classList.remove('show');
                cleanup();
                viewTransaction(transactionId);
            };

            const handleEdit = async () => {
                // 检查交易是否已经报销
                const hasActiveReimbursement = await checkActiveReimbursement(transactionId);
                if (hasActiveReimbursement) {
                    // 已报销，显示友好提示
                    await showCustomAlert(
                        'Cannot Edit Transaction', 
                        'This transaction has been reimbursed. Please cancel the reimbursement first before editing the transaction.',
                        'OK',
                        'warning'
                    );
                    return;
                }
                
                // 如果未报销，允许编辑
                modal.classList.remove('show');
                cleanup();
                editTransaction(transactionId);
            };

            const handleReimburse = () => {
                modal.classList.remove('show');
                cleanup();
                reimburseTransaction(transactionId);
            };

            const handleCancelReimburse = () => {
                modal.classList.remove('show');
                cleanup();
                cancelReimbursement(transactionId);
            };

            const handleDelete = () => {
                modal.classList.remove('show');
                cleanup();
                deleteTransaction(transactionId);
            };

            const handleOutsideClick = (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    cleanup();
                }
            };

            const cleanup = () => {
                viewBtn.removeEventListener('click', handleView);
                editBtn.removeEventListener('click', handleEdit);
                reimburseBtn.removeEventListener('click', handleReimburse);
                cancelReimburseBtn.removeEventListener('click', handleCancelReimburse);
                deleteBtn.removeEventListener('click', handleDelete);
                modal.removeEventListener('click', handleOutsideClick);
            };

            viewBtn.addEventListener('click', handleView);
            editBtn.addEventListener('click', handleEdit);
            reimburseBtn.addEventListener('click', handleReimburse);
            cancelReimburseBtn.addEventListener('click', handleCancelReimburse);
            deleteBtn.addEventListener('click', handleDelete);
            modal.addEventListener('click', handleOutsideClick);
        }

        // 挂载函数到全局作用域
        window.viewTransaction = viewTransaction;
        window.editTransaction = editTransaction;
        window.deleteTransaction = deleteTransaction;
        window.reimburseTransaction = reimburseTransaction;
        window.cancelReimbursement = cancelReimbursement;
        window.showTransactionActions = showTransactionActions;

        // 重新加载数据（当筛选器改变时）
        async function reloadData() {
            currentPage = 0;
            hasMoreData = true;
            transactions = [];
            await loadTransactions();
        }

        // 重置预算进度条状态（清除缓存）
        function resetBudgetProgressBar() {
            const progressFill = document.getElementById('budget-progress-fill');
            if (progressFill) {
                progressFill.style.width = '0%';
                progressFill.className = 'budget-progress-fill';
            }
        }

        // 检查并显示预算进度
        async function checkAndDisplayBudgetProgress(totalExpense, budgetAmount = 0, hasBudget = false) {
            try {
                // 检查当前日期范围是否是一个整月
                const dateRange = globalFilters.dateRange;
                console.log('Budget Debug - Date Range:', dateRange);
                
                if (!dateRange || dateRange.mode !== 'month') {
                    console.log('Budget Debug - Not a full month, hiding progress');
                    const container = document.getElementById('budget-progress-container');
                    if (container) {
                        container.style.display = 'none';
                        resetBudgetProgressBar();
                    }
                    return;
                }

                // 获取当前选择的账本
                const selectedLedgerId = globalFilters.ledger;
                console.log('Budget Debug - Selected Ledger ID:', selectedLedgerId);
                
                if (!selectedLedgerId || selectedLedgerId === 'all') {
                    console.log('Budget Debug - No specific ledger selected, hiding progress');
                    const container = document.getElementById('budget-progress-container');
                    if (container) {
                        container.style.display = 'none';
                        resetBudgetProgressBar();
                    }
                    return;
                }
                
                // 检查是否选择了所有付款人
                if (globalFilters.payer !== 'all') {
                    console.log('Budget Debug - Specific payer selected, hiding progress');
                    const container = document.getElementById('budget-progress-container');
                    if (container) {
                        container.style.display = 'none';
                        resetBudgetProgressBar();
                    }
                    return;
                }
                
                // 检查是否选择了所有状态
                if (globalFilters.status !== 'all') {
                    console.log('Budget Debug - Specific status selected, hiding progress');
                    const container = document.getElementById('budget-progress-container');
                    if (container) {
                        container.style.display = 'none';
                        resetBudgetProgressBar();
                    }
                    return;
                }
                
                // 检查是否选择了所有分类
                if (globalFilters.category !== 'all') {
                    console.log('Budget Debug - Specific category selected, hiding progress');
                    const container = document.getElementById('budget-progress-container');
                    if (container) {
                        container.style.display = 'none';
                        resetBudgetProgressBar();
                    }
                    return;
                }
                
                // 检查是否有搜索关键词
                if (globalFilters.notesSearch && globalFilters.notesSearch.trim() !== '') {
                    console.log('Budget Debug - Notes search active, hiding progress');
                    const container = document.getElementById('budget-progress-container');
                    if (container) {
                        container.style.display = 'none';
                        resetBudgetProgressBar();
                    }
                    return;
                }

                // 检查用户是否已经选择忽略预算设置（全局忽略）
                const isIgnored = sessionStorage.getItem('budget_ignored_global') === 'true';
                
                console.log('Budget Debug - Budget Check:', { 
                    budgetAmount: budgetAmount,
                    hasBudget: hasBudget,
                    filterCurrency: globalFilters.currency,
                    isIgnored: isIgnored
                });
                
                console.log('Budget Debug - Condition check:', {
                    hasBudget: hasBudget,
                    budgetAmount: budgetAmount,
                    budgetAmountType: typeof budgetAmount,
                    hasBudgetType: typeof hasBudget,
                    condition: hasBudget && budgetAmount > 0,
                    isIgnored: isIgnored
                });
                
                if (hasBudget && budgetAmount > 0) {
                    // 有预算数据，显示正常预算进度（最高优先级）
                    console.log('Budget Debug - Showing budget progress');
                    displayBudgetProgress(totalExpense, budgetAmount, globalFilters.currency);
                } else if (isIgnored) {
                    // 无预算且用户选择忽略，隐藏预算组件
                    console.log('Budget Debug - User ignored budget, hiding component');
                    hideBudgetProgress();
                } else {
                    // 无预算数据且未忽略，显示设置预算提示
                    console.log('Budget Debug - No budget data, showing setup prompt');
                    displayBudgetSetupPrompt();
                }

            } catch (error) {
                console.error('Error checking budget progress:', error);
                // 发生错误时只隐藏组件，不设置忽略状态
                const container = document.getElementById('budget-progress-container');
                if (container) {
                    container.style.display = 'none';
                    resetBudgetProgressBar();
                }
            }
        }

        // 显示预算进度
        function displayBudgetProgress(expense, budget, currency) {
            const container = document.getElementById('budget-progress-container');
            const budgetInfo = document.getElementById('budget-info');
            
            // 恢复正常的预算显示结构
            budgetInfo.innerHTML = `
                <div class="budget-usage" id="budget-usage">Budget Usage</div>
                <div class="budget-amount-container" id="budget-amount-container">
                    <span class="budget-amount" id="budget-amount">${formatCurrency(budget, currency)}</span>
                    <button class="budget-edit-btn" onclick="navigateToBudgetSettings()">
                        <img src="assets/svg/edit.svg" alt="Edit Budget" class="budget-edit-icon">
                    </button>
                </div>
            `;
            
            // 重新获取元素引用
            const budgetAmount = document.getElementById('budget-amount');
            const progressFill = document.getElementById('budget-progress-fill');
            const budgetUsage = document.getElementById('budget-usage');
            const budgetAmountContainer = document.getElementById('budget-amount-container');
            const budgetProgressBar = document.getElementById('budget-progress-bar');

            // 显示所有元素
            budgetUsage.style.display = 'block';
            budgetAmountContainer.style.display = 'block';
            budgetProgressBar.style.display = 'block';

            // 计算使用百分比
            const usagePercentage = (expense / budget) * 100;
            const displayPercentage = Math.min(usagePercentage, 100);
            const usageText = `${usagePercentage.toFixed(1)}%`;

            // 更新显示
            budgetAmount.innerHTML = formatCurrency(budget, currency);
            budgetUsage.textContent = usageText;

            // 更新进度条
            progressFill.style.width = `${displayPercentage}%`;

            // 根据使用情况设置颜色
            progressFill.className = 'budget-progress-fill';
            if (usagePercentage >= 90) {
                progressFill.classList.add('danger');
            } else if (usagePercentage >= 75) {
                progressFill.classList.add('warning');
            }

            // 显示容器
            container.style.display = 'block';
        }

        // 显示预算设置提示
        function displayBudgetSetupPrompt() {
            const container = document.getElementById('budget-progress-container');
            const budgetInfo = document.getElementById('budget-info');
            
            // 更新HTML结构为设置提示
            budgetInfo.innerHTML = `
                <div class="budget-setup-prompt">
                    <span class="budget-setup-text">Set Budget</span>
                    <div class="budget-setup-buttons">
                        <button class="budget-setup-btn" onclick="navigateToBudgetSettings()">
                            <img src="assets/svg/edit.svg" alt="Set Budget" class="budget-setup-icon">
                        </button>
                        <button class="budget-ignore-btn" onclick="hideBudgetProgress()">
                            <img src="assets/svg/close.svg" alt="Ignore" class="budget-ignore-icon">
                        </button>
                    </div>
                </div>
            `;
            
            // 重置进度条状态，确保没有缓存
            resetBudgetProgressBar();
            
            // 显示容器
            container.style.display = 'block';
        }
        
        // 导航到预算设置页面
        window.navigateToBudgetSettings = function() {
            const dateRange = globalFilters.dateRange;
            const selectedLedgerId = globalFilters.ledger;
            
            if (dateRange && dateRange.mode === 'month' && selectedLedgerId && selectedLedgerId !== 'all') {
                const monthString = `${dateRange.value.year}-${String(dateRange.value.month + 1).padStart(2, '0')}`;
                
                // 检查是否已有该账本该月的预算
                // 如果有预算，则编辑；如果没有，则添加
                supabase
                    .from('budgets')
                    .select('id')
                    .eq('ledger_id', selectedLedgerId)
                    .eq('month', monthString)
                    .single()
                    .then(({ data: existingBudget, error }) => {
                        if (existingBudget) {
                            // 已有预算，跳转到编辑页面
                            window.location.href = `settings.html#budgets&edit=true&ledger=${selectedLedgerId}&month=${monthString}`;
                        } else {
                            // 没有预算，跳转到添加页面
                            window.location.href = `settings.html#budgets&add=true&ledger=${selectedLedgerId}&month=${monthString}`;
                        }
                    })
                    .catch(() => {
                        // 查询失败，默认跳转到添加页面
                        window.location.href = `settings.html#budgets&add=true&ledger=${selectedLedgerId}&month=${monthString}`;
                    });
            } else {
                // 跳转到预算页面，显示添加新预算
                window.location.href = 'settings.html#budgets&add=true';
            }
        }

        // 隐藏预算进度
        window.hideBudgetProgress = function() {
            const container = document.getElementById('budget-progress-container');
            container.style.display = 'none';
            
            // 重置进度条状态，确保没有缓存
            resetBudgetProgressBar();
            
            // 设置全局忽略标志
            sessionStorage.setItem('budget_ignored_global', 'true');
            console.log('Budget ignored globally');
        }

        // 初始化页面
        async function init() {
            await checkAuth();
            initializeCurrencyFilter();
            loadFilters();
            await loadPayers(); // 先加载用户信息，建立userUUIDMap
            const ledgersLoaded = await loadLedgers(); // 然后加载账本，此时userUUIDMap已可用
            
            // 如果显示了友好提示，停止后续初始化
            if (ledgersLoaded === true) {
                console.log('🔍 友好提示已显示，停止后续初始化');
                return;
            }
            
            await loadStatuses();
            await loadCategories();
            applyFilters();
            await loadTransactions();
        }

        // 监听认证状态变化
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            }
        });

        init();
    </script>
</body>
</html>

